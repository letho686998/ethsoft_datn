<!DOCTYPE html>
<html lang="vi" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{admin/layout/Layout}">

<head>
    <title layout:title="Th√™m s·∫£n ph·∫©m"></title>

    <style>

        html {
            height: 100%;
            scrollbar-gutter: unset;
        }

        /* ‚úÖ Body ch·ªãu tr√°ch nhi·ªám cu·ªôn */
        body {
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Custom scrollbar ƒë·∫πp */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.35);
        }


        .page-content-section {
            height: auto; /* tr√°nh m√¢u thu·∫´n v·ªõi fixed b√™n tr√™n */
            min-height: 100%; /* ho·∫∑c b·ªè h·∫≥n thu·ªôc t√≠nh height c≈© */
        }


        .card {
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            background: #fff;
        }

        .card-header {
            background: linear-gradient(135deg, #007bff, #14F5F1);
            color: #fff;
            padding: 8px 15px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .card-header h6 {
            font-weight: 600;
            margin: 0;
            font-size: 1rem;
        }

        .form-label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .form-control,
        .dropdown-input {
            height: 36px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .dropdown-input {
            background: #fff;
            cursor: pointer;
        }

        /* üîπ H√†ng ch·ª©a √¥ input v√† n√∫t + */
        .input-with-btn {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* üîπ N√∫t d·∫•u c·ªông ‚Äì h√¨nh vu√¥ng, n·∫±m ngo√†i b√™n ph·∫£i */
        .btn-add-icon {
            width: 36px;
            height: 36px;
            border: 1.5px solid #007bff;
            background: #f0f8ff;
            color: #007bff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-add-icon:hover {
            background: #14F5F1;
            color: #fff;
            transform: scale(1.05);
        }

        /* Hai khung tr√™n c√πng chia ƒë√¥i */
        .top-row {
            display: grid;
            grid-template-columns: 1fr 1fr; /* hai c·ªôt ƒë·ªÅu nhau */
            gap: 15px;
            margin-bottom: 15px;
        }

        .top-row .card {
            flex: 1;
        }

        /* B·∫£ng chi ti·∫øt s·∫£n ph·∫©m */

        table th {
            background: #f8f9fa;
            text-align: center;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        table td {
            text-align: center;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .table {
            width: 100%;
            table-layout: auto; /* Cho ph√©p c·ªôt co gi√£n t·ª± nhi√™n */
            border-collapse: collapse;
        }

        /* 8 c·ªôt ƒë·∫ßu: c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh c·ª• th·ªÉ */
        .table th:nth-child(1) {
            width: 20px;
        }

        /* Box ch·ªçn */
        .table th:nth-child(2) {
            width: 50px;
        }

        /* STT */
        .table th:nth-child(3) {
            width: 185px;
        }

        /* T√™n s·∫£n ph·∫©m */
        .table th:nth-child(4) {
            width: 95px;
        }

        /* M√†u s·∫Øc */
        .table th:nth-child(5) {
            width: 75px;
        }

        /* K√≠ch c·ª° */
        .table th:nth-child(6) {
            width: 100px;
        }

        /* S·ªë l∆∞·ª£ng */
        .table th:nth-child(7) {
            width: 120px;
        }

        /* Gi√° */
        .table th:nth-child(8) {
            width: 95px;
        }

        /* Thao t√°c */

        /* ‚úÖ C·ªôt cu·ªëi: co gi√£n chi·∫øm ph·∫ßn c√≤n l·∫°i */
        .table th:nth-child(9),
        .table td:nth-child(9) {
            min-width: 300px; /* ƒë·∫£m b·∫£o kh√¥ng nh·ªè h∆°n */
            width: auto; /* t·ª± ƒë·ªông gi√£n ra chi·∫øm ph·∫ßn c√≤n l·∫°i */
            white-space: nowrap; /* tr√°nh v·ª° d√≤ng n·∫øu b·∫°n mu·ªën */
        }


        section[layout\:fragment="content"] {
            position: fixed !important;
            top: 70px !important; /* ƒë√∫ng chi·ªÅu cao header th·ª±c t·∫ø */
            left: 250px !important; /* ƒë√∫ng chi·ªÅu r·ªông sidebar */
            right: 0 !important; /* thay cho width calc(...) */
            bottom: 0 !important; /* thay cho height calc(...) */
            box-sizing: border-box !important; /* padding kh√¥ng l√†m tr√†n */
            overflow-y: auto !important;
            overflow-x: hidden !important;
            padding: 15px 25px !important;
            background: #f4f6f9 !important;
        }


        .save-container {
            position: absolute;
            bottom: 10px;
            right: 15px;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.25s ease;
            padding: 6px 14px;
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.25);
        }

        /* ‚≠êÔ∏è B·ªë c·ª•c d·ªçc: kho·∫£ng c√°ch gi·ªØa c√°c section = 15px, tuy·ªát ƒë·ªëi, kh√¥ng collapse */
        .section-stack {
            display: grid;
            row-gap: 16px;
            /* ch·ªâ s·ªë b·∫°n mu·ªën = ƒë√∫ng b·∫±ng gap gi·ªØa 2 card */
        }

        /* Gi·ªØ gap ngang gi·ªØa 2 card, b·ªè m·ªçi margin d·ªçc ƒë·ªÉ kh√¥ng c·ªông d·ªìn */
        .top-row {
            display: flex;
            gap: 15px;
            margin: 0 !important;
            /* xo√° margin d∆∞·ªõi */
            padding: 0 !important;
            /* b·ªè padding d∆∞·ªõi ƒë√£ th√™m tr∆∞·ªõc ƒë√≥ */
        }

        /* ƒê·∫£m b·∫£o c√°c card b√™n trong kh√¥ng c√≥ margin ‚Äúl·ª° tay‚Äù n√†o */
        .top-row > .card {
            margin: 0 !important;
        }

        /* B·∫£ng 3: KH√îNG margin-top; kho·∫£ng c√°ch do .section-stack qu·∫£n */
        .table-container {
            margin: 0 !important;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            padding: 10px 15px 50px;
            position: relative;
        }

        /* ===============================
   üîπ DROPDOWN CHUNG ‚Äì C√ÇN ƒê·ªêI ƒê·∫∏P M·∫ÆT
   =============================== */
        .dropdown-list {
            display: none;
            position: absolute;
            top: 38px;
            left: 0;
            width: 100%;
            background: #fff;
            border: 1px solid #d0d4da;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
            overflow-y: hidden;
            z-index: 3000;
            padding: 4px 0;
            /*transition: all 0.2s ease;*/
            opacity: 0;
            transform: translateY(-6px);
            transition: opacity 0.2s ease, transform 0.25s ease;
        }

        .dropdown-list.show {
            display: block !important;
            opacity: 1;
            transform: translateY(0);
            animation: fadeSlideDown 0.25s ease forwards;
        }

        /* üåø M·ª•c dropdown */
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #333;
            transition: all 0.15s ease;
        }

        /* üü¶ Bi·ªÉu t∆∞·ª£ng checkbox / tick */
        .dropdown-item i {
            font-size: 0.9rem;
            color: #888;
            min-width: 16px;
            text-align: center;
            margin-right: 8px;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        /* üü© Hi·ªáu ·ª©ng hover m∆∞·ª£t */
        .dropdown-item:hover {
            background: #f1f7ff;
            color: #007bff;
        }

        .dropdown-item:hover i {
            color: #007bff;
        }

        /* üü¢ Khi ƒë∆∞·ª£c ch·ªçn */
        .dropdown-item.selected {
            background: #e6f0ff;
            color: #001f3f;
            font-weight: 600;
        }

        .dropdown-item.selected i {
            color: #007bff;
            animation: tickPop 0.25s ease forwards;
            transform: scale(1);
            opacity: 1;
        }

        /* Khi b·ªè ch·ªçn th√¨ thu nh·ªè m∆∞·ª£t */
        .dropdown-item:not(.selected) i {
            transform: scale(0.9);
            opacity: 0.7;
        }

        /* ‚ú® D√≤ng ‚ÄúTh√™m m·ªõi‚Äù */
        .dropdown-item.add-new {
            font-style: italic;
            color: #007bff;
        }

        .dropdown-item.add-new:hover {
            background: #e8f0ff;
            color: #0056b3;
        }

        /* Gi·ªõi h·∫°n chi·ªÅu cao khi nhi·ªÅu m·ª•c */
        .dropdown-list.scrollable {
            max-height: 180px;
            overflow-y: auto;
        }

        /* Cu·ªôn thanh m·∫£nh, tinh t·∫ø */
        .dropdown-list::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-list::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.15);
            border-radius: 4px;
        }

        .dropdown-list::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 0, 0, 0.25);
        }

        @keyframes fadeSlideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Keyframes cho hi·ªáu ·ª©ng tick xu·∫•t hi·ªán */
        @keyframes tickPop {
            0% {
                transform: scale(0.4);
                opacity: 0;
            }

            60% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }


        /* üîπ Popup ch·ªçn m√†u s·∫Øc d·∫°ng grid */
        /* Popup ch·ªçn m√†u s·∫Øc d·∫°ng grid */
        .color-popup {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 10px;
            width: 100%;
            min-width: 240px;
            height: auto;
            overflow: hidden;
            /* quan tr·ªçng: ·∫©n tooltip khi ch∆∞a hover */
            z-index: 3000;
            transition: all 0.25s ease;
            animation: fadeIn 0.15s ease-in-out;
        }

        /* Khi hi·ªÉn th·ªã */
        .color-popup.show {
            display: flex;
        }

        /* Khi hover m√†u: popup m·ªü cao nh·∫π & n·ªïi l√™n */
        .color-popup.expanded {
            padding-bottom: 28px;
            /* ch·ª´a ch·ªó cho tooltip */
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
            overflow: visible;
            /* cho ph√©p tooltip hi·ªÉn th·ªã */
        }

        /* √î m√†u nh·ªè */
        .color-item {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 2px solid #fff;
            box-shadow: 0 0 0 1.5px #ccc;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        /* Hover: d√πng m√†u ch·ªß ƒë·∫°o xanh than */
        .color-item:hover {
            transform: scale(1.12);
            box-shadow: 0 0 0 2px #1E90FF;
        }

        /* Khi ƒë∆∞·ª£c ch·ªçn */
        .color-item.selected {
            box-shadow: 0 0 0 3px #1E90FF;
            transform: scale(1.1);
        }

        /* Tooltip hi·ªÉn th·ªã t√™n m√†u */
        .color-item::after {
            content: attr(title);
            position: absolute;
            bottom: -26px;
            left: 50%;
            transform: translateX(-50%);
            background: #001f3f;
            color: #fff;
            padding: 2px 8px;
            font-size: 0.75rem;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }

        /* Hi·ªán tooltip khi hover */
        .color-item:hover::after {
            opacity: 1;
        }


        /* Hi·ªáu ·ª©ng fade popup */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        #mauSacPopup {
            top: calc(100% + 6px);
            /* c√°ch input m·ªôt ƒëo·∫°n nh·ªè */
        }

        /* üîπ Popup ch·ªçn k√≠ch c·ª° d·∫°ng grid */
        .size-popup {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 10px;
            width: 100%;
            min-width: 240px;
            height: auto;
            overflow: hidden;
            z-index: 3000;
            transition: all 0.25s ease;
            animation: fadeIn 0.15s ease-in-out;
        }

        /* Khi hi·ªÉn th·ªã */
        .size-popup.show {
            display: flex;
        }

        /* Khi hover: m·ªü cao h∆°n nh·∫π */
        .size-popup.expanded {
            padding-bottom: 12px;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
            overflow: visible;
        }

        /* √î k√≠ch c·ª° vu√¥ng */
        .size-item {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 1.5px solid #ccc;
            background: #f9fafc;
            color: #001f3f;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* Hover */
        .size-item:hover {
            transform: scale(1.12);
            background: #e9f1ff;
            border-color: #001f3f;
        }

        /* Khi ch·ªçn */
        .size-item.selected {
            background: #001f3f;
            color: #fff;
            transform: scale(1.08);
            border-color: #001f3f;
        }

        /* üîπ N·ªÅn m·ªù popup */
        .quick-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(3px);
            z-index: 1055;
            justify-content: center;
            align-items: center;
        }

        /* Khi m·ªü popup */
        .quick-modal.show {
            display: flex;
        }

        /* N·ªôi dung popup */
        .quick-modal-content {
            background: #fff;
            border-radius: 14px;
            width: min(600px, 90vw);
            aspect-ratio: 1.618 / 1;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            padding: 20px 24px 65px;
            position: relative;
            animation: zoomIn 0.25s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.85);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .quick-modal-content .modal-title {
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
            color: #001f3f;
            font-size: 1.05rem;
        }

        .quick-modal-content .modal-footer {
            position: absolute;
            bottom: 15px;
            right: 20px;
        }

        /* üîΩ Dropdown tr·∫°ng th√°i trong popup */
        /* üîΩ Dropdown tr·∫°ng th√°i trong popup th√™m nhanh */
        #attrStatusList {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            /*z-index: 9999;*/
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity 0.18s ease, transform 0.18s ease;
            overflow: visible !important;
            z-index: 99999 !important;
        }

        #attrStatusList.show {
            display: block !important; /* ‚úÖ c·∫ßn ƒë·ªÉ ghi ƒë√® display:none */
            opacity: 1 !important;;
            transform: translateY(0) !important;;
            /*display: block !important;*/
            /*opacity: 1 !important;*/
            /*transform: translateY(0) !important;*/
        }

        /* ‚úÖ FIX dropdown tr·∫°ng th√°i kh√¥ng hi·ªÉn th·ªã trong popup */
        #quickAddModal .dropdown {
            overflow: visible !important; /* Cho ph√©p list tr√†n ra ngo√†i khung */
            position: relative !important; /* Gi√∫p list ƒë·ªãnh v·ªã ch√≠nh x√°c */
        }

        #quickAddModal #attrStatusList {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            z-index: 99999 !important; /* lu√¥n n·ªïi tr√™n m·ªçi th·ª© */
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        #quickAddModal #attrStatusList.show {
            display: block !important;
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* ===================== üîπ UPLOAD CONTAINER STYLE (Shopee-like) ===================== */
        .upload-container {
            position: relative;
            border: 2px dashed #c7d3e3;
            border-radius: 10px;
            padding: 10px;
            background: #fafbfd;
            cursor: pointer;
            transition: all 0.25s ease;
            width: 355px; /* ‚úÖ v·ª´a cho 4 ·∫£nh */
            height: 100px; /* ‚úÖ c·ªë ƒë·ªãnh chi·ªÅu cao */
            display: flex;
            align-items: center; /* ‚úÖ cƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
            justify-content: flex-start; /* ‚úÖ ·∫£nh canh tr√°i trong khung */
            overflow-x: auto; /* ‚úÖ cu·ªôn ngang khi nhi·ªÅu ·∫£nh */
            overflow-y: hidden;
            flex-wrap: nowrap;
            gap: 10px;
            margin: 0 auto; /* ‚úÖ cƒÉn gi·ªØa khung trong c·ªôt */
            scroll-behavior: smooth;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch; /* iOS h·ªó tr·ª£ tr∆∞·ª£t m∆∞·ª£t */
        }

        .upload-container:hover {
            border-color: #007bff;
            background: #f1f7ff;
        }

        .upload-container input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-container::-webkit-scrollbar {
            height: 6px; /* ‚úÖ thanh k√©o ngang m·∫£nh */
        }

        .upload-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .upload-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        /* Placeholder khi ch∆∞a ch·ªçn ·∫£nh */
        .upload-placeholder {
            flex: 0 0 auto;
            width: 80px;
            height: 80px;
            min-width: 90px;
            border: 2px dashed #c7d3e3;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #7b8ca8;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            margin-left: -8px; /* ‚úÖ ƒë·∫£m b·∫£o s√°t tr√°i */
            order: 2;
        }

        .upload-placeholder i {
            font-size: 1.5rem;
            color: #007bff;
            margin-bottom: 4px;
        }

        .upload-placeholder:hover {
            border-color: #007bff;
            background: #eef6ff;
            color: #0056b3;
        }

        /* Preview ·∫£nh */
        .preview-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            overflow: visible;
            flex-shrink: 0;
            align-items: center; /* ‚úÖ cƒÉn gi·ªØa ·∫£nh trong khung */
            order: 1;
        }

        .preview-item {
            flex: 0 0 auto;
            width: 90px;
            height: 90px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #ddd;
            position: relative;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        /* N√∫t x√≥a ·∫£nh */
        .btn-remove-image {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .btn-remove-image:hover {
            background: rgba(255, 0, 0, 0.8);
        }

        /* ‚úÖ Khung ch√≠nh gi·ªØa trang */
        .page-wrapper {
            max-width: 1150px; /* ho·∫∑c b·∫•t k·ª≥ k√≠ch th∆∞·ªõc b·∫°n mu·ªën */
            margin: 0 auto;
            padding: 0 8px;
            box-sizing: border-box;
        }


        /* N·∫øu mu·ªën c√≥ kho·∫£ng c√°ch ƒë·ªÅu hai b√™n h∆°n (hi·ªáu ·ª©ng n·ªÅn l·ªô ra r√µ h∆°n) */
        @media (min-width: 1200px) {
            .page-wrapper {
                max-width: 1250px; /* ho·∫∑c t√πy b·∫°n ch·ªçn */
            }
        }

        /* üåà Modern color picker box */
        .color-picker-box input[type="color"] {
            appearance: none;
            -webkit-appearance: none;
            border: none;
            cursor: pointer;
            width: 60px;
            height: 60px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .color-picker-box input[type="color"]:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        }

        #quickAddForm {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            align-items: flex-start;
        }

        #quickAddForm > div {
            flex: 1;
        }

        #colorPickerSection {
            max-width: 220px;
        }

        #colorInfoSection {
            flex-grow: 1;
        }

        #colorInfoSection .form-label {
            font-size: 0.9rem;
        }

        #customColorPickerContainer {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        #selectedColorBox {
            width: 38px;
            height: 38px;
            border-radius: 6px;
            border: 2px solid #ccc;
            cursor: pointer;
            transition: transform 0.15s, border-color 0.15s;
        }

        #selectedColorBox:hover {
            transform: scale(1.1);
            border-color: #007bff;
        }

        #colorHexDisplay {
            width: 100px;
            font-size: 0.9rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 8px;
            font-family: monospace;
        }

        .color-palette {
            position: absolute;
            bottom: -160px; /* ƒê∆∞a xu·ªëng d∆∞·ªõi khung ch·ªçn */
            left: 0;
            background: #fff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 250px;
            z-index: 50;
            display: none;
            animation: fadeIn 0.15s ease-in-out;
        }

        .color-palette-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }

        .color-item {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: transform 0.1s;
        }

        .color-item:hover {
            transform: scale(1.2);
            border-color: #000;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-3px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .cursor-pointer {
            cursor: pointer;
        }

        /* ============================================================
   ‚úÖ HI·ªÜU ·ª®NG √î TICK GI·ªêNG DROPDOWN (CHO B·∫¢NG CHI TI·∫æT)
   ============================================================ */
        .table .row-select,
        #selectAllRows {
            font-size: 1rem;
            color: #888;
            cursor: pointer;
            transition: transform 0.15s ease, color 0.15s ease;
        }

        .table .row-select:hover,
        #selectAllRows:hover {
            color: #001f3f;
            transform: scale(1.15);
        }

        /* üü© Khi ƒë∆∞·ª£c ch·ªçn */
        .table .row-select.fa-check-square,
        #selectAllRows.fa-check-square {
            color: #007bff !important;
            animation: tickPop 0.25s ease;
        }

        /* üîπ Hi·ªáu ·ª©ng b·∫≠t tick gi·ªëng dropdown */
        @keyframes tickPop {
            0% {
                transform: scale(0.4);
                opacity: 0.4;
            }
            60% {
                transform: scale(1.25);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.1rem rgba(220, 53, 69, 0.25);
        }

        .error-message {
            display: block;
            margin-top: 3px;
            font-size: 0.8rem;
        }

        .btn-group-right {
            display: flex;
            justify-content: flex-end; /* n·∫±m b√™n ph·∫£i */
            gap: 12px; /* kho·∫£ng c√°ch gi·ªØa 2 n√∫t */
            margin-bottom: 12px;
            margin-right: 12px;
        }

        .gradient-flame-btn-crt,
        .gradient-flame-btn-cls {
            background-color: initial;
            border-radius: 8px;
            font-weight: 600;
            color: #2f3542;
            cursor: pointer;
            display: inline-block;
            outline: 0;
            overflow: hidden;
            padding: 6px 14px;
            pointer-events: auto;
            position: relative;
            text-align: center;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            vertical-align: top;
            white-space: nowrap;
            width: 100px;
            gap: 20px;
            z-index: 9;
            border: 0;
            transition: box-shadow .2s;
        }

        .gradient-flame-btn-crt {
            background-image: linear-gradient(135deg, #14F5F1, #007bff);
            box-shadow: rgba(0, 0, 0, 0.1) 0 2px 4px;
        }

        .gradient-flame-btn-cls {
            background-image: linear-gradient(135deg, #D4FF00, #FFFF00);
            box-shadow: #535714 0 2px 4px;
        }

        .gradient-flame-btn-crt:hover,
        .gradient-flame-btn-cls:hover {
            box-shadow: #25aaaa 0 3px 8px;
        }

        #btnGenerateVariants:disabled {
            background: #ccc !important;
            border: none;
            cursor: not-allowed;
        }

        .preview-item {
            position: relative;
        }

        .btn-set-cover {
            position: absolute;
            top: 5px;
            right: 30px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .btn-set-cover.active {
            background: gold;
            color: white;
        }

        #tenSanPhamList {
            position: absolute;
            width: 100%;
            top: 100%; /* n·∫±m ngay d∆∞·ªõi input */
            left: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        /* Dropdown danh s√°ch s·∫£n ph·∫©m */
        #tenSanPhamList {
            position: absolute;
            width: 100%;
            top: 100%; /* n·∫±m ngay d∆∞·ªõi input */
            left: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.15s ease;
        }

        /* C√°c item trong danh s√°ch */
        #tenSanPhamList .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #tenSanPhamList .dropdown-item:hover {
            background: #f2f4f8;
        }

        /* Khi c√≥ thanh cu·ªôn ‚Äî t√πy ch·ªçn th√™m scrollbar ƒë·∫πp */
        #tenSanPhamList::-webkit-scrollbar {
            width: 6px;
        }

        #tenSanPhamList::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        #tenSanPhamList::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.35);
        }

        .fw-semibold-header {
            background: linear-gradient(135deg, #007bff, #14F5F1);
            border-radius: 8px;
            padding: 4px 10px;
            color: #fff; /* üîπ M√†u ch·ªØ tr·∫Øng */
            /*display: inline-block;*/
        }

        #moTa[readonly], #moTaInput[readonly] {
            background-color: #f9f9f9;
            cursor: not-allowed;
            color: #777;
        }

        #table-variants tr:hover {
            background-color: #f9fafc;
        }

        #table-variants tr.table-active {
            background-color: #eaf4ff;
        }

    </style>
</head>

<body>
<section layout:fragment="content" class="page-content-section">
    <div class="page-wrapper">
        <div class="section-stack">
            <div class="top-row">
                <!-- üü© B·∫¢NG 1: TH√îNG TIN CHI TI·∫æT -->
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-info-circle"></i> Th√¥ng tin chi ti·∫øt</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label">T√™n s·∫£n ph·∫©m</label>
                                <div class="input-with-btn position-relative">
                                    <input type="text" class="form-control dropdown-input" id="tenSanPhamInput"
                                           placeholder="Nh·∫≠p ho·∫∑c ch·ªçn t√™n s·∫£n ph·∫©m...">
                                    <div class="dropdown-list" id="tenSanPhamList"></div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Th∆∞∆°ng hi·ªáu</label>
                                <div class="input-with-btn position-relative">
                                    <input type="text" class="form-control dropdown-input" id="thuongHieuInput"
                                           placeholder="Ch·ªçn th∆∞∆°ng hi·ªáu" readonly>
                                    <button class="btn-add-icon" id="btn-add-thuongHieu"><i
                                            class="fas fa-plus"></i></button>
                                    <!-- üîΩ Th√™m dropdown-list t∆∞∆°ng ·ª©ng -->
                                    <div class="dropdown-list single-select" id="thuongHieuList"></div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Danh m·ª•c</label>
                                <div class="input-with-btn position-relative">
                                    <input type="text" class="form-control dropdown-input" id="danhMucInput"
                                           placeholder="Ch·ªçn danh m·ª•c" readonly>
                                    <button class="btn-add-icon" id="btn-add-danhMuc"><i
                                            class="fas fa-plus"></i></button>
                                    <!-- üîΩ Th√™m dropdown-list t∆∞∆°ng ·ª©ng -->
                                    <div class="dropdown-list single-select" id="danhMucList"></div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Ch·∫•t li·ªáu</label>
                                <div class="input-with-btn position-relative">
                                    <input type="text" class="form-control dropdown-input" id="chatLieuInput"
                                           placeholder="Ch·ªçn ch·∫•t li·ªáu" readonly>
                                    <button class="btn-add-icon" id="btn-add-chatLieu"><i
                                            class="fas fa-plus"></i></button>
                                    <!-- üîΩ Th√™m dropdown-list t∆∞∆°ng ·ª©ng -->
                                    <div class="dropdown-list single-select" id="chatLieuList"></div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">ƒê·∫ø gi√†y</label>
                                <div class="input-with-btn position-relative">
                                    <input type="text" class="form-control dropdown-input" id="deGiayInput"
                                           placeholder="Ch·ªçn ƒë·∫ø gi√†y" readonly>
                                    <button class="btn-add-icon" id="btn-add-deGiay"><i
                                            class="fas fa-plus"></i></button>
                                    <!-- üîΩ Th√™m dropdown-list t∆∞∆°ng ·ª©ng -->
                                    <div class="dropdown-list single-select" id="deGiayList"></div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Gi·ªõi t√≠nh</label>
                                <div class="input-with-btn position-relative">
                                    <input type="text" class="form-control dropdown-input" id="gioiTinhInput"
                                           placeholder="Ch·ªçn gi·ªõi t√≠nh" readonly>
                                    <div class="dropdown-list" id="gioiTinhList">
                                        <div class="dropdown-item" data-id="0"><i class="far fa-square me-2"></i> Nam
                                        </div>
                                        <div class="dropdown-item" data-id="1"><i class="far fa-square me-2"></i> N·ªØ
                                        </div>
                                        <div class="dropdown-item" data-id="2"><i class="far fa-square me-2"></i> Nam v√†
                                            N·ªØ
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="col-md-6">
                                <label class="form-label">Tr·∫°ng th√°i</label>
                                <div class="input-with-btn position-relative">
                                    <input type="text" class="form-control dropdown-input" id="trangThaiInput"
                                           placeholder="Ch·ªçn tr·∫°ng th√°i" readonly>

                                    <div class="dropdown-list" id="trangThaiList">
                                        <div class="dropdown-item" data-id="1"><i class="far fa-square me-2"></i>ƒêang
                                            b√°n
                                        </div>
                                        <div class="dropdown-item" data-id="0"><i class="far fa-square me-2"></i>Ng·ª´ng
                                            b√°n
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="col-md-12">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control" id="moTa" rows="3"
                                          placeholder="Nh·∫≠p m√¥ t·∫£ s·∫£n ph·∫©m..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- üü¶ B·∫¢NG 2: BI·∫æN TH·ªÇ -->
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-random"></i> Bi·∫øn th·ªÉ</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">M√†u s·∫Øc</label>
                                <div class="input-with-btn position-relative">
                                    <input type="text" class="form-control dropdown-input" id="mauSacInput"
                                           placeholder="Ch·ªçn m√†u s·∫Øc" readonly>
                                    <button class="btn-add-icon" id="btn-add-mauSac"><i
                                            class="fas fa-plus"></i></button>
                                    <!-- ‚úÖ Popup m√†u d·∫°ng grid -->
                                    <div class="color-popup" id="mauSacPopup"></div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">K√≠ch c·ª°</label>
                                <div class="input-with-btn position-relative">
                                    <input type="text" class="form-control dropdown-input" id="kichCoInput"
                                           placeholder="Ch·ªçn k√≠ch c·ª°" readonly>
                                    <button class="btn-add-icon" id="btn-add-kichCo"><i
                                            class="fas fa-plus"></i></button>
                                    <!-- ‚úÖ Popup k√≠ch c·ª° d·∫°ng grid -->
                                    <div class="size-popup" id="kichCoPopup"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="btn-group-right">
                        <button class="gradient-flame-btn-crt" id="btnGenerateVariants" role="button">T·∫°o
                        </button>
                        <button class="gradient-flame-btn-cls" id="btnClearVariants" role="button">X√≥a
                        </button>
                    </div>

                </div>
            </div>

            <!-- üü® B·∫¢NG 3: DANH S√ÅCH CHI TI·∫æT S·∫¢N PH·∫®M -->
            <div class="table-container">
                <h6 class="fw-semibold-header mb-2"><i class="fas fa-list"></i> Danh s√°ch chi ti·∫øt s·∫£n ph·∫©m</h6>
                <table id="table-variants" class="table table-bordered align-middle">
                    <thead>
                    <tr>
                        <th class="text-center" style="width:40px;">
                            <input type="checkbox" id="selectAllVariants">
                        </th>
                        <th style="width:40px;">STT</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>M√†u</th>
                        <th>K√≠ch c·ª°</th>
                        <th style="width:100px;">S·ªë l∆∞·ª£ng</th>
                        <th style="width:140px;">Gi√°</th>
                        <th style="width:130px;">Tr·∫°ng th√°i</th>
                        <th style="width:220px;">·∫¢nh</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td colspan="9" class="text-muted text-center">Ch∆∞a c√≥ bi·∫øn th·ªÉ n√†o.</td>
                    </tr>
                    </tbody>
                </table>


                <div class="save-container">
                    <button class="btn btn-success btn-sm px-3" id="btn-save-product">
                        <i class="fas fa-save"></i> L∆∞u s·∫£n ph·∫©m
                    </button>
                </div>
            </div>
        </div>
        <!-- ü™ü POPUP TH√äM NHANH THU·ªòC T√çNH -->
        <div id="quickAddModal" class="quick-modal">
            <div class="quick-modal-content">
                <h5 id="quickModalTitle" class="modal-title">Th√™m m·ªõi</h5>

                <!-- üîπ Giao di·ªán popup th√™m m√†u s·∫Øc -->
                <div id="quickAddForm" class="d-flex flex-wrap" style="gap: 20px;">

                    <!-- üü© C·ªòT TR√ÅI: Ch·ªçn m√£ m√†u -->
                    <div id="colorPickerSection" class="flex-fill" style="min-width: 180px;">
                        <label for="attrColorInput" class="form-label fw-bold">Ch·ªçn m√£ m√†u:</label>
                        <!--                            <input type="color" id="attrColorInput" class="form-control form-control-color w-100" value="#000000">-->
                        <input
                                type="color"
                                id="attrColorInput"
                                value="#000000"
                                style="position:absolute;width:0;height:0;opacity:0;pointer-events:none;border:0;padding:0;margin:0;"
                        />
                        <!-- üé® √î ch·ªçn m√£ m√†u ƒë·∫πp -->
                        <div id="customColorPickerContainer" style="position: relative;">
                            <div class="selected-color-box" id="selectedColorBox" title="B·∫•m ƒë·ªÉ ch·ªçn m√†u"></div>
                            <input type="text" id="colorHexDisplay" value="#000000" maxlength="7"/>

                            <!-- üé® Popup b·∫£ng ch·ªçn m√†u (N·∫∞M TRONG CONTAINER N√ÄY) -->
                            <div id="customColorPalette" class="color-palette shadow">
                                <div class="color-palette-grid">
                                    <div class="color-item" style="background:#FF0000" data-color="#FF0000"></div>
                                    <div class="color-item" style="background:#00FF00" data-color="#00FF00"></div>
                                    <div class="color-item" style="background:#0000FF" data-color="#0000FF"></div>
                                    <div class="color-item" style="background:#FFFF00" data-color="#FFFF00"></div>
                                    <div class="color-item" style="background:#FFA500" data-color="#FFA500"></div>
                                    <div class="color-item" style="background:#FFC0CB" data-color="#FFC0CB"></div>
                                    <div class="color-item" style="background:#8A2BE2" data-color="#8A2BE2"></div>
                                    <div class="color-item" style="background:#A52A2A" data-color="#A52A2A"></div>
                                    <div class="color-item" style="background:#008080" data-color="#008080"></div>
                                    <div class="color-item" style="background:#000000" data-color="#000000"></div>
                                    <div class="color-item" style="background:#808080" data-color="#808080"></div>
                                    <div class="color-item" style="background:#FFFFFF; border:1px solid #ccc"
                                         data-color="#FFFFFF"></div>
                                </div>
                                <input type="color" id="colorFreePicker" class="form-control form-control-color mt-2"
                                       value="#000000">
                            </div>
                        </div>


                        <div class="mt-2 small text-muted">
                            <div>M√£ m√†u: <strong id="colorCodeDisplay">#000000</strong></div>
                            <div>T√™n g·ª£i √Ω: <strong id="colorNameDisplay">ƒêen</strong></div>
                        </div>
                    </div>

                    <!-- üü¶ C·ªòT PH·∫¢I: T√™n th·ªß c√¥ng + Tr·∫°ng th√°i -->
                    <div id="colorInfoSection" class="flex-fill" style="min-width: 240px;">
                        <!-- T√™n m√†u th·ªß c√¥ng -->
                        <div id="colorNameInputSection" class="mb-3">
                            <label for="attrColorNameInput" class="form-label fw-bold">T√™n m√†u th·ªß c√¥ng (tu·ª≥
                                ch·ªçn):</label>
                            <input type="text" id="attrColorNameInput" class="form-control"
                                   placeholder="VD: ƒêen tuy·ªÅn, ƒê·ªè ƒë√¥, Xanh pastel...">
                        </div>

                        <!-- Dropdown tr·∫°ng th√°i -->
                        <div id="colorStatusSection">
                            <label for="attrStatusInput" class="form-label fw-bold">Tr·∫°ng th√°i:</label>
                            <div class="dropdown">
                                <input type="text" id="attrStatusInput" class="form-control dropdown-input"
                                       placeholder="Ch·ªçn tr·∫°ng th√°i" readonly>
                                <div id="attrStatusList" class="dropdown-list">
                                    <div class="dropdown-item" data-id="1">ƒêang b√°n</div>
                                    <div class="dropdown-item" data-id="0">Ng·ª´ng b√°n</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="modal-footer">
                    <button class="btn btn-success btn-sm px-3" id="btnSaveAttr">
                        <i class="fas fa-save"></i> L∆∞u
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<div layout:fragment="scripts">
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            document.documentElement.style.setProperty('--scrollbar-width', `${scrollbarWidth}px`);
        });
    </script>

    <style>
        /* G·ª£i √Ω style nh·ªè cho UX (c√≥ th·ªÉ b·ªè n·∫øu b·∫°n ƒë√£ c√≥) */
        #tenSanPhamList {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, .08);
            max-height: 260px;
            overflow: auto;
            z-index: 1000;
            transition: opacity .12s ease, transform .12s ease;
        }

        #tenSanPhamList .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        #tenSanPhamList .dropdown-item:hover, #tenSanPhamList .dropdown-item.active {
            background: #f3f4f6;
        }

        #tenSanPhamList .dropdown-empty {
            padding: 10px 12px;
            color: #6b7280;
            font-style: italic;
        }

        #tenSanPhamList.loading {
            background: linear-gradient(90deg, #fff, #f9fafb, #fff);
            background-size: 200% 100%;
            animation: shine 1s linear infinite;
        }

        @keyframes shine {
            to {
                background-position: -200% 0;
            }
        }

        #tenSanPhamList mark {
            background: #fff1a6;
            padding: 0 2px;
            border-radius: 3px;
        }

        #quickAddModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        #quickAddModal.show {
            display: flex;
            animation: fadeIn .15s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        #quickAddModal .modal-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px 24px;
            width: 420px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(0);
            animation: slideUp .2s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #table-variants tr.selected {
            background-color: #eaf4ff;
        }

        #table-variants tr:hover {
            background-color: #f9fafc;
        }

        /* ‚úÖ CƒÉn gi·ªØa input theo chi·ªÅu d·ªçc trong b·∫£ng */
        /* ‚úÖ Gi·ªØ to√†n b·ªô √¥ b·∫£ng cƒÉn gi·ªØa */
        .table td {
            vertical-align: middle !important;
        }

        /* ‚úÖ CƒÉn input s·ªë l∆∞·ª£ng & gi√° gi·ªØa h√†ng, c√πng chi·ªÅu cao ƒë·∫πp */
        .table td .form-control.form-control-sm {
            height: 34px; /* C√¢n v·ªõi chi·ªÅu cao d√≤ng ch·ªØ */
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            line-height: 34px; /* Gi√∫p ch·ªØ trong input cƒÉn gi·ªØa */
            text-align: center; /* CƒÉn gi·ªØa n·ªôi dung */
            font-size: 14px; /* Gi·ªØ ch·ªØ v·ª´a m·∫Øt, kh√¥ng b·ªã l·ªách */
            border-radius: 6px; /* Bo nh·∫π cho ƒë·ªìng b·ªô style Aurora */
        }

        /* ‚úÖ Gi·∫£m kho·∫£ng c√°ch gi·ªØa c√°c d√≤ng */
        .table tbody tr {
            height: 40px;
        }

        /* ‚úÖ N·∫øu d√πng m√†u n·ªÅn hover ho·∫∑c ch·ªçn */
        .table tr.selected {
            background: rgba(20, 245, 241, 0.1);
        }

        /* ‚úÖ C√¢n ch·ªânh t·ªïng th·ªÉ table nh·ªè g·ªçn, kh√¥ng v√™nh */
        .table th, .table td {
            padding: 6px 8px !important;
        }

        /* üåô Khi dropdown b·ªã kh√≥a (s·∫£n ph·∫©m c√≥ s·∫µn) */
        .disabled-field {
            background: rgba(240, 240, 240, 0.9) !important;
            cursor: not-allowed !important;
            user-select: none;
            transition: all 0.2s ease;
        }


    </style>

    <script>
        // ============================================================
        // üü¢ BI·∫æN TO√ÄN C·ª§C ‚Äî D√ôNG CHUNG CHO TO√ÄN B·ªò TRANG
        // ============================================================
        let finalSanPhamId = null;   // üîπ ID s·∫£n ph·∫©m ch√≠nh sau khi t·∫°o ho·∫∑c ch·ªçn
        let sanPhamId = null;        // üîπ D·ª± ph√≤ng n·∫øu d√πng t√™n kh√°c ·ªü ch·ªó kh√°c
        let tenSanPhamData = [];     // üîπ D·ªØ li·ªáu danh s√°ch s·∫£n ph·∫©m


        // ============================================================
        // üîπ 1Ô∏è‚É£ LOAD D·ªÆ LI·ªÜU DROPDOWN T·ª™ API (TH∆Ø∆†NG HI·ªÜU, DANH M·ª§C, CH·∫§T LI·ªÜU, ƒê·∫æ GI√ÄY, M√ÄU, C·ª†)
        // ============================================================
        async function loadDropdownData() {
            try {
                const [thuongHieuRes, danhMucRes, chatLieuRes, deGiayRes, mauSacRes, kichCoRes] = await Promise.all([
                    axios.get('/api/thuong-hieu/getAll'),
                    axios.get('/api/danh-muc/getAll'),
                    axios.get('/api/chat-lieu/getAll'),
                    axios.get('/api/de-giay/getAll'),
                    axios.get('/api/mau-sac/getAll'),
                    axios.get('/api/kich-co/getAll')
                ]);

                const mapData = (data, field, listId) => {
                    const $list = $(`#${listId}`);
                    if (!$list.length) return;
                    $list.empty();
                    const html = data.map(item => `
        <div class="dropdown-item" data-id="${item.id}">
          <i class="far fa-square me-2"></i> ${item[field]}
        </div>`).join('');
                    $list.html(html);
                };

                mapData(thuongHieuRes.data, 'tenThuongHieu', 'thuongHieuList');
                mapData(danhMucRes.data, 'tenDanhMuc', 'danhMucList');
                mapData(chatLieuRes.data, 'tenChatLieu', 'chatLieuList');
                mapData(deGiayRes.data, 'tenDeGiay', 'deGiayList');
                renderColorPopup(mauSacRes.data);
                renderSizePopup(kichCoRes.data);
            } catch (err) {
                console.error('‚ùå L·ªói load dropdown:', err);
            }
        }

        // ============================================================
        // üîπ 2Ô∏è‚É£ DROPDOWN CHUNG (SINGLE SELECT)
        // ============================================================
        $(document).on('click', '.dropdown-input', function () {
            const id = $(this).attr('id');
            if (id === 'tenSanPhamInput') return; // ‚ö†Ô∏è b·ªè qua dropdown t√™n s·∫£n ph·∫©m (c√≥ x·ª≠ l√Ω ri√™ng)
            const listId = '#' + id.replace('Input', 'List');
            if (['#gioiTinhList', '#trangThaiList', '#attrStatusList'].includes(listId)) return;

            $('.dropdown-list').not(listId).removeClass('show');
            $(listId).toggleClass('show');
            adjustDropdownHeight($(listId));
        });

        $(document).on('click', '.dropdown-list.single-select .dropdown-item', function (e) {
            e.stopPropagation();
            const $item = $(this);
            const $list = $item.closest('.dropdown-list');
            const id = $item.data('id');
            const name = $item.text().trim();
            const inputId = '#' + $list.attr('id').replace('List', 'Input');
            const $input = $(inputId);

            // reset ch·ªçn c≈©
            $list.find('.dropdown-item').removeClass('selected')
                .find('i').removeClass('fa-check-square text-primary').addClass('fa-square');
            // ch·ªçn m·ªõi
            $item.addClass('selected')
                .find('i').removeClass('fa-square').addClass('fa-check-square text-primary');

            $input.val(name).data('id', id);
            adjustDropdownHeight($list);
            $list.removeClass('show');
        });


        function adjustDropdownHeight($list) {
            const count = $list.find('.dropdown-item').length;
            if (count > 4) {
                $list.css({'max-height': '180px', 'overflow-y': 'auto'});
            } else {
                $list.css({'max-height': 'none', 'overflow-y': 'hidden'});
            }
        }

        // ============================================================
        // üü† 3Ô∏è‚É£ GI·ªöI T√çNH & TR·∫†NG TH√ÅI (SINGLE SELECT ƒê·∫∂C BI·ªÜT)
        // ============================================================
        ['trangThai', 'gioiTinh'].forEach(prefix => {
            const inputSel = `#${prefix}Input`;
            const listSel = `#${prefix}List`;

            $(document).on('click', inputSel, function () {
                $('.dropdown-list').not(listSel).removeClass('show');
                $(listSel).toggleClass('show');
                adjustDropdownHeight($(listSel));
            });

            $(document).on('click', `${listSel} .dropdown-item`, function (e) {
                e.stopPropagation();
                const $item = $(this);
                const $list = $item.parent();
                const $input = $(inputSel);
                if ($item.hasClass('selected')) return;

                $list.find('.dropdown-item').removeClass('selected')
                    .find('i').removeClass('fa-check-square text-primary').addClass('fa-square');

                $item.addClass('selected');
                $item.find('i').removeClass('fa-square').addClass('fa-check-square text-primary');

                $input.val($item.text().trim()).data('id', $item.data('id'));
                $list.removeClass('show');
            });
        });

        // üü¢ ·∫®n t·∫•t c·∫£ dropdown khi click ra ngo√†i (th∆∞∆°ng hi·ªáu, danh m·ª•c, ch·∫•t li·ªáu, ƒë·∫ø gi√†y, gi·ªõi t√≠nh, tr·∫°ng th√°i...)
        $(document).on('click', function (e) {
            const $target = $(e.target);

            // N·∫øu click kh√¥ng n·∫±m trong input dropdown ho·∫∑c danh s√°ch dropdown
            if (!$target.closest('.dropdown-input, .dropdown-list').length) {
                $('.dropdown-list').removeClass('show').fadeOut(150);
            }
        });


        // ============================================================
        // üîπ 3Ô∏è‚É£ VALIDATE INPUT B·∫ÆT BU·ªòC
        // ============================================================
        function validateRequiredInput(selector, message) {
            const $input = $(selector);
            const id = $input.data('id');
            if (id === undefined || id === null || !$input.val().trim()) {
                $input.addClass('is-invalid');
                if ($input.next('.error-message').length === 0) {
                    $input.after(`<small class="error-message text-danger">${message}</small>`);
                }
                return false;
            } else {
                $input.removeClass('is-invalid');
                $input.next('.error-message').remove();
                return true;
            }
        }

        // ============================================================
        // üîπ 4Ô∏è‚É£ DROPDOWN T√äN S·∫¢N PH·∫®M (SEARCHABLE + ADD NEW + LOAD FORM)
        // ============================================================

        const TEN_SP_MIN_CHARS = 2;
        const TEN_SP_PAGE_SIZE = 20;
        let tenSpTypingTimer, tenSpActiveIndex = -1, tenSpCurrentItems = [];
        window.SPCTX_STATE = {mode: 'new', sanPhamId: null};

        function debounce(fn, d = 250) {
            clearTimeout(tenSpTypingTimer);
            tenSpTypingTimer = setTimeout(fn, d);
        }

        function esc(s = '') {
            return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function highlight(txt, kw) {
            if (!kw) return esc(txt);
            const re = new RegExp(kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'ig');
            return esc(txt).replace(re, m => `<mark>${m}</mark>`);
        }

        async function loadTenSanPhamList() {
            try {
                const res = await axios.get('/api/san-pham/getAll');
                window.tenSanPhamData = res.data || [];
                renderTenSanPhamList(window.tenSanPhamData);
            } catch (err) {
                console.error('‚ùå L·ªói load s·∫£n ph·∫©m:', err);
                window.tenSanPhamData = [];
            }
        }

        async function searchTenSanPham(keyword) {
            const $list = $('#tenSanPhamList');
            $list.addClass('loading');
            try {
                if (keyword.trim().length >= TEN_SP_MIN_CHARS) {
                    const res = await axios.get('/api/san-pham/search', {params: {keyword, limit: TEN_SP_PAGE_SIZE}});
                    renderTenSanPhamList(res.data || [], keyword);
                } else renderTenSanPhamList(window.tenSanPhamData || [], keyword);
            } catch {
                const base = window.tenSanPhamData || [];
                const filtered = base.filter(sp => sp.tenSanPham.toLowerCase().includes(keyword.toLowerCase()));
                renderTenSanPhamList(filtered, keyword);
            } finally {
                $list.removeClass('loading');
            }
        }

        function renderTenSanPhamList(list, keyword = '') {
            const $list = $('#tenSanPhamList');
            $list.empty();
            tenSpCurrentItems = [];
            tenSpActiveIndex = -1;
            const rows = list && list.length ? list.slice(0, TEN_SP_PAGE_SIZE) : [];

            if (!rows.length) {
                if (keyword.trim().length >= TEN_SP_MIN_CHARS) {
                    $list.append(`
        <div class="dropdown-empty">Kh√¥ng t√¨m th·∫•y ‚Äú${esc(keyword)}‚Äù</div>
        <div class="dropdown-item add-new" data-id="null">‚ûï Th√™m s·∫£n ph·∫©m m·ªõi: <strong>${esc(keyword)}</strong></div>`);
                } else {
                    $list.append(`<div class="dropdown-empty">Nh·∫≠p t·ªëi thi·ªÉu ${TEN_SP_MIN_CHARS} k√Ω t·ª± ƒë·ªÉ t√¨m‚Ä¶</div>`);
                }
                adjustDropdownHeight($list);
                return;
            }

            rows.forEach((sp, i) => {
                tenSpCurrentItems.push(sp);
                $list.append(`<div class="dropdown-item" data-id="${sp.id}" data-index="${i}">
      ${highlight(sp.tenSanPham, keyword)}</div>`);
            });
            adjustDropdownHeight($list);
        }

        // m·ªü dropdown
        $(document).on('focus click', '#tenSanPhamInput', function (e) {
            e.stopPropagation();
            const $list = $('#tenSanPhamList');
            $('.dropdown-list').not($list).removeClass('show');
            $list.addClass('show');
            const kw = $(this).val();
            if (kw.trim().length >= TEN_SP_MIN_CHARS) searchTenSanPham(kw);
            else renderTenSanPhamList(window.tenSanPhamData || [], kw);
        });

        // g√µ t√¨m ki·∫øm
        $(document).on('input', '#tenSanPhamInput', function () {
            const kw = $(this).val() || '';
            $(this).data('id', null);
            if (window.SPCTX_STATE.mode === 'existing') window.SPCTX_STATE = {mode: 'new', sanPhamId: null};
            const $list = $('#tenSanPhamList');
            if (!$list.hasClass('show')) $list.addClass('show');
            debounce(() => searchTenSanPham(kw), 250);
        });

        // click ch·ªçn item
        $(document).on('click', '#tenSanPhamList .dropdown-item', async function (e) {
            e.stopPropagation();
            const $item = $(this);
            const id = $item.data('id');
            const name = $item.text().replace(/^‚ûï\s*Th√™m s·∫£n ph·∫©m m·ªõi:\s*/i, '').trim();
            if ($item.hasClass('add-new')) await startNewProduct(name);
            else await selectExistingProduct(id, name);
            $('#tenSanPhamList').removeClass('show');
        });

        // ƒëi·ªÅu h∆∞·ªõng ph√≠m
        $(document).on('keydown', '#tenSanPhamInput', function (e) {
            const $list = $('#tenSanPhamList');
            if (!$list.hasClass('show')) return;
            const $items = $list.find('.dropdown-item');
            if (!$items.length) return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                tenSpActiveIndex = (tenSpActiveIndex + 1) % $items.length;
                setActive($items, tenSpActiveIndex);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                tenSpActiveIndex = (tenSpActiveIndex - 1 + $items.length) % $items.length;
                setActive($items, tenSpActiveIndex);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (tenSpActiveIndex >= 0) $items.eq(tenSpActiveIndex).trigger('click');
            } else if (e.key === 'Escape') $list.removeClass('show');
        });

        function setActive($items, i) {
            $items.removeClass('active');
            const $it = $items.eq(i).addClass('active');
            const list = $('#tenSanPhamList')[0];
            if ($it.length && list) {
                const t = $it[0].offsetTop, b = t + $it[0].offsetHeight;
                if (t < list.scrollTop) list.scrollTop = t; else if (b > list.scrollTop + list.clientHeight) list.scrollTop = b - list.clientHeight;
            }
        }

        $(document).on('click', e => {
            if (!$(e.target).closest('#tenSanPhamInput, #tenSanPhamList').length) $('#tenSanPhamList').removeClass('show');
        });

        // ============================================================
        // üîπ 5Ô∏è‚É£ FLOW CH·ªåN / T·∫†O M·ªöI S·∫¢N PH·∫®M
        // ============================================================
        // üß† H√†m ti·ªán √≠ch: sinh th√¥ng tin ng∆∞·ªùi t·∫°o / c·∫≠p nh·∫≠t chu·∫©n
        function buildAuditFields(isCreate = false) {
            const CURRENT_ADMIN =
                window.ADMIN_NAME ||
                localStorage.getItem('adminName') ||
                'ADMIN';

            // ‚úÖ Chu·∫©n ISO m√∫i gi·ªù VN (ISO 8601)
            const now = new Date();
            const offset = now.getTimezoneOffset();
            const localISOTime = new Date(now.getTime() - offset * 60000)
                .toISOString()
                .slice(0, 19); // yyyy-MM-ddTHH:mm:ss

            if (isCreate) {
                return {
                    nguoiTao: CURRENT_ADMIN,
                    nguoiCapNhat: CURRENT_ADMIN,
                    ngayTao: localISOTime,
                    ngayCapNhat: localISOTime
                };
            }

            return {
                nguoiCapNhat: CURRENT_ADMIN,
                ngayCapNhat: localISOTime
            };
        }

        async function startNewProduct(name) {
            const $in = $('#tenSanPhamInput');
            $in.val(name).data('id', null);
            window.SPCTX_STATE = {mode: 'new', sanPhamId: null};
            resetLeftFormKeepName();
            clearVariantTable();
            clearImagesPreviewArea();
            toastInfo('ƒêang t·∫°o s·∫£n ph·∫©m m·ªõi.');
            // üîì Cho ph√©p ch·ªçn l·∫°i to√†n b·ªô dropdown khi t·∫°o m·ªõi
            $('#thuongHieuInput, #danhMucInput, #chatLieuInput, #deGiayInput, #gioiTinhInput, #trangThaiInput')
                .prop('disabled', false)
                .removeClass('disabled-field')
                .css('opacity', 1)
                .css('pointer-events', 'auto');
        }

        async function selectExistingProduct(id, name) {
            const $in = $('#tenSanPhamInput');
            $in.val(name).data('id', id);
            window.SPCTX_STATE = {mode: 'existing', sanPhamId: id};
            try {
                const res = await axios.get(`/api/san-pham/${id}`);
                fillLeftFormWith(res.data);
                clearVariantTable();
                toastSuccess('ƒê√£ n·∫°p th√¥ng tin s·∫£n ph·∫©m.');
                // üîí Kh√≥a to√†n b·ªô dropdown khi ch·ªçn s·∫£n ph·∫©m c√≥ s·∫µn
                $('#thuongHieuInput, #danhMucInput, #chatLieuInput, #deGiayInput, #gioiTinhInput, #trangThaiInput')
                    .prop('disabled', true)
                    .addClass('disabled-field')
                    .css('opacity', 0.6)
                    .css('pointer-events', 'none');

            } catch {
                toastError('Kh√¥ng t·∫£i ƒë∆∞·ª£c th√¥ng tin s·∫£n ph·∫©m.');
            }
        }

        // ============================================================
        // üîπ 6Ô∏è‚É£ STUB H·ªñ TR·ª¢ FORM TR√ÅI & KH√ÅC
        // ============================================================
        function resetLeftFormKeepName() {
            // Reset dropdown v·ªÅ r·ªóng
            $('#thuongHieuInput,#danhMucInput,#chatLieuInput,#deGiayInput')
                .val('')
                .data('ids', [])
                .data('id', null)
                .trigger?.('change');

            $('#gioiTinhInput').val('').data('id', null);
            $('#trangThaiInput').val(mapTrangThai(1)).data('id', 1);

            // ‚úÖ N·∫øu ƒëang t·∫°o m·ªõi (SPCTX_STATE.mode === 'new') ‚Üí m·ªü m√¥ t·∫£ ƒë·ªÉ nh·∫≠p
            const isNew = window.SPCTX_STATE?.mode === 'new';
            $('#moTa, #moTaInput')
                .val('')
                .prop('readonly', !isNew)
                .prop('disabled', !isNew);
        }


        // Helper: set dropdown hi·ªÉn th·ªã T√äN (kh√¥ng ph·∫£i id)
        function setSingleDropdown(inputId, listId, id, name) {
            const $input = $('#' + inputId);
            let displayName = name;

            // N·∫øu ch∆∞a c√≥ t√™n, d√≤ trong list ƒë√£ render ƒë·ªÉ l·∫•y text
            if (!displayName && id != null) {
                const $itm = $('#' + listId + ' .dropdown-item[data-id="' + id + '"]');
                if ($itm.length) displayName = $itm.text().trim().replace(/^\s*‚ñ°\s*/, '');
            }

            if (id != null && displayName) {
                $input.val(displayName).data('ids', [id]).data('id', id); // gi·ªØ c·∫£ id trong data
            } else {
                $input.val('').data('ids', []).data('id', null);
            }
        }

        // Map hi·ªÉn th·ªã ƒë·∫∑c bi·ªát
        function mapGioiTinh(v) {
            switch (String(v)) {
                case '0':
                    return 'Nam';
                case '1':
                    return 'N·ªØ';
                case '2':
                    return 'Nam & N·ªØ'; // ho·∫∑c 'Nam v√† N·ªØ' n·∫øu b·∫°n th√≠ch
                default :
                    return 'Nam & N·ªØ'; // m·∫∑c ƒë·ªãnh
            }
        }

        function mapTrangThai(v) {
            return String(v) === '1' ? 'ƒêang b√°n' : 'Ng·ª´ng b√°n';
        }


        function fillLeftFormWith(sp) {
            // C√°c kh√≥a t√™n c√≥ th·ªÉ kh√°c nhau t√πy API ‚Üí l·∫•y m·ªÅm d·∫ªo
            const brandId = sp.thuongHieuId ?? sp.brandId ?? null;
            const brandName = sp.tenThuongHieu ?? sp.thuongHieuTen ?? sp.brandName ?? null;

            const cateId = sp.danhMucId ?? sp.categoryId ?? null;
            const cateName = sp.tenDanhMuc ?? sp.danhMucTen ?? sp.categoryName ?? null;

            const chatLieuId = sp.chatLieuId ?? null;
            const chatLieuName = sp.tenChatLieu ?? sp.chatLieuTen ?? null;

            const deGiayId = sp.deGiayId ?? null;
            const deGiayName = sp.tenDeGiay ?? sp.deGiayTen ?? null;

            // Set dropdown hi·ªÉn th·ªã T√äN + l∆∞u id v√†o data
            setSingleDropdown('thuongHieuInput', 'thuongHieuList', brandId, brandName);
            setSingleDropdown('danhMucInput', 'danhMucList', cateId, cateName);
            setSingleDropdown('chatLieuInput', 'chatLieuList', chatLieuId, chatLieuName);
            setSingleDropdown('deGiayInput', 'deGiayList', deGiayId, deGiayName);

            // Gi·ªõi t√≠nh & Tr·∫°ng th√°i l√† input ƒë∆°n (kh√¥ng multi-ids)
            if (sp.gioiTinh != null) {
                $('#gioiTinhInput').val(mapGioiTinh(sp.gioiTinh)).data('id', sp.gioiTinh);
            }
            if (sp.trangThai != null) {
                $('#trangThaiInput').val(mapTrangThai(sp.trangThai)).data('id', sp.trangThai);
            }

            // M√¥ t·∫£: ƒê·∫®Y V√ÄO & CHO S·ª¨A (b·ªè readonly/disabled n·∫øu c√≥)
            const moTa = sp.moTa ?? sp.moTaSanPham ?? sp.description ?? '';
            const isNew = window.SPCTX_STATE?.mode === 'new';

            $('#moTa, #moTaInput')
                .val(moTa)
                .prop('readonly', !isNew)
                .prop('disabled', !isNew);
        }


        function clearVariantTable() {
            $('#table-variants tbody').empty();
        }

        function clearImagesPreviewArea() { /* clear ·∫£nh n·∫øu c√≥ */
        }

        function toastInfo(m) {
            console.info(m);
        }

        function toastSuccess(m) {
            console.log(m);
        }

        function toastError(m) {
            console.error(m);
        }

        // ============================================================
        // üîπ 7Ô∏è‚É£ INIT
        // ============================================================
        $(document).ready(async () => {
            await loadDropdownData();
            await loadTenSanPhamList();
        });


        // ============================================================
        // üüß 3Ô∏è‚É£ POPUP M√ÄU S·∫ÆC (Color Picker)
        // ============================================================
        function renderColorPopup(data) {
            const $popup = $('#mauSacPopup');
            $popup.empty();
            data.forEach(item => {
                $popup.append(`
            <div class="color-item"
                 data-id="${item.id}"
                 title="${item.tenMau}"
                 style="background-color: ${item.maMau};">
            </div>
        `);
            });
        }

        // Hover hi·ªÉn th·ªã m·ªü r·ªông
        $(document).on('mouseenter', '.color-item', function () {
            $('#mauSacPopup').addClass('expanded');
        });

        $(document).on('mouseleave', '.color-item', function () {
            $('#mauSacPopup').removeClass('expanded');
        });

        // M·ªü / ƒë√≥ng popup m√†u
        $(document).on('click', '#mauSacInput', function (e) {
            e.stopPropagation();
            $('.color-popup').not('#mauSacPopup').removeClass('show');
            $('#mauSacPopup').toggleClass('show');
        });

        // Ch·ªçn m√†u
        $(document).on('click', '.color-item', function (e) {
            e.stopPropagation();
            const $item = $(this);
            $item.toggleClass('selected');

            const selectedNames = [], selectedIds = [], selectedColors = [];

            $('#mauSacPopup .color-item.selected').each(function () {
                selectedNames.push($(this).attr('title'));
                selectedIds.push($(this).data('id'));
                selectedColors.push($(this).css('background-color'));
            });

            $('#mauSacInput').val(selectedNames.join(', ')).data('ids', selectedIds);
            toggleGenerateButtonState(); // üîπ th√™m d√≤ng n√†y
        });

        // ·∫®n popup khi click ra ngo√†i
        $(document).click(function (e) {
            if (!$(e.target).closest('#mauSacPopup, #mauSacInput').length) {
                const hasSelected = $('#mauSacPopup .color-item.selected').length > 0;
                if (!hasSelected) $('#mauSacPopup').removeClass('show');
            }
        });


        // ============================================================
        // üü® 4Ô∏è‚É£ POPUP K√çCH C·ª† (Size Picker)
        // ============================================================
        function renderSizePopup(data) {
            const $popup = $('#kichCoPopup');
            $popup.empty();
            data.forEach(item => {
                $popup.append(`
            <div class="size-item"
                 data-id="${item.id}"
                 title="${item.tenKichCo}">
                 ${item.tenKichCo}
            </div>
        `);
            });
        }

        // M·ªü / ƒë√≥ng popup k√≠ch c·ª°
        $(document).on('click', '#kichCoInput', function (e) {
            e.stopPropagation();
            $('.size-popup').not('#kichCoPopup').removeClass('show');
            $('#kichCoPopup').toggleClass('show');
        });

        // Ch·ªçn k√≠ch c·ª°
        $(document).on('click', '.size-item', function (e) {
            e.stopPropagation();
            const $item = $(this);
            $item.toggleClass('selected');

            const selectedNames = [], selectedIds = [];
            $('#kichCoPopup .size-item.selected').each(function () {
                selectedNames.push($(this).text().trim());
                selectedIds.push($(this).data('id'));
            });

            $('#kichCoInput').val(selectedNames.join(', ')).data('ids', selectedIds);
            toggleGenerateButtonState(); // üîπ th√™m d√≤ng n√†y
        });

        // ·∫®n popup k√≠ch c·ª° khi click ra ngo√†i (n·∫øu ch∆∞a ch·ªçn)
        $(document).click(function (e) {
            if (!$(e.target).closest('#kichCoPopup, #kichCoInput').length) {
                const hasSelected = $('#kichCoPopup .size-item.selected').length > 0;
                if (!hasSelected) $('#kichCoPopup').removeClass('show');
            }
        });


        // üîπ Khi b·∫•m "Sinh bi·∫øn th·ªÉ" ‚Üí render b·∫£ng
        $(document).on('click', '#btnGenerateVariants', function () {
            const tenSanPham = $('#tenSanPhamInput').val().trim();
            const mauSacIds = $('#mauSacInput').data('ids') || [];
            const kichCoIds = $('#kichCoInput').data('ids') || [];

            if (!tenSanPham || mauSacIds.length === 0 || kichCoIds.length === 0) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m, ch·ªçn m√†u s·∫Øc v√† k√≠ch c·ª° tr∆∞·ªõc!');
                return;
            }

            // üß† G·ªçi h√†m render b·∫£ng th·ªß c√¥ng
            updateVariantTable();
        });

        // Disable n√∫t ‚ÄúSinh bi·∫øn th·ªÉ‚Äù khi ch∆∞a ch·ªçn ƒë·ªß
        function toggleGenerateButtonState() {
            const tenSanPham = $('#tenSanPhamInput').val().trim();

            // D·ªØ li·ªáu t·ª´ data() ho·∫∑c fallback theo text
            const mauSacIds = $('#mauSacInput').data('ids');
            const kichCoIds = $('#kichCoInput').data('ids');
            const mauSacText = $('#mauSacInput').val().trim();
            const kichCoText = $('#kichCoInput').val().trim();

            // ‚úÖ D√π data m·∫•t th√¨ text v·∫´n d√πng ƒë∆∞·ª£c
            const mauSacFilled = (Array.isArray(mauSacIds) && mauSacIds.length > 0) || mauSacText.length > 0;
            const kichCoFilled = (Array.isArray(kichCoIds) && kichCoIds.length > 0) || kichCoText.length > 0;

            const canGenerate = tenSanPham.length > 0 && mauSacFilled && kichCoFilled;
            $('#btnGenerateVariants').prop('disabled', !canGenerate);
        }


        $(document).on('input click', '#tenSanPhamInput, #mauSacInput, #kichCoInput', toggleGenerateButtonState);


        // üîπ Khi b·∫•m "X√≥a t·∫•t c·∫£ bi·∫øn th·ªÉ" ‚Üí d·ªçn b·∫£ng
        $(document).on('click', '#btnClearVariants', function () {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ bi·∫øn th·ªÉ kh√¥ng?')) {
                $('#table-variants').html(`
            <tr><td colspan="10" class="text-muted text-center">Ch∆∞a c√≥ bi·∫øn th·ªÉ n√†o.</td></tr>
        `);
            }
        });


        // ============================================================
        // üü• 8Ô∏è‚É£ POPUP TH√äM NHANH THU·ªòC T√çNH (Add nhanh - N√¢ng c·∫•p Aurora)
        // ============================================================
        $(document).ready(function () {

            // üíæ L∆∞u nhanh thu·ªôc t√≠nh
            $(document).on('click', '#btnSaveAttr', async function () {
                const name = $('#attrColorNameInput').val().trim();
                const statusText = $('#attrStatusInput').val().trim();
                const status = statusText === 'ƒêang b√°n' ? 1 : 0;

                if (!currentAttrType) return toastError('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c lo·∫°i thu·ªôc t√≠nh.');
                if (!name) return toastError('Vui l√≤ng nh·∫≠p t√™n thu·ªôc t√≠nh.');
                if (name.length < 2) return toastError('T√™n thu·ªôc t√≠nh qu√° ng·∫Øn.');
                if (name.length > 100) return toastError('T√™n thu·ªôc t√≠nh qu√° d√†i.');
                if (statusText === '') return toastError('Vui l√≤ng ch·ªçn tr·∫°ng th√°i.');

                const apiMap = {
                    'thuongHieu': '/api/thuong-hieu/add',
                    'danhMuc': '/api/danh-muc/add',
                    'chatLieu': '/api/chat-lieu/add',
                    'deGiay': '/api/de-giay/add',
                    'mauSac': '/api/mau-sac/add',
                    'kichCo': '/api/kich-co/add'
                };

                const fieldMap = {
                    'thuongHieu': 'tenThuongHieu',
                    'danhMuc': 'tenDanhMuc',
                    'chatLieu': 'tenChatLieu',
                    'deGiay': 'tenDeGiay',
                    'mauSac': 'tenMau',
                    'kichCo': 'tenKichCo'
                };

                let payload = {
                    [fieldMap[currentAttrType]]: name,
                    trangThai: status
                };

                // N·∫øu l√† m√†u s·∫Øc, th√™m m√£ m√†u v√† t·ª± ƒë·ªông g·ª£i √Ω t√™n
                if (currentAttrType === 'mauSac') {
                    const colorCode = ($('#attrColorInput').val() || '#000000').toUpperCase();
                    const colorNameManual = name;
                    const colorNameAuto = (window.colorNameMap && colorNameMap[colorCode]) || 'M√†u kh√¥ng x√°c ƒë·ªãnh';
                    const colorName = colorNameManual || colorNameAuto;
                    payload = {
                        tenMau: colorName,
                        maMau: colorCode,
                        trangThai: status
                    };
                }

                try {
                    // üîí Ch·∫∑n double-click
                    $('#btnSaveAttr').prop('disabled', true);

                    // üì§ G·ª≠i request th√™m m·ªõi
                    await axios.post(apiMap[currentAttrType], payload);
                    toastSuccess('‚úÖ ƒê√£ l∆∞u thu·ªôc t√≠nh th√†nh c√¥ng!');
                    await loadDropdownData();

                    // üü¢ H·ªèi ng∆∞·ªùi d√πng mu·ªën th√™m ti·∫øp
                    if (confirm('B·∫°n c√≥ mu·ªën th√™m ti·∫øp kh√¥ng?')) {
                        resetQuickAddForm();
                        $('#attrColorNameInput').focus();
                    } else {
                        $('#quickAddModal').fadeOut(150, () => $('#quickAddModal').removeClass('show'));
                    }

                } catch (err) {
                    console.error('‚ùå L·ªói khi l∆∞u thu·ªôc t√≠nh:', err);
                    toastError('‚ùå L·ªói khi l∆∞u, vui l√≤ng th·ª≠ l·∫°i.');
                } finally {
                    $('#btnSaveAttr').prop('disabled', false);
                }
            });

            // ‚Ü©Ô∏è Nh·∫•n Enter ƒë·ªÉ l∆∞u nhanh
            $('#quickAddModal').on('keydown', function (e) {
                if (e.key === 'Enter' && $('#quickAddModal').hasClass('show')) {
                    e.preventDefault();
                    $('#btnSaveAttr').trigger('click');
                }
            });

            // ‚ùå ƒê√≥ng popup khi click n·ªÅn m·ªù
            $(document).on('click', '#quickAddModal', function (e) {
                if ($(e.target).is('#quickAddModal')) {
                    $('#quickAddModal').fadeOut(150, function () {
                        $(this).removeClass('show');
                    });
                }
            });

            // ===== DROPDOWN TR·∫†NG TH√ÅI TRONG POPUP =====
            $(document).on('click', '#attrStatusInput', function (e) {
                e.stopPropagation();
                $('#quickAddModal .dropdown-list').not('#attrStatusList').removeClass('show');
                $('#attrStatusList').toggleClass('show');
            });

            $(document).on('click', '#attrStatusList .dropdown-item', function (e) {
                e.stopPropagation();
                const $item = $(this);
                $('#attrStatusList .dropdown-item').removeClass('selected')
                    .find('i').removeClass('fa-check-square text-primary').addClass('fa-square');
                $item.addClass('selected');
                $item.find('i').removeClass('fa-square').addClass('fa-check-square text-primary');
                $('#attrStatusInput').val($item.text().trim()).data('id', $item.data('id'));
                $('#attrStatusList').removeClass('show');
            });

            // Click ngo√†i popup -> ƒë√≥ng dropdown tr·∫°ng th√°i (ch·ªâ trong popup)
            $('#quickAddModal').on('click', function (e) {
                if (!$(e.target).closest('#attrStatusInput, #attrStatusList').length) {
                    $('#attrStatusList').removeClass('show');
                }
            });

            // üßπ Reset form khi ƒë·ªïi lo·∫°i thu·ªôc t√≠nh ho·∫∑c th√™m ti·∫øp
            function resetQuickAddForm() {
                $('#attrColorNameInput').val('');
                $('#attrStatusInput').val('').data('id', null);
                $('#attrStatusList .dropdown-item').removeClass('selected')
                    .find('i').removeClass('fa-check-square text-primary').addClass('fa-square');

                if (currentAttrType === 'mauSac' && typeof updateColorSelection === 'function') {
                    updateColorSelection('#000000');
                }
            }
        });

        function updateVariantTable() {
            const tenSanPham = $('#tenSanPhamInput').val().trim();
            const mauSacNames = ($('#mauSacInput').val() || '').split(',').map(s => s.trim()).filter(Boolean);
            const kichCoNames = ($('#kichCoInput').val() || '').split(',').map(s => s.trim()).filter(Boolean);

            const mauSacIds = $('#mauSacInput').data('ids') || [];
            const kichCoIds = $('#kichCoInput').data('ids') || [];

            const trangThaiValue = $('#trangThaiInput').data('id') ?? 1;
            const trangThaiLabel = $('#trangThaiInput').val().trim() || 'ƒêang b√°n';
            const gioiTinhValue = $('#gioiTinhInput').data('id') ?? 2;
            const gioiTinhLabel = $('#gioiTinhInput').val().trim() || 'Nam & N·ªØ';

            const $tbody = $('#table-variants tbody');
            const oldRows = $tbody.find('tr');

            // ‚úÖ Cache d·ªØ li·ªáu c≈© (g·ªìm SLT, gi√°, tr·∫°ng th√°i, gi·ªõi t√≠nh)
            const cache = {};
            oldRows.each(function () {
                const mid = $(this).data('mau-id');
                const sid = $(this).data('size-id');
                cache[`${mid}-${sid}`] = {
                    soLuong: $(this).find('.input-slt').val(),
                    giaBan: $(this).find('.input-giaban').val(),
                    trangThai: $(this).find('td[data-value]').data('value'),
                    // gioiTinh: $(this).find('td[data-gioi-tinh]').data('gioi-tinh')
                };
            });

            // ‚úÖ Cache ·∫£nh theo m√†u
            const imgCache = {};
            $('.upload-container').each(function () {
                const mid = $(this).data('mau-id');
                imgCache[mid] = $(this).find('.preview-container').html();
            });

            $tbody.empty();

            if (!tenSanPham || mauSacNames.length === 0 || kichCoNames.length === 0) {
                $tbody.append(`
            <tr><td colspan="9" class="text-muted text-center">
                ‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m v√† ch·ªçn ƒë·∫ßy ƒë·ªß m√†u s·∫Øc, k√≠ch c·ª°.
            </td></tr>
        `);
                return;
            }

            let stt = 1;
            const existingKeys = new Set();
            let rowsHtml = '';

            // ‚úÖ Sinh b·∫£ng bi·∫øn th·ªÉ (M√†u √ó C·ª°)
            mauSacNames.forEach((mau, i) => {
                const mauId = mauSacIds[i];
                const colorRowspan = kichCoNames.length;

                kichCoNames.forEach((size, j) => {
                    const sizeId = kichCoIds[j];
                    const key = `${mauId}-${sizeId}`;
                    if (existingKeys.has(key)) return;
                    existingKeys.add(key);

                    const rowId = `${mauId}-${sizeId}`;
                    rowsHtml += `
            <tr class="variant-row" data-id="${rowId}" data-mau-id="${mauId}" data-size-id="${sizeId}">
                <!-- Tick ch·ªçn -->
                <td class="text-center align-middle">
                    <input type="checkbox" class="variant-checkbox" data-id="${rowId}">
                </td>

                <td class="text-center align-middle">${stt++}</td>
                <td class="text-center align-middle">${tenSanPham}</td>
                <td class="text-center align-middle">${mau}</td>
                <td class="text-center align-middle">${size}</td>

                <!-- S·ªë l∆∞·ª£ng -->
                <td>
                    <input type="number"
                           class="form-control form-control-sm text-end input-slt align-middle"
                           data-id="${rowId}" readonly min="0" value="0">
                </td>

                <!-- Gi√° -->
                <td>
                    <input type="text"
                           class="form-control form-control-sm input-giaban text-end align-middle"
                           data-id="${rowId}" readonly
           value="0ƒë"
           data-raw="0">
</td>




                <!-- Tr·∫°ng th√°i -->
                <td class="text-center align-middle" data-value="${trangThaiValue}">
                    ${trangThaiLabel}
                </td>

                <!-- Upload ·∫£nh -->
                ${j === 0 ? `
                <td rowspan="${colorRowspan}" class="align-middle">
                    <div class="upload-container" data-mau-id="${mauId}" data-color="${mau}">
                        <div class="preview-container d-flex flex-wrap gap-2 mt-2"></div>
                        <div class="upload-placeholder text-center border rounded cursor-pointer">
                            <i class="fas fa-cloud-upload-alt fa-2x text-secondary mb-1"></i>
                            <div class="small text-muted">Ch·ªçn ·∫£nh</div>
                        </div>
                        <input type="file" accept="image/*" multiple style="display:none">
                    </div>
                </td>` : ''}
            </tr>`;
                });
            });

            $tbody.html(rowsHtml);

            // ‚úÖ Restore d·ªØ li·ªáu c≈© (g·ªìm SLT, gi√°, tr·∫°ng th√°i, gi·ªõi t√≠nh)
            $tbody.find('tr').each(function () {
                const key = `${$(this).data('mau-id')}-${$(this).data('size-id')}`;
                if (cache[key]) {
                    $(this).find('.input-slt').val(cache[key].soLuong);
                    $(this).find('.input-giaban').val(cache[key].giaBan);

                    const trangThai = cache[key].trangThai ?? trangThaiValue;
                    // const gioiTinh = cache[key].gioiTinh ?? gioiTinhValue;

                    $(this).find('td[data-value]').attr('data-value', trangThai)
                        .text(trangThai === 1 ? 'ƒêang b√°n' : 'Ng·ª´ng b√°n');
                    // $(this).find('td[data-gioi-tinh]').attr('data-gioi-tinh', gioiTinh)
                    //     .text(gioiTinh === 0 ? 'Nam' : gioiTinh === 1 ? 'N·ªØ' : 'Nam & N·ªØ');
                }
            });

            // ‚úÖ Restore ·∫£nh preview
            $tbody.find('.upload-container').each(function () {
                const mid = $(this).data('mau-id');
                if (imgCache[mid]) $(this).find('.preview-container').html(imgCache[mid]);
            });
        }

        // ============================================================
        // ‚úÖ QU·∫¢N L√ù CH·ªåN H√ÄNG LO·∫†T (CHO TRANG TH√äM S·∫¢N PH·∫®M)
        // ============================================================

        // üîπ H√†m ƒë·ªãnh d·∫°ng gi√° VND
        function formatVnd(val) {
            val = Number(val || 0);
            return val.toLocaleString('vi-VN') + 'ƒë';
        }

        // üîπ Khi tick t·ª´ng d√≤ng
        $(document).on('change', '.variant-checkbox', function () {
            const id = $(this).data('id');
            const checked = $(this).is(':checked');
            const $inputSLT = $(`.input-slt[data-id="${id}"]`);
            const $inputGia = $(`.input-giaban[data-id="${id}"]`);
            const $row = $(`tr.variant-row[data-id="${id}"]`);

            if (checked) {
                // üü¢ B·ªè format ‚Äî hi·ªÉn th·ªã s·ªë th√¥ ƒë·ªÉ nh·∫≠p
                const rawVal = $inputGia.attr('data-raw');
                const displayVal = rawVal && !isNaN(rawVal) ? rawVal : $inputGia.val().replace(/[^\d]/g, '') || 0;
                $inputGia.val(displayVal).prop('readonly', false).addClass('editable');
                $inputSLT.prop('readonly', false).addClass('editable');
            } else {
                // üîµ Khi b·ªè tick ‚Äî l∆∞u l·∫°i gi√° th√¥, format l·∫°i, kh√≥a input
                const newRaw = Number($inputGia.val().replace(/[^\d]/g, '') || 0);
                $inputGia.attr('data-raw', newRaw);
                $inputGia.val(formatVnd(newRaw)).prop('readonly', true).removeClass('editable');
                $inputSLT.prop('readonly', true).removeClass('editable');
            }

            // Highlight d√≤ng khi tick
            $row.toggleClass('selected', checked);
        });

        // üîπ Tick ch·ªçn t·∫•t c·∫£
        $(document).off('change.selectAllVariants').on('change.selectAllVariants', '#selectAllVariants', function () {
            const isChecked = $(this).is(':checked');
            const $checkboxes = $('.variant-checkbox');
            $checkboxes.prop('checked', isChecked);

            $checkboxes.each(function () {
                const id = $(this).data('id');
                const $inputSLT = $(`.input-slt[data-id="${id}"]`);
                const $inputGia = $(`.input-giaban[data-id="${id}"]`);
                const $row = $(`tr.variant-row[data-id="${id}"]`);

                if (isChecked) {
                    const rawVal = $inputGia.attr('data-raw');
                    const displayVal = rawVal && !isNaN(rawVal) ? rawVal : $inputGia.val().replace(/[^\d]/g, '') || 0;
                    $inputGia.val(displayVal).prop('readonly', false).addClass('editable');
                    $inputSLT.prop('readonly', false).addClass('editable');
                } else {
                    const newRaw = Number($inputGia.val().replace(/[^\d]/g, '') || 0);
                    $inputGia.attr('data-raw', newRaw);
                    $inputGia.val(formatVnd(newRaw)).prop('readonly', true).removeClass('editable');
                    $inputSLT.prop('readonly', true).removeClass('editable');
                }

                $row.toggleClass('selected', isChecked);
            });
        });

        // üîπ Khi nh·∫≠p gi√° m·ªõi ‚Üí c·∫≠p nh·∫≠t l·∫°i data-raw ƒë·ªÉ l∆∞u gi√° tr·ªã th√¥
        $(document).on('input', '.input-giaban', function () {
            const val = Number($(this).val().replace(/[^\d]/g, '') || 0);
            $(this).attr('data-raw', val);
        });

        // üîπ ƒê·ªìng b·ªô gi√° v√† SLT gi·ªØa c√°c d√≤ng ƒë√£ tick
        $(document).on('input', '.input-slt, .input-giaban', function () {
            const $this = $(this);
            const val = $this.val();
            const cls = $this.hasClass('input-slt') ? '.input-slt' : '.input-giaban';
            const id = $this.data('id');
            if (!$(`.variant-checkbox[data-id="${id}"]`).is(':checked')) return;

            $('.variant-checkbox:checked').each(function () {
                const otherId = $(this).data('id');
                if (otherId !== id) {
                    $(`${cls}[data-id="${otherId}"]`).val(val).attr('data-raw', val.replace(/[^\d]/g, ''));
                }
            });
        });

        // ============================================================
        // üì∑ X·ª¨ L√ù UPLOAD ·∫¢NH CHO BI·∫æN TH·ªÇ
        // ============================================================
        //
        // // Gi·ªõi h·∫°n 10 ·∫£nh / m√†u, th√™m preview
        // $(document).on('change', '.upload-container input[type="file"]', function (e) {
        //     const files = Array.from(e.target.files);
        //     const $container = $(this).closest('.upload-container');
        //     const $preview = $container.find('.preview-container');
        //     const existing = $preview.find('.preview-item').length;
        //     const max = 10;
        //
        //     if (existing + files.length > max) {
        //         toastError(`‚ö†Ô∏è M·ªói m√†u ch·ªâ ƒë∆∞·ª£c t·ªëi ƒëa ${max} ·∫£nh.`);
        //         return;
        //     }
        //
        //     files.forEach(file => {
        //         const reader = new FileReader();
        //         reader.onload = ev => {
        //             const html = `
        //     <div class="preview-item position-relative">
        //         <img src="${ev.target.result}" class="img-thumbnail" style="width:60px;height:60px;">
        //         <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 remove-img">&times;</button>
        //     </div>`;
        //             $preview.append(html);
        //         };
        //         reader.readAsDataURL(file);
        //     });
        //
        //     // reset input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng file
        //     $(this).val('');
        // });
        //
        // // Xo√° ·∫£nh preview
        // $(document).on('click', '.remove-img', function () {
        //     $(this).closest('.preview-item').remove();
        // });
        //
        // // ============================================================
        // // ‚úÖ CH·ªåN D√íNG (tick ch·ªçn / ch·ªçn t·∫•t c·∫£)
        // // ============================================================
        // $(document).on('click', '.row-select', function () {
        //     const $icon = $(this);
        //     $icon.toggleClass('fa-square fa-check-square text-primary');
        //     $icon.closest('tr').toggleClass('table-active');
        // });
        //
        // $(document).on('click', '#selectAllSPCT', function () {
        //     const checked = $(this).is(':checked');
        //     $('.row-select').each(function () {
        //         $(this)
        //             .toggleClass('fa-square', !checked)
        //             .toggleClass('fa-check-square text-primary', checked);
        //         $(this).closest('tr').toggleClass('table-active', checked);
        //     });
        // });

        // ============================================================
        // üü® 11Ô∏è‚É£ UPLOAD ·∫¢NH & XEM TR∆Ø·ªöC (C√ì N√âN + COVER + REORDER)
        // ============================================================

        // ‚öôÔ∏è N√©n ·∫£nh client-side tr∆∞·ªõc khi preview
        async function compressImage(file, maxWidth = 900, quality = 0.8) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = event => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = Math.min(maxWidth / img.width, 1);
                        const width = img.width * scale;
                        const height = img.height * scale;
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // üß© Khi ch·ªçn file ho·∫∑c d√°n ·∫£nh t·ª´ clipboard
        // Khi ch·ªçn file: ch·ªâ preview local, ch∆∞a upload
        // ‚úÖ G·∫Øn ƒë√∫ng handler duy nh·∫•t
        $(document).on('change', '.upload-container input[type="file"]', handleFiles);


        $(document).on('paste', '.upload-container', function (e) {
            const items = e.originalEvent.clipboardData.items;
            const files = [];
            for (const item of items) {
                if (item.kind === 'file') files.push(item.getAsFile());
            }
            if (files.length) handleFiles({target: {files}, currentTarget: this});
        });


        // ============================================================
        // üü¢ Khi ch·ªçn file (ch∆∞a upload ‚Äî preview local, c√≥ th·ªÉ nhi·ªÅu l·∫ßn)
        // ============================================================
        // M·ªü file picker
        $(document).on('click', '.upload-placeholder', function () {
            $(this).siblings('input[type="file"]').trigger('click');
        });

        async function handleFiles(e) {
            const files = e.target.files || [];
            const $container = $(e.currentTarget).closest('.upload-container');
            const $preview = $container.find('.preview-container');
            const existingCount = $preview.find('.preview-item').length;
            const maxImages = 10;

            // Ki·ªÉm tra gi·ªõi h·∫°n
            if (existingCount + files.length > maxImages) {
                toastError(`‚ö†Ô∏è T·ªëi ƒëa ${maxImages} ·∫£nh cho m·ªói bi·∫øn th·ªÉ.`);
                return;
            }

            // Validate ƒë·ªãnh d·∫°ng & dung l∆∞·ª£ng
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    toastError(`‚ùå "${file.name}" kh√¥ng ph·∫£i l√† t·ªáp ·∫£nh h·ª£p l·ªá!`);
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    toastError(`‚ö†Ô∏è ·∫¢nh "${file.name}" v∆∞·ª£t qu√° 5MB, vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n.`);
                    return;
                }
            }

            // N·∫øu ch∆∞a c√≥ danh s√°ch file l∆∞u t·∫°m ‚Üí kh·ªüi t·∫°o
            let allFiles = $container.data('files') || [];

            // Th√™m file m·ªõi
            Array.from(files).forEach((file, idx) => {
                const imgUrl = URL.createObjectURL(file);
                const fileIndex = allFiles.length; // ƒë√°nh index tƒÉng d·∫ßn

                // Append ·∫£nh v√†o tr∆∞·ªõc placeholder
                $container.find('.upload-placeholder').before(`
          <div class="preview-item" draggable="true" data-file-index="${fileIndex}">
            <img src="${imgUrl}" alt="">
            <button type="button" class="btn-set-cover" title="ƒê·∫∑t l√†m ·∫£nh ch√≠nh">
              <i class="fas fa-star"></i>
            </button>
            <button type="button" class="btn-remove-image">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `);

                allFiles.push(file);
            });

            // C·∫≠p nh·∫≠t danh s√°ch file t·∫°m
            $container.data('files', allFiles);

            // Reset input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng input nhi·ªÅu l·∫ßn
            e.target.value = '';

            // N·∫øu ƒë·∫°t gi·ªõi h·∫°n ‚Üí ·∫©n placeholder
            if ($preview.find('.preview-item').length >= maxImages) {
                $container.find('.upload-placeholder').hide();
            } else {
                $container.find('.upload-placeholder').show();
            }

            console.log(`üñº T·ªïng s·ªë ·∫£nh hi·ªán t·∫°i: ${$preview.find('.preview-item').length}`);
        }

        // ============================================================
        // ‚≠ê 2Ô∏è‚É£ Ch·ªçn ·∫£nh b√¨a (local ‚Äî ch·ªâ c·∫≠p nh·∫≠t giao di·ªán & flag)
        // ============================================================
        $(document).on('click', '.btn-set-cover', function () {
            const $this = $(this);
            const $container = $this.closest('.upload-container');

            // Ch·ªâ cho ph√©p 1 ·∫£nh b√¨a m·ªói m√†u
            $container.find('.btn-set-cover').removeClass('active').attr('title', 'ƒê·∫∑t l√†m ·∫£nh ch√≠nh');
            $container.find('.preview-item').removeAttr('data-cover');

            // K√≠ch ho·∫°t ·∫£nh n√†y l√†m b√¨a
            $this.addClass('active').attr('title', '·∫¢nh ch√≠nh');
            $this.closest('.preview-item').attr('data-cover', 'true');

            console.log('‚≠ê ƒê√£ ch·ªçn ·∫£nh b√¨a local.');
        });

        // ============================================================
        // ‚ùå 3Ô∏è‚É£ X√≥a ·∫£nh preview local
        // ============================================================
        // ‚úÖ X√≥a ·∫£nh local ho·∫∑c server (c√≥ confirm)
        $(document).on('click', '.btn-remove-image', async function (e) {
            e.stopPropagation();
            const $item = $(this).closest('.preview-item');
            const imgId = $(this).data('id');
            const $container = $(this).closest('.upload-container');

            if (imgId) {
                const confirmDel = confirm('üóë B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y kh·ªèi server kh√¥ng?');
                if (!confirmDel) return;

                try {
                    await axios.delete(`/api/san-pham-mau-anh/${imgId}`);
                    toastSuccess('‚úÖ ƒê√£ x√≥a ·∫£nh tr√™n server.');
                } catch (err) {
                    toastError('‚ùå Kh√¥ng th·ªÉ x√≥a ·∫£nh tr√™n server!');
                    console.error(err);
                    return;
                }
            }

            $item.remove();
            if ($container.find('.preview-item').length === 0) {
                $container.find('.upload-placeholder').show();
                $container.find('input[type="file"]').val('');
            }
        });


        // ============================================================
        // ‚≠ê S·ª± ki·ªán ch·ªçn ·∫£nh b√¨a trong giao di·ªán preview
        // ============================================================
        $(document).on('click', '.btn-set-cover', async function () {
            const $btn = $(this);
            const $container = $btn.closest('.upload-container');
            const imgId = $btn.data('id'); // ch·ªâ c√≥ n·∫øu ·∫£nh ƒë√£ t·ªìn t·∫°i tr√™n server

            // ƒê·∫£m b·∫£o ch·ªâ c√≥ 1 ·∫£nh b√¨a trong c√πng container
            $container.find('.btn-set-cover').removeClass('active').attr('title', 'ƒê·∫∑t l√†m ·∫£nh ch√≠nh');
            $container.find('.preview-item').removeAttr('data-cover');
            $btn.addClass('active').attr('title', '·∫¢nh ch√≠nh');
            $btn.closest('.preview-item').attr('data-cover', 'true');

            // N·∫øu l√† ·∫£nh server -> c·∫≠p nh·∫≠t ·∫£nh b√¨a ngay
            if (imgId) {
                try {
                    await axios.put(`/api/san-pham-mau-anh/${imgId}/cover`);
                    console.log('‚≠ê ƒê√£ c·∫≠p nh·∫≠t ·∫£nh b√¨a (server).');
                } catch (err) {
                    console.error('‚ùå L·ªói c·∫≠p nh·∫≠t ·∫£nh b√¨a:', err);
                    alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ·∫£nh b√¨a!');
                }
            }
        });


        // ============================================================
        // üíæ H√†m global: Upload to√†n b·ªô ·∫£nh local sau khi l∆∞u s·∫£n ph·∫©m
        // ============================================================
        async function uploadAllImagesAfterSave(sanPhamId) {
            const jobs = [];

            $('.upload-container').each(function () {
                const $container = $(this);
                const mauSacId = +($container.closest('tr').data('mau-id') || 0);
                const $items = $container.find('.preview-item');
                const filesArr = $container.data('files') || [];

                $items.each(function () {
                    const $item = $(this);
                    const btn = $item.find('.btn-set-cover');
                    const serverId = btn.data('id');
                    const isCover = $item.attr('data-cover') === 'true';
                    const idx = +($item.data('file-index'));
                    const file = filesArr[idx];

                    if (serverId) {
                        // N·∫øu ·∫£nh ƒë√£ tr√™n server ‚Üí ch·ªâ c·∫≠p nh·∫≠t cover n·∫øu c·∫ßn
                        if (isCover) {
                            const p = axios.put(`/api/san-pham-mau-anh/${serverId}/cover`)
                                .then(() => console.log('‚≠ê ƒê√£ set cover cho ·∫£nh server:', serverId))
                                .catch(err => console.error('‚ùå L·ªói set cover server:', err));
                            jobs.push(p);
                        }
                    } else if (file) {
                        // ·∫¢nh local ‚Üí upload th·∫≠t
                        const formData = new FormData();
                        formData.append('sanPhamId', sanPhamId);
                        formData.append('mauSacId', mauSacId);
                        formData.append('file', file);
                        formData.append('laAnhBia', isCover);
                        formData.append('thuTu', $item.data('thu-tu') || idx);

                        const p = axios.post('/api/san-pham-mau-anh/upload', formData, {
                            headers: {'Content-Type': 'multipart/form-data'}
                        }).then(res => {
                            console.log(`üì§ Uploaded ${isCover ? '[‚≠ê b√¨a]' : ''}:`, res.data);
                            btn.attr('data-id', res.data.id);
                        }).catch(err => console.error('‚ùå L·ªói upload ·∫£nh local:', err));

                        jobs.push(p);
                    }
                });
            });

            await Promise.allSettled(jobs);
            console.log('‚úÖ Ho√†n th√†nh upload ·∫£nh + c·∫≠p nh·∫≠t b√¨a.');
        }


        // ============================================================
        // üîÑ K√âO‚ÄìTH·∫¢ REORDER ·∫¢NH (DRAG & DROP)
        // ============================================================
        let draggedImg = null;

        $(document).on('dragstart', '.preview-item', function (e) {
            draggedImg = this;
            $(this).addClass('dragging');
            e.originalEvent.dataTransfer.effectAllowed = 'move';
        });

        $(document).on('dragend', '.preview-item', function () {
            $(this).removeClass('dragging');
            const $container = $(this).closest('.upload-container');
            $container.find('.preview-item').each(function (index) {
                $(this).attr('data-thu-tu', index);
            });
        });

        $(document).on('dragover', '.preview-container', function (e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(this, e.clientX);
            const draggable = document.querySelector('.dragging');
            if (afterElement == null) {
                this.appendChild(draggable);
            } else {
                this.insertBefore(draggable, afterElement);
            }
        });

        function getDragAfterElement(container, x) {
            const elements = [...container.querySelectorAll('.preview-item:not(.dragging)')];
            return elements.reduce(
                (closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = x - box.left - box.width / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return {offset: offset, element: child};
                    } else {
                        return closest;
                    }
                },
                {offset: Number.NEGATIVE_INFINITY}
            ).element;
        }

        // ============================================================
        // üåê N√öT ‚ÄúT·∫¢I T·ª™ URL‚Äù (d√°n link ·∫£nh tr·ª±c ti·∫øp)
        // ============================================================
        $(document).on('dblclick', '.upload-container', async function (e) {
            if (isPromptOpen) return; // üîí NgƒÉn g·ªçi l·∫°i n·∫øu ƒëang m·ªü prompt
            isPromptOpen = true;

            const $container = $(this);
            const mauSacId = +($container.closest('tr').data('mau-id') || 0);

            const url = prompt('üîó Nh·∫≠p URL ·∫£nh ƒë·ªÉ t·∫£i v·ªÅ:');
            if (!url || !url.trim()) {
                isPromptOpen = false; // üîì M·ªü kh√≥a l·∫°i n·∫øu ng∆∞·ªùi d√πng cancel
                return;
            }

            try {
                // 1Ô∏è‚É£ T·∫£i blob t·ª´ URL
                const res = await fetch(url);
                const blob = await res.blob();

                // 2Ô∏è‚É£ G·ª≠i blob n√†y l√™n server
                const formData = new FormData();
                formData.append("sanPhamId", finalSanPhamId);
                formData.append("mauSacId", mauSacId);
                formData.append("file", blob, "from-url.jpg");
                formData.append("laAnhBia", false);
                formData.append("thuTu", $container.find('.preview-item').length);

                const uploadRes = await axios.post("/api/san-pham-mau-anh/upload", formData, {
                    headers: {"Content-Type": "multipart/form-data"}
                });

                const imgId = uploadRes.data.id;
                const imgUrl = uploadRes.data.duongDan;

                // 3Ô∏è‚É£ Render preview c√≥ data-id
                $container.find('.preview-container').append(`
            <div class="preview-item" draggable="true">
                <img src="${imgUrl}" alt="">
                <button type="button" class="btn-set-cover" data-id="${imgId}" title="ƒê·∫∑t l√†m ·∫£nh ch√≠nh">
                    <i class="fas fa-star"></i>
                </button>
                <button type="button" class="btn-remove-image" data-id="${imgId}">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `);
                $container.find('.upload-placeholder').hide();

                console.log('‚úÖ ƒê√£ t·∫£i v√† l∆∞u ·∫£nh URL v√†o SQL:', imgUrl);
            } catch (err) {
                alert('‚ùå Kh√¥ng th·ªÉ t·∫£i ·∫£nh t·ª´ URL n√†y!');
                console.error(err);
            } finally {
                isPromptOpen = false; // üîì Lu√¥n m·ªü kh√≥a l·∫°i sau khi ho√†n t·∫•t
            }
        });


        // ============================================================
        // üü¶ 12Ô∏è‚É£ K√âO NGANG TRONG KHUNG UPLOAD ·∫¢NH
        // ============================================================
        $(document).on('mousedown', '.upload-container', function (e) {
            if ($(e.target).closest('.btn-remove-image').length) return;

            const $this = $(this);
            const startX = e.pageX - $this.offset().left;
            const scrollLeft = $this.scrollLeft();
            let isDown = true;

            $this.addClass('dragging');

            $(document).on('mousemove.dragscroll', function (e2) {
                if (!isDown) return;
                e2.preventDefault();
                const x = e2.pageX - $this.offset().left;
                const walk = (x - startX) * 1.5;
                $this.scrollLeft(scrollLeft - walk);
            });

            $(document).on('mouseup.dragscroll mouseleave.dragscroll', function () {
                isDown = false;
                $(document).off('.dragscroll');
                $this.removeClass('dragging');
            });
        });

        $(document).on('dragstart', '.upload-container img', function (e) {
            e.preventDefault();
            return false;
        });

        // ============================================================
        // üü¢ Reload ·∫£nh t·ª´ API (n·∫øu mu·ªën hi·ªÉn th·ªã l·∫°i sau khi l∆∞u)
        // ============================================================
        // ‚úÖ Reload ·∫£nh hi·ªáu qu·∫£ h∆°n (1 request duy nh·∫•t)
        async function reloadApiImagesForAllRows(sanPhamId) {
            const res = await axios.get(`/api/san-pham-mau-anh/by-san-pham/${sanPhamId}`);
            const allImgs = res.data || [];

            $('#table-variants tr').each(function () {
                const $row = $(this);
                const $container = $row.find('.upload-container');
                if (!$container.length) return;

                const mauSacId = Number($row.data('mau-id')) || null;
                const list = allImgs.filter(img => img.mauSacId === mauSacId);
                const $preview = $container.find('.preview-container');
                $preview.empty();

                if (!list.length) {
                    $container.find('.upload-placeholder').show();
                    return;
                }

                $container.find('.upload-placeholder').hide();
                list.forEach(img => {
                    $preview.append(`
                <div class="preview-item" draggable="true" data-thu-tu="${img.thuTu}">
                    <img src="${img.duongDan}" alt="">
                    <button type="button" class="btn-set-cover ${img.laAnhBia ? 'active' : ''}"
                            data-id="${img.id}" title="${img.laAnhBia ? '·∫¢nh ch√≠nh' : 'ƒê·∫∑t l√†m ·∫£nh ch√≠nh'}">
                        <i class="fas fa-star"></i>
                    </button>
                    <button type="button" class="btn-remove-image" data-id="${img.id}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
                });
            });
        }



        // ============================================================
        // üü• 13Ô∏è‚É£ POPUP TH√äM M·ªöI M√ÄU S·∫ÆC (C√ì COLOR PICKER)
        // ============================================================
        let currentAttrType = null; // üîπ khai b√°o global

        // Khi m·ªü popup th√™m nhanh
        $(document).on('click', '.btn-add-icon', function (e) {
            e.preventDefault();

            const id = $(this).attr('id');
            const attr = id.replace('btn-add-', '');
            currentAttrType = attr;

            const labelMap = {
                'thuongHieu': 'Th∆∞∆°ng hi·ªáu',
                'danhMuc': 'Danh m·ª•c',
                'chatLieu': 'Ch·∫•t li·ªáu',
                'deGiay': 'ƒê·∫ø gi√†y',
                'mauSac': 'M√†u s·∫Øc',
                'kichCo': 'K√≠ch c·ª°'
            };

            // üßπ Reset popup tr∆∞·ªõc khi hi·ªÉn th·ªã
            $('#attrColorNameInput').val('');
            $('#attrStatusInput').val('').data('id', null);
            $('#colorPickerSection').hide();
            $('#colorInfoSection').hide();

            // üßπ Reset dropdown tr·∫°ng th√°i (b·ªè s√°ng)
            $('#attrStatusList .dropdown-item').removeClass('selected');
            $('#attrStatusList .dropdown-item i')
                .removeClass('fa-check-square text-primary')
                .addClass('fa-square');

            // üè∑Ô∏è ƒê·∫∑t ti√™u ƒë·ªÅ popup
            $('#quickModalTitle').text('Th√™m ' + (labelMap[attr] || 'Thu·ªôc t√≠nh m·ªõi'));

            // üñåÔ∏è N·∫øu l√† M√†u s·∫Øc
            if (attr === 'mauSac') {
                $('#colorPickerSection').show();
                $('#colorInfoSection').show();

                $('#colorInfoSection label[for="attrColorNameInput"]').text('T√™n m√†u s·∫Øc:');
                $('#attrColorNameInput').attr('placeholder', 'Nh·∫≠p t√™n m√†u s·∫Øc...');

                const defaultColor = '#000000';
                updateColorSelection(defaultColor);
            }
            // üß© N·∫øu l√† c√°c thu·ªôc t√≠nh kh√°c
            else {
                $('#colorInfoSection').show();
                $('#colorPickerSection').hide();

                const tenLabel = 'T√™n ' + labelMap[attr].toLowerCase() + ':';
                $('#colorInfoSection label[for="attrColorNameInput"]').text(tenLabel);
                $('#attrColorNameInput').attr('placeholder', 'Nh·∫≠p ' + labelMap[attr].toLowerCase() + '...');
            }

            // üé¨ Hi·ªÉn th·ªã popup
            $('#quickAddModal').addClass('show').hide().fadeIn(150);
        });


        // ===============================
        // üé® B·∫¢NG CH·ªåN M√ÄU T√ôY CH·ªàNH
        // ===============================
        $(document).on('click', '#quickAddModal #selectedColorBox', function (e) {
            e.stopPropagation();
            $('#customColorPalette').fadeToggle(120);
        });


        $(document).on('click', function (e) {
            if (!$(e.target).closest('#quickAddModal #customColorPalette, #quickAddModal #selectedColorBox').length) {
                $('#quickAddModal #customColorPalette').fadeOut(100);
            }
        });


        // üîπ Ch·ªçn m√†u t·ª´ √¥ b·∫£ng
        $(document).on('click', '#quickAddModal .color-item', function () {
            const color = $(this).data('color').toUpperCase();
            updateColorSelection(color);
        });

        // üîπ Ch·ªçn m√†u t·ª± do t·ª´ input type=color
        $(document).on('input', '#colorFreePicker', function () {
            const color = $(this).val().toUpperCase();
            updateColorSelection(color);
        });

        // üîπ Nh·∫≠p th·ªß c√¥ng m√£ hex
        $(document).on('input', '#colorHexDisplay', function () {
            let val = $(this).val().trim();
            if (!val.startsWith('#')) val = '#' + val;
            if (/^#[0-9A-F]{6}$/i.test(val)) {
                updateColorSelection(val.toUpperCase());
            }
        });

        // H√†m c·∫≠p nh·∫≠t to√†n b·ªô UI
        // Debounce nh·ªè ƒë·ªÉ tr√°nh spam khi g√µ
        let __colorUpdateTimer = null;

        // H√†m c·∫≠p nh·∫≠t to√†n b·ªô UI + t√™n m√†u theo map/g·∫ßn nh·∫•t
        function updateColorSelection(inputColor) {
            clearTimeout(__colorUpdateTimer);
            __colorUpdateTimer = setTimeout(() => {
                // Chu·∫©n ho√° m√£ HEX: th√™m # n·∫øu thi·∫øu, upper, ch·ªâ 6 k√Ω t·ª±
                let color = (inputColor || '').trim().toUpperCase();
                if (!color.startsWith('#')) color = '#' + color;
                // N·∫øu #RGB ‚Üí chuy·ªÉn sang #RRGGBB
                if (/^#[0-9A-F]{3}$/i.test(color)) {
                    color = '#' + color.slice(1).split('').map(ch => ch + ch).join('');
                }
                // Ch·ªâ ch·∫•p nh·∫≠n #RRGGBB, n·∫øu sai th√¨ gi·ªØ nguy√™n UI c≈©, kh√¥ng crash
                if (!/^#[0-9A-F]{6}$/i.test(color)) {
                    $('#colorHexDisplay').val(inputColor || '');
                    $('#attrColorInput').val(inputColor || '');
                    return;
                }

                // C·∫≠p nh·∫≠t UI
                $('#selectedColorBox').css('background', color);
                $('#colorHexDisplay').val(color);
                $('#attrColorInput').val(color);

                // C·∫≠p nh·∫≠t t√™n m√†u: ∆∞u ti√™n map, n·∫øu kh√¥ng c√≥ th√¨ t√¨m g·∫ßn nh·∫•t
                let colorName = (window.colorNameMap && colorNameMap[color]) || null;
                if (!colorName && window.colorNameMap && Object.keys(colorNameMap).length) {
                    const nearest = findNearestColorName(color, colorNameMap);
                    colorName = nearest.name + ' (‚âà ' + nearest.hex + ')';
                }
                $('#colorCodeDisplay').text(color);
                if (colorName) $('#colorNameDisplay').text(colorName);
            }, 120);
        }


        // ===============================
        // üü™ MAP M√É M√ÄU ‚Üí T√äN TI·∫æNG VI·ªÜT
        // ===============================

        let colorNameMap = {};
        let __COLOR_MAP_LOADED__ = false;

        async function loadColorMap() {
            if (__COLOR_MAP_LOADED__) return; // tr√°nh load l·∫°i nhi·ªÅu l·∫ßn
            try {
                const res = await axios.get('/data/color-name-map.json');
                colorNameMap = res.data || {};
                __COLOR_MAP_LOADED__ = true;
                console.log('üé® ƒê√£ load b·∫£ng m√†u:', Object.keys(colorNameMap).length, 'm√†u');
            } catch (err) {
                console.error('‚ùå L·ªói load color-name-map.json:', err);
            }
        }


        async function loadColorMap() {
            try {
                const res = await axios.get('/data/color-name-map.json');
                colorNameMap = res.data;
                console.log('üé® ƒê√£ load b·∫£ng m√†u:', Object.keys(colorNameMap).length, 'm√†u');
            } catch (err) {
                console.error('‚ùå L·ªói load color-name-map.json:', err);
            }
        }

        $(document).on('input', '#attrColorInput', function () {
            updateColorSelection($(this).val());
        });


        // ===============================
        // üé® H√ÄM H·ªñ TR·ª¢ X·ª¨ L√ù M√ÄU
        // ===============================

        // Chuy·ªÉn m√£ HEX ‚Üí {r,g,b}
        function hexToRgb(hex) {
            const cleanHex = hex.replace('#', '');
            const bigint = parseInt(cleanHex, 16);
            return {
                r: (bigint >> 16) & 255,
                g: (bigint >> 8) & 255,
                b: bigint & 255
            };
        }

        // T√≠nh kho·∫£ng c√°ch gi·ªØa 2 m√†u RGB
        function colorDistance(c1, c2) {
            const dr = c1.r - c2.r;
            const dg = c1.g - c2.g;
            const db = c1.b - c2.b;
            return Math.sqrt(dr * dr + dg * dg + db * db);
        }

        // T√¨m t√™n m√†u g·∫ßn nh·∫•t trong b·∫£ng JSON
        function findNearestColorName(hexInput, map) {
            if (!map || Object.keys(map).length === 0) return 'Kh√¥ng x√°c ƒë·ªãnh';

            const inputRgb = hexToRgb(hexInput);
            let minDist = Infinity;
            let nearestName = 'Kh√¥ng x√°c ƒë·ªãnh';
            let nearestHex = null;

            for (const [hex, name] of Object.entries(map)) {
                const rgb = hexToRgb(hex);
                const dist = colorDistance(inputRgb, rgb);
                if (dist < minDist) {
                    minDist = dist;
                    nearestName = name;
                    nearestHex = hex;
                }
            }

            return {name: nearestName, hex: nearestHex, distance: minDist.toFixed(2)};
        }

        // ============================================================
        // üîπ H√ÄM CHU·∫®N H√ìA T√äN S·∫¢N PH·∫®M TR∆Ø·ªöC KHI D√ôNG TRONG MA_SPCT
        // ============================================================
        function normalizeName(name) {
            return name
                .trim()                       // b·ªè kho·∫£ng tr·∫Øng ƒë·∫ßu-cu·ªëi
                .replace(/\s+/g, ' ')          // g·ªôp nhi·ªÅu kho·∫£ng tr·∫Øng th√†nh 1
                .replace(/[^\p{L}\p{N}\s]/gu, '') // lo·∫°i b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát (gi·ªØ ch·ªØ & s·ªë)
                .replace(/\s+/g, '-')          // ƒë·ªïi kho·∫£ng tr·∫Øng c√≤n l·∫°i th√†nh d·∫•u g·∫°ch n·ªëi
                .toUpperCase();                // vi·∫øt hoa cho ƒë·ªìng nh·∫•t
        }

        // ============================================================
        // üü¢ N√öT L∆ØU S·∫¢N PH·∫®M (T·∫†O M·ªöI HO·∫∂C C·∫¨P NH·∫¨T + G·ªòP BI·∫æN TH·ªÇ)
        // ============================================================
        // ============================================================
        // üü¢ N√öT L∆ØU S·∫¢N PH·∫®M (T·∫†O M·ªöI HO·∫∂C C·∫¨P NH·∫¨T + AUDIT FIELD)
        // ============================================================
        // ============================================================
        // üü¢ N√öT L∆ØU S·∫¢N PH·∫®M (T·∫†O M·ªöI HO·∫∂C C·∫¨P NH·∫¨T + AUDIT FIELD)
        // ============================================================
        $('#btn-save-product').off('click').on('click', async function () {
            try {
                const gioiTinhValue = $('#gioiTinhInput').data('id') ?? 2;
                const tenSanPham = $('#tenSanPhamInput').val().trim();

                if (!tenSanPham) {
                    alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m!');
                    return;
                }

                const allRows = $('#table-variants tr.variant-row[data-mau-id]');
                if (!allRows.length) {
                    alert('‚ö†Ô∏è Ch∆∞a c√≥ bi·∫øn th·ªÉ n√†o ƒë·ªÉ l∆∞u!');
                    return;
                }

                // üîπ N·∫øu s·∫£n ph·∫©m ch∆∞a c√≥ ID ‚Üí t·∫°o m·ªõi
                const selectedId = $('#tenSanPhamInput').data('id');
                if (selectedId) {
                    finalSanPhamId = selectedId;
                }

                if (!finalSanPhamId) {
                    const dataCreate = {
                        tenSanPham,
                        moTa: $('#moTa').val(),
                        thuongHieuId: $('#thuongHieuInput').data('id') || null,
                        danhMucId: $('#danhMucInput').data('id') || null,
                        chatLieuId: $('#chatLieuInput').data('id') || null,
                        deGiayId: $('#deGiayInput').data('id') || null,
                        gioiTinh: gioiTinhValue,
                        trangThai: $('#trangThaiInput').data('id') ?? 1,
                        ...buildAuditFields(true)
                    };

                    const resCreate = await axios.post('/api/san-pham/create', dataCreate);
                    finalSanPhamId = resCreate.data.id;
                    console.log('üÜï ƒê√£ t·∫°o m·ªõi s·∫£n ph·∫©m ID =', finalSanPhamId);
                }

                // ====================================================
                // üîπ Ph√¢n lo·∫°i bi·∫øn th·ªÉ: T·∫°o m·ªõi ho·∫∑c C·∫≠p nh·∫≠t
                // ====================================================
                const reqsCreate = [];
                const reqsUpdate = [];

                allRows.each(function () {
                    const $r = $(this);
                    const id = $r.data('id'); // c√≥ th·ªÉ l√† 3-1 (t·∫°m) ho·∫∑c s·ªë th·∫≠t t·ª´ DB
                    const mauSacId = +$r.data('mau-id');
                    const kichCoId = +$r.data('size-id');
                    const soLuongTon = +($r.find('.input-slt').val() || 0);
                    const giaBan = +($r.find('.input-giaban').val().replace(/[^\d]/g, '') || 0);
                    const trangThai = +($r.find('td[data-value]').data('value') ?? 1);

                    const base = {
                        sanPhamId: finalSanPhamId,
                        mauSacId,
                        kichCoId,
                        soLuongTon,
                        giaBan,
                        trangThai,
                        gioiTinh: gioiTinhValue
                    };

                    // üß† Ch·ªâ g·ª≠i id n·∫øu th·∫≠t l√† s·ªë (lo·∫°i b·ªè id t·∫°m ki·ªÉu "3-1")
                    if (id && !isNaN(Number(id))) {
                        reqsUpdate.push({id: Number(id), ...base, ...buildAuditFields(false)});
                    } else {
                        reqsCreate.push({...base, ...buildAuditFields(true)});
                    }
                });

                console.log('üì¶ CREATE:', reqsCreate);
                console.log('üì¶ UPDATE:', reqsUpdate);

                // ====================================================
                // üì§ G·ª≠i API ƒë·ªìng th·ªùi (n·∫øu c√≥)
                // ====================================================
                if (reqsCreate.length)
                    await axios.post('/api/san-pham-chi-tiet/bulk-create', reqsCreate, {
                        headers: {'X-Admin-Name': localStorage.getItem('adminName') || 'ADMIN'}
                    });

                if (reqsUpdate.length)
                    await axios.put('/api/san-pham-chi-tiet/bulk-update', reqsUpdate, {
                        headers: {'X-Admin-Name': localStorage.getItem('adminName') || 'ADMIN'}
                    });

                alert('‚úÖ ƒê√£ l∆∞u s·∫£n ph·∫©m v√† bi·∫øn th·ªÉ th√†nh c√¥ng!');
                console.log('‚úÖ L∆∞u ho√†n t·∫•t!');
                // N·∫øu mu·ªën: await reloadApiImagesForAllRows(finalSanPhamId);
                // üß© Sau khi l∆∞u SPCT th√†nh c√¥ng, ti·∫øn h√†nh upload ·∫£nh
                await uploadAllImagesAfterSave(finalSanPhamId);

                // üü¢ Hi·ªÉn th·ªã l·∫°i ·∫£nh ƒë√£ upload t·ª´ server
                await reloadApiImagesForAllRows(finalSanPhamId);

                toastSuccess('‚úÖ ƒê√£ l∆∞u s·∫£n ph·∫©m v√† ·∫£nh th√†nh c√¥ng!');


            } catch (error) {
                console.error('‚ùå L·ªói khi l∆∞u s·∫£n ph·∫©m:', error);

                if (error.response) {
                    console.error('üß© Response data:', error.response.data);
                    console.error('üß© Status:', error.response.status);
                    alert(`‚ùå API l·ªói: ${error.response.status} - ${error.response.data?.message || 'Xem console ƒë·ªÉ bi·∫øt th√™m'}`);
                } else if (error.request) {
                    alert('‚ö†Ô∏è Server kh√¥ng ph·∫£n h·ªìi!');
                } else {
                    alert(`‚ö†Ô∏è L·ªói kh√¥ng x√°c ƒë·ªãnh: ${error.message}`);
                }
            }
        });


    </script>

</div>
</body>

</html>