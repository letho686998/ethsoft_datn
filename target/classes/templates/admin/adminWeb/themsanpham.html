<!DOCTYPE html>
<html lang="vi" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{admin/layout/Layout}">

<head>
    <title layout:title="Th√™m s·∫£n ph·∫©m"></title>

    <style>

        html {
            height: 100%;
            scrollbar-gutter: unset;
        }

        /*html,*/
        /*body {*/
        /*    height: 100%;*/
        /*    background-color: #f4f6f9;*/
        /*    overflow: hidden;*/
        /*    !* ngƒÉn cu·ªôn to√†n trang *!*/
        /*}*/

        /* ‚úÖ Cho ph√©p body cu·ªôn th·∫≠t */
        /*.layout-fixed .content-wrapper {*/
        /*    overflow: visible !important;*/
        /*}*/

        /* ‚úÖ Body ch·ªãu tr√°ch nhi·ªám cu·ªôn */
        body {
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Custom scrollbar ƒë·∫πp */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.35);
        }


        .page-content-section {
            height: auto; /* tr√°nh m√¢u thu·∫´n v·ªõi fixed b√™n tr√™n */
            min-height: 100%; /* ho·∫∑c b·ªè h·∫≥n thu·ªôc t√≠nh height c≈© */
        }


        .card {
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            background: #fff;
        }

        .card-header {
            background: linear-gradient(135deg, #007bff, #14F5F1);
            color: #fff;
            padding: 8px 15px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .card-header h6 {
            font-weight: 600;
            margin: 0;
            font-size: 1rem;
        }

        .form-label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .form-control,
        .dropdown-input {
            height: 36px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .dropdown-input {
            background: #fff;
            cursor: pointer;
        }

        /* üîπ H√†ng ch·ª©a √¥ input v√† n√∫t + */
        .input-with-btn {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* üîπ N√∫t d·∫•u c·ªông ‚Äì h√¨nh vu√¥ng, n·∫±m ngo√†i b√™n ph·∫£i */
        .btn-add-icon {
            width: 36px;
            height: 36px;
            border: 1.5px solid #007bff;
            background: #f0f8ff;
            color: #007bff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-add-icon:hover {
            background: #14F5F1;
            color: #fff;
            transform: scale(1.05);
        }

        /* Hai khung tr√™n c√πng chia ƒë√¥i */
        .top-row {
            display: grid;
            grid-template-columns: 1fr 1fr;  /* hai c·ªôt ƒë·ªÅu nhau */
            gap: 15px;
            margin-bottom: 15px;
        }

        .top-row .card {
            flex: 1;
        }

        /* B·∫£ng chi ti·∫øt s·∫£n ph·∫©m */

        table th {
            background: #f8f9fa;
            text-align: center;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        table td {
            text-align: center;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        /* ‚úÖ Gi·ªØ b·∫£ng c√≥ b·ªë c·ª•c c·ªë ƒë·ªãnh */
        .table {
            table-layout: fixed; /* b·∫Øt bu·ªôc ƒë·ªÉ width: px c√≥ hi·ªáu l·ª±c ƒë·ªÅu */
            width: 100%;
        }

        /* ‚úÖ C·ªë ƒë·ªãnh chi·ªÅu r·ªông t·ª´ng c·ªôt */
        .table th:nth-child(1) {
            width: 20px;   /* Box ch·ªçn */
        }

        .table th:nth-child(2) {
            width: 50px;   /* STT */
        }

        .table th:nth-child(3) {
            width: 165px;  /* T√™n s·∫£n ph·∫©m */
        }

        .table th:nth-child(4) {
            width: 85px;  /* M√†u s·∫Øc */
        }

        .table th:nth-child(5) {
            width: 75px;  /* K√≠ch c·ª° */
        }

        .table th:nth-child(6) {
            width: 95px;   /* SLT */
        }

        .table th:nth-child(7) {
            width: 100px;  /* Gi√° nh·∫≠p */
        }

        .table th:nth-child(8) {
            width: 100px;  /* Gi√° b√°n */
        }

        .table th:nth-child(9) {
            width: 95px;   /* Thao t√°c */
        }

        .table th:nth-child(10) {
            width: 365px;  /* ·∫¢nh s·∫£n ph·∫©m */
        }

        section[layout\:fragment="content"] {
            position: fixed !important;
            top: 70px !important;         /* ƒë√∫ng chi·ªÅu cao header th·ª±c t·∫ø */
            left: 250px !important;       /* ƒë√∫ng chi·ªÅu r·ªông sidebar */
            right: 0 !important;          /* thay cho width calc(...) */
            bottom: 0 !important;         /* thay cho height calc(...) */
            box-sizing: border-box !important; /* padding kh√¥ng l√†m tr√†n */
            overflow-y: auto !important;
            overflow-x: hidden !important;
            padding: 15px 25px !important;
            background: #f4f6f9 !important;
        }


        .save-container {
            position: absolute;
            bottom: 10px;
            right: 15px;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.25s ease;
            padding: 6px 14px;
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.25);
        }

        /* ‚≠êÔ∏è B·ªë c·ª•c d·ªçc: kho·∫£ng c√°ch gi·ªØa c√°c section = 15px, tuy·ªát ƒë·ªëi, kh√¥ng collapse */
        .section-stack {
            display: grid;
            row-gap: 16px;
            /* ch·ªâ s·ªë b·∫°n mu·ªën = ƒë√∫ng b·∫±ng gap gi·ªØa 2 card */
        }

        /* Gi·ªØ gap ngang gi·ªØa 2 card, b·ªè m·ªçi margin d·ªçc ƒë·ªÉ kh√¥ng c·ªông d·ªìn */
        .top-row {
            display: flex;
            gap: 15px;
            margin: 0 !important;
            /* xo√° margin d∆∞·ªõi */
            padding: 0 !important;
            /* b·ªè padding d∆∞·ªõi ƒë√£ th√™m tr∆∞·ªõc ƒë√≥ */
        }

        /* ƒê·∫£m b·∫£o c√°c card b√™n trong kh√¥ng c√≥ margin ‚Äúl·ª° tay‚Äù n√†o */
        .top-row>.card {
            margin: 0 !important;
        }

        /* B·∫£ng 3: KH√îNG margin-top; kho·∫£ng c√°ch do .section-stack qu·∫£n */
        .table-container {
            margin: 0 !important;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            padding: 10px 15px 50px;
            position: relative;
        }

        /* ===============================
   üîπ DROPDOWN CHUNG ‚Äì C√ÇN ƒê·ªêI ƒê·∫∏P M·∫ÆT
   =============================== */
        .dropdown-list {
            display: none;
            position: absolute;
            top: 38px;
            left: 0;
            width: 100%;
            background: #fff;
            border: 1px solid #d0d4da;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
            overflow-y: hidden;
            z-index: 3000;
            padding: 4px 0;
            /*transition: all 0.2s ease;*/
            opacity: 0;
            transform: translateY(-6px);
            transition: opacity 0.2s ease, transform 0.25s ease;
        }

        .dropdown-list.show {
            display: block !important;
            opacity: 1;
            transform: translateY(0);
            animation: fadeSlideDown 0.25s ease forwards;
        }

        /* üåø M·ª•c dropdown */
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #333;
            transition: all 0.15s ease;
        }

        /* üü¶ Bi·ªÉu t∆∞·ª£ng checkbox / tick */
        .dropdown-item i {
            font-size: 0.9rem;
            color: #888;
            min-width: 16px;
            text-align: center;
            margin-right: 8px;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        /* üü© Hi·ªáu ·ª©ng hover m∆∞·ª£t */
        .dropdown-item:hover {
            background: #f1f7ff;
            color: #007bff;
        }

        .dropdown-item:hover i {
            color: #007bff;
        }

        /* üü¢ Khi ƒë∆∞·ª£c ch·ªçn */
        .dropdown-item.selected {
            background: #e6f0ff;
            color: #001f3f;
            font-weight: 600;
        }

        .dropdown-item.selected i {
            color: #007bff;
            animation: tickPop 0.25s ease forwards;
            transform: scale(1);
            opacity: 1;
        }

        /* Khi b·ªè ch·ªçn th√¨ thu nh·ªè m∆∞·ª£t */
        .dropdown-item:not(.selected) i {
            transform: scale(0.9);
            opacity: 0.7;
        }

        /* ‚ú® D√≤ng ‚ÄúTh√™m m·ªõi‚Äù */
        .dropdown-item.add-new {
            font-style: italic;
            color: #007bff;
        }

        .dropdown-item.add-new:hover {
            background: #e8f0ff;
            color: #0056b3;
        }

        /* Gi·ªõi h·∫°n chi·ªÅu cao khi nhi·ªÅu m·ª•c */
        .dropdown-list.scrollable {
            max-height: 180px;
            overflow-y: auto;
        }

        /* Cu·ªôn thanh m·∫£nh, tinh t·∫ø */
        .dropdown-list::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-list::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.15);
            border-radius: 4px;
        }

        .dropdown-list::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 0, 0, 0.25);
        }

        @keyframes fadeSlideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Keyframes cho hi·ªáu ·ª©ng tick xu·∫•t hi·ªán */
        @keyframes tickPop {
            0% {
                transform: scale(0.4);
                opacity: 0;
            }

            60% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }


        /* üîπ Popup ch·ªçn m√†u s·∫Øc d·∫°ng grid */
        /* Popup ch·ªçn m√†u s·∫Øc d·∫°ng grid */
        .color-popup {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 10px;
            width: 100%;
            min-width: 240px;
            height: auto;
            overflow: hidden;
            /* quan tr·ªçng: ·∫©n tooltip khi ch∆∞a hover */
            z-index: 3000;
            transition: all 0.25s ease;
            animation: fadeIn 0.15s ease-in-out;
        }

        /* Khi hi·ªÉn th·ªã */
        .color-popup.show {
            display: flex;
        }

        /* Khi hover m√†u: popup m·ªü cao nh·∫π & n·ªïi l√™n */
        .color-popup.expanded {
            padding-bottom: 28px;
            /* ch·ª´a ch·ªó cho tooltip */
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
            overflow: visible;
            /* cho ph√©p tooltip hi·ªÉn th·ªã */
        }

        /* √î m√†u nh·ªè */
        .color-item {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 2px solid #fff;
            box-shadow: 0 0 0 1.5px #ccc;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        /* Hover: d√πng m√†u ch·ªß ƒë·∫°o xanh than */
        .color-item:hover {
            transform: scale(1.12);
            box-shadow: 0 0 0 2px #1E90FF;
        }

        /* Khi ƒë∆∞·ª£c ch·ªçn */
        .color-item.selected {
            box-shadow: 0 0 0 3px #1E90FF;
            transform: scale(1.1);
        }

        /* Tooltip hi·ªÉn th·ªã t√™n m√†u */
        .color-item::after {
            content: attr(title);
            position: absolute;
            bottom: -26px;
            left: 50%;
            transform: translateX(-50%);
            background: #001f3f;
            color: #fff;
            padding: 2px 8px;
            font-size: 0.75rem;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }

        /* Hi·ªán tooltip khi hover */
        .color-item:hover::after {
            opacity: 1;
        }



        /* Hi·ªáu ·ª©ng fade popup */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        #mauSacPopup {
            top: calc(100% + 6px);
            /* c√°ch input m·ªôt ƒëo·∫°n nh·ªè */
        }

        /* üîπ Popup ch·ªçn k√≠ch c·ª° d·∫°ng grid */
        .size-popup {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 10px;
            width: 100%;
            min-width: 240px;
            height: auto;
            overflow: hidden;
            z-index: 3000;
            transition: all 0.25s ease;
            animation: fadeIn 0.15s ease-in-out;
        }

        /* Khi hi·ªÉn th·ªã */
        .size-popup.show {
            display: flex;
        }

        /* Khi hover: m·ªü cao h∆°n nh·∫π */
        .size-popup.expanded {
            padding-bottom: 12px;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
            overflow: visible;
        }

        /* √î k√≠ch c·ª° vu√¥ng */
        .size-item {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 1.5px solid #ccc;
            background: #f9fafc;
            color: #001f3f;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* Hover */
        .size-item:hover {
            transform: scale(1.12);
            background: #e9f1ff;
            border-color: #001f3f;
        }

        /* Khi ch·ªçn */
        .size-item.selected {
            background: #001f3f;
            color: #fff;
            transform: scale(1.08);
            border-color: #001f3f;
        }

        /* üîπ N·ªÅn m·ªù popup */
        .quick-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(3px);
            z-index: 1055;
            justify-content: center;
            align-items: center;
        }

        /* Khi m·ªü popup */
        .quick-modal.show {
            display: flex;
        }

        /* N·ªôi dung popup */
        .quick-modal-content {
            background: #fff;
            border-radius: 14px;
            width: min(600px, 90vw);
            aspect-ratio: 1.618 / 1;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            padding: 20px 24px 65px;
            position: relative;
            animation: zoomIn 0.25s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        @keyframes zoomIn {
            from { transform: scale(0.85); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .quick-modal-content .modal-title {
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
            color: #001f3f;
            font-size: 1.05rem;
        }

        .quick-modal-content .modal-footer {
            position: absolute;
            bottom: 15px;
            right: 20px;
        }

        /* üîΩ Dropdown tr·∫°ng th√°i trong popup */
        /* üîΩ Dropdown tr·∫°ng th√°i trong popup th√™m nhanh */
        #attrStatusList {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            /*z-index: 9999;*/
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity 0.18s ease, transform 0.18s ease;
            overflow: visible !important;
            z-index: 99999 !important;
        }

        #attrStatusList.show {
            display: block !important; /* ‚úÖ c·∫ßn ƒë·ªÉ ghi ƒë√® display:none */
            opacity: 1 !important;;
            transform: translateY(0) !important;;
            /*display: block !important;*/
            /*opacity: 1 !important;*/
            /*transform: translateY(0) !important;*/
        }

        /* ‚úÖ FIX dropdown tr·∫°ng th√°i kh√¥ng hi·ªÉn th·ªã trong popup */
        #quickAddModal .dropdown {
            overflow: visible !important; /* Cho ph√©p list tr√†n ra ngo√†i khung */
            position: relative !important; /* Gi√∫p list ƒë·ªãnh v·ªã ch√≠nh x√°c */
        }

        #quickAddModal #attrStatusList {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            z-index: 99999 !important; /* lu√¥n n·ªïi tr√™n m·ªçi th·ª© */
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        #quickAddModal #attrStatusList.show {
            display: block !important;
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* ===================== üîπ UPLOAD CONTAINER STYLE (Shopee-like) ===================== */
        .upload-container {
            position: relative;
            border: 2px dashed #c7d3e3;
            border-radius: 10px;
            padding: 10px;
            background: #fafbfd;
            cursor: pointer;
            transition: all 0.25s ease;
            width: 355px; /* ‚úÖ v·ª´a cho 4 ·∫£nh */
            height: 100px; /* ‚úÖ c·ªë ƒë·ªãnh chi·ªÅu cao */
            display: flex;
            align-items: center;          /* ‚úÖ cƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
            justify-content: flex-start;  /* ‚úÖ ·∫£nh canh tr√°i trong khung */
            overflow-x: auto;             /* ‚úÖ cu·ªôn ngang khi nhi·ªÅu ·∫£nh */
            overflow-y: hidden;
            flex-wrap: nowrap;
            gap: 10px;
            margin: 0 auto;               /* ‚úÖ cƒÉn gi·ªØa khung trong c·ªôt */
            scroll-behavior: smooth;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch; /* iOS h·ªó tr·ª£ tr∆∞·ª£t m∆∞·ª£t */
        }
        .upload-container:hover {
            border-color: #007bff;
            background: #f1f7ff;
        }
        .upload-container input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-container::-webkit-scrollbar {
            height: 6px; /* ‚úÖ thanh k√©o ngang m·∫£nh */
        }
        .upload-container::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        .upload-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.4);
        }

        /* Placeholder khi ch∆∞a ch·ªçn ·∫£nh */
        .upload-placeholder {
            flex: 0 0 auto;
            width: 80px;
            height: 80px;
            min-width: 90px;
            border: 2px dashed #c7d3e3;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #7b8ca8;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            margin-left: -8px; /* ‚úÖ ƒë·∫£m b·∫£o s√°t tr√°i */
            order: 2;
        }
        .upload-placeholder i {
            font-size: 1.5rem;
            color: #007bff;
            margin-bottom: 4px;
        }
        .upload-placeholder:hover {
            border-color: #007bff;
            background: #eef6ff;
            color: #0056b3;
        }

        /* Preview ·∫£nh */
        .preview-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            overflow: visible;
            flex-shrink: 0;
            align-items: center; /* ‚úÖ cƒÉn gi·ªØa ·∫£nh trong khung */
            order: 1;
        }
        .preview-item {
            flex: 0 0 auto;
            width: 90px;
            height: 90px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #ddd;
            position: relative;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        /* N√∫t x√≥a ·∫£nh */
        .btn-remove-image {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .btn-remove-image:hover {
            background: rgba(255, 0, 0, 0.8);
        }

        /* ‚úÖ Khung ch√≠nh gi·ªØa trang */
        .page-wrapper {
            max-width: 1150px; /* ho·∫∑c b·∫•t k·ª≥ k√≠ch th∆∞·ªõc b·∫°n mu·ªën */
            margin: 0 auto;
            padding: 0 8px;
            box-sizing: border-box;
        }


        /* N·∫øu mu·ªën c√≥ kho·∫£ng c√°ch ƒë·ªÅu hai b√™n h∆°n (hi·ªáu ·ª©ng n·ªÅn l·ªô ra r√µ h∆°n) */
        @media (min-width: 1200px) {
            .page-wrapper {
                max-width: 1250px;  /* ho·∫∑c t√πy b·∫°n ch·ªçn */
            }
        }

        /* üåà Modern color picker box */
        .color-picker-box input[type="color"] {
            appearance: none;
            -webkit-appearance: none;
            border: none;
            cursor: pointer;
            width: 60px;
            height: 60px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .color-picker-box input[type="color"]:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        #quickAddForm {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            align-items: flex-start;
        }

        #quickAddForm > div {
            flex: 1;
        }

        #colorPickerSection {
            max-width: 220px;
        }

        #colorInfoSection {
            flex-grow: 1;
        }

        #colorInfoSection .form-label {
            font-size: 0.9rem;
        }

        #customColorPickerContainer {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        #selectedColorBox {
            width: 38px;
            height: 38px;
            border-radius: 6px;
            border: 2px solid #ccc;
            cursor: pointer;
            transition: transform 0.15s, border-color 0.15s;
        }
        #selectedColorBox:hover {
            transform: scale(1.1);
            border-color: #007bff;
        }

        #colorHexDisplay {
            width: 100px;
            font-size: 0.9rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 8px;
            font-family: monospace;
        }

        .color-palette {
            position: absolute;
            bottom: -160px; /* ƒê∆∞a xu·ªëng d∆∞·ªõi khung ch·ªçn */
            left: 0;
            background: #fff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: 250px;
            z-index: 50;
            display: none;
            animation: fadeIn 0.15s ease-in-out;
        }

        .color-palette-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }

        .color-item {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .color-item:hover {
            transform: scale(1.2);
            border-color: #000;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-3px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cursor-pointer {
            cursor: pointer;
        }

        /* ============================================================
   ‚úÖ HI·ªÜU ·ª®NG √î TICK GI·ªêNG DROPDOWN (CHO B·∫¢NG CHI TI·∫æT)
   ============================================================ */
        .table .row-select,
        #selectAllRows {
            font-size: 1rem;
            color: #888;
            cursor: pointer;
            transition: transform 0.15s ease, color 0.15s ease;
        }

        .table .row-select:hover,
        #selectAllRows:hover {
            color: #001f3f;
            transform: scale(1.15);
        }

        /* üü© Khi ƒë∆∞·ª£c ch·ªçn */
        .table .row-select.fa-check-square,
        #selectAllRows.fa-check-square {
            color: #007bff !important;
            animation: tickPop 0.25s ease;
        }

        /* üîπ Hi·ªáu ·ª©ng b·∫≠t tick gi·ªëng dropdown */
        @keyframes tickPop {
            0% {
                transform: scale(0.4);
                opacity: 0.4;
            }
            60% {
                transform: scale(1.25);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.1rem rgba(220,53,69,0.25);
        }
        .error-message {
            display: block;
            margin-top: 3px;
            font-size: 0.8rem;
        }

        .btn-group-right {
            display: flex;
            justify-content: flex-end; /* n·∫±m b√™n ph·∫£i */
            gap: 12px; /* kho·∫£ng c√°ch gi·ªØa 2 n√∫t */
            margin-bottom: 12px;
        }


        .gradient-flame-btn-crt,
        .gradient-flame-btn-cls{
            background-color: initial;

            border-radius: 8px;

            font-weight: 600;
            color: #2f3542;
            cursor: pointer;
            display: inline-block;
            outline: 0;
            overflow: hidden;
            padding: 6px 14px;
            pointer-events: auto;
            position: relative;
            text-align: center;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            vertical-align: top;
            white-space: nowrap;
            width: 100px;
            gap: 20px;
            z-index: 9;
            border: 0;
            transition: box-shadow .2s;
        }

        .gradient-flame-btn-crt{
            background-image: linear-gradient(135deg, #14F5F1, #007bff);
            box-shadow: rgba(0, 0, 0, 0.1) 0 2px 4px;
        }

        .gradient-flame-btn-cls{
            background-image: linear-gradient(135deg, #D4FF00, #FFFF00);
            box-shadow: #535714 0 2px 4px;
        }

        .gradient-flame-btn-crt:hover,
        .gradient-flame-btn-cls:hover{
            box-shadow: #25aaaa 0 3px 8px;
        }

        #btnGenerateVariants:disabled {
            background: #ccc !important;
            border: none;
            cursor: not-allowed;
        }

        .preview-item {
            position: relative;
        }
        .btn-set-cover {
            position: absolute;
            top: 5px;
            right: 30px;
            background: rgba(255,255,255,0.8);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .btn-set-cover.active {
            background: gold;
            color: white;
        }

        #tenSanPhamList {
            position: absolute;
            width: 100%;
            top: 100%;           /* n·∫±m ngay d∆∞·ªõi input */
            left: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }

        /* Dropdown danh s√°ch s·∫£n ph·∫©m */
        #tenSanPhamList {
            position: absolute;
            width: 100%;
            top: 100%;                  /* n·∫±m ngay d∆∞·ªõi input */
            left: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            transition: all 0.15s ease;
        }

        /* C√°c item trong danh s√°ch */
        #tenSanPhamList .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #tenSanPhamList .dropdown-item:hover {
            background: #f2f4f8;
        }

        /* Khi c√≥ thanh cu·ªôn ‚Äî t√πy ch·ªçn th√™m scrollbar ƒë·∫πp */
        #tenSanPhamList::-webkit-scrollbar {
            width: 6px;
        }
        #tenSanPhamList::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        #tenSanPhamList::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.35);
        }

        .fw-semibold-header {
            background: linear-gradient(135deg, #007bff, #14F5F1);
            border-radius: 8px;
            padding: 4px 10px;
            color: #fff; /* üîπ M√†u ch·ªØ tr·∫Øng */
            /*display: inline-block;*/
        }

    </style>
</head>

<body>
    <section layout:fragment="content" class="page-content-section">
        <div class="page-wrapper">
            <div class="section-stack">
                <div class="top-row">
                    <!-- üü© B·∫¢NG 1: TH√îNG TIN CHI TI·∫æT -->
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle"></i> Th√¥ng tin chi ti·∫øt</h6>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label">T√™n s·∫£n ph·∫©m</label>
                                    <div class="input-with-btn position-relative">
                                        <input type="text" class="form-control dropdown-input" id="tenSanPhamInput"
                                               placeholder="Nh·∫≠p ho·∫∑c ch·ªçn t√™n s·∫£n ph·∫©m...">
                                        <div class="dropdown-list" id="tenSanPhamList"></div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Th∆∞∆°ng hi·ªáu</label>
                                    <div class="input-with-btn position-relative">
                                        <input type="text" class="form-control dropdown-input" id="thuongHieuInput"
                                               placeholder="Ch·ªçn th∆∞∆°ng hi·ªáu" readonly>
                                        <button class="btn-add-icon" id="btn-add-thuongHieu"><i
                                                class="fas fa-plus"></i></button>
                                        <!-- üîΩ Th√™m dropdown-list t∆∞∆°ng ·ª©ng -->
                                        <div class="dropdown-list single-select" id="thuongHieuList"></div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Danh m·ª•c</label>
                                    <div class="input-with-btn position-relative">
                                        <input type="text" class="form-control dropdown-input" id="danhMucInput"
                                               placeholder="Ch·ªçn danh m·ª•c" readonly>
                                        <button class="btn-add-icon" id="btn-add-danhMuc"><i
                                                class="fas fa-plus"></i></button>
                                        <!-- üîΩ Th√™m dropdown-list t∆∞∆°ng ·ª©ng -->
                                        <div class="dropdown-list single-select" id="danhMucList"></div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Ch·∫•t li·ªáu</label>
                                    <div class="input-with-btn position-relative">
                                        <input type="text" class="form-control dropdown-input" id="chatLieuInput"
                                               placeholder="Ch·ªçn ch·∫•t li·ªáu" readonly>
                                        <button class="btn-add-icon" id="btn-add-chatLieu"><i
                                                class="fas fa-plus"></i></button>
                                        <!-- üîΩ Th√™m dropdown-list t∆∞∆°ng ·ª©ng -->
                                        <div class="dropdown-list single-select" id="chatLieuList"></div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">ƒê·∫ø gi√†y</label>
                                    <div class="input-with-btn position-relative">
                                        <input type="text" class="form-control dropdown-input" id="deGiayInput"
                                               placeholder="Ch·ªçn ƒë·∫ø gi√†y" readonly>
                                        <button class="btn-add-icon" id="btn-add-deGiay"><i
                                                class="fas fa-plus"></i></button>
                                        <!-- üîΩ Th√™m dropdown-list t∆∞∆°ng ·ª©ng -->
                                        <div class="dropdown-list single-select" id="deGiayList"></div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Gi·ªõi t√≠nh</label>
                                    <div class="input-with-btn position-relative">
                                        <input type="text" class="form-control dropdown-input" id="gioiTinhInput"
                                               placeholder="Ch·ªçn gi·ªõi t√≠nh" readonly>
                                        <div class="dropdown-list" id="gioiTinhList">
                                            <div class="dropdown-item" data-id="0"><i class="far fa-square me-2"></i> Nam
                                            </div>
                                            <div class="dropdown-item" data-id="1"><i class="far fa-square me-2"></i> N·ªØ
                                            </div>
                                            <div class="dropdown-item" data-id="2"><i class="far fa-square me-2"></i> Nam v√† N·ªØ
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <div class="col-md-6">
                                    <label class="form-label">Tr·∫°ng th√°i</label>
                                    <div class="input-with-btn position-relative">
                                        <input type="text" class="form-control dropdown-input" id="trangThaiInput"
                                               placeholder="Ch·ªçn tr·∫°ng th√°i" readonly>

                                        <div class="dropdown-list" id="trangThaiList">
                                            <div class="dropdown-item" data-id="1"><i class="far fa-square me-2"></i>ƒêang kinh doanh</div>
                                            <div class="dropdown-item" data-id="0"><i class="far fa-square me-2"></i>Ng·ª´ng kinh doanh</div>
                                        </div>
                                    </div>
                                </div>


                                <div class="col-md-12">
                                    <label class="form-label">M√¥ t·∫£</label>
                                    <textarea class="form-control" id="moTa" rows="3"
                                              placeholder="Nh·∫≠p m√¥ t·∫£ s·∫£n ph·∫©m..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üü¶ B·∫¢NG 2: BI·∫æN TH·ªÇ -->
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-random"></i> Bi·∫øn th·ªÉ</h6>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">M√†u s·∫Øc</label>
                                    <div class="input-with-btn position-relative">
                                        <input type="text" class="form-control dropdown-input" id="mauSacInput"
                                               placeholder="Ch·ªçn m√†u s·∫Øc" readonly>
                                        <button class="btn-add-icon" id="btn-add-mauSac"><i
                                                class="fas fa-plus"></i></button>
                                        <!-- ‚úÖ Popup m√†u d·∫°ng grid -->
                                        <div class="color-popup" id="mauSacPopup"></div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">K√≠ch c·ª°</label>
                                    <div class="input-with-btn position-relative">
                                        <input type="text" class="form-control dropdown-input" id="kichCoInput"
                                               placeholder="Ch·ªçn k√≠ch c·ª°" readonly>
                                        <button class="btn-add-icon" id="btn-add-kichCo"><i
                                                class="fas fa-plus"></i></button>
                                        <!-- ‚úÖ Popup k√≠ch c·ª° d·∫°ng grid -->
                                        <div class="size-popup" id="kichCoPopup"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group-right">
                            <button class="gradient-flame-btn-crt" id="btnGenerateVariants" role="button">
                                <i class="fas fa-plus-circle"></i>T·∫°o
                            </button>
                            <button class="gradient-flame-btn-cls" id="btnClearVariants" role="button">
                                <i class="fas fa-refresh"></i>X√≥a
                            </button>
                            <!--                        <button class="btn btn-primary btn-sm" id="btnGenerateVariants">-->
                            <!--                            <i class="fas fa-plus-circle"></i> Sinh bi·∫øn th·ªÉ-->
                            <!--                        </button>-->
                            <!--                        <button class="btn btn-outline-danger btn-sm" id="btnClearVariants">-->
                            <!--                            <i class="fas fa-refresh"></i> X√≥a t·∫•t c·∫£-->
                            <!--                        </button>-->
                        </div>

                    </div>
                </div>

                <!-- üü® B·∫¢NG 3: DANH S√ÅCH CHI TI·∫æT S·∫¢N PH·∫®M -->
                <div class="table-container">
                    <h6 class="fw-semibold-header mb-2"><i class="fas fa-list"></i> Danh s√°ch chi ti·∫øt s·∫£n ph·∫©m</h6>
                    <table class="table table-bordered table-hover">
                        <thead>
                        <tr>
                            <th style="width:45px;">
                                <i id="selectAllRows" class="far fa-square cursor-pointer"></i>
                            </th>
                            <th>STT</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>M√†u s·∫Øc</th>
                            <th>K√≠ch c·ª°</th>
                            <th>SLT</th>
                            <th>Gi√° nh·∫≠p</th>
                            <th>Gi√° b√°n</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>·∫¢nh s·∫£n ph·∫©m</th>
                        </tr>
                        </thead>

                        <tbody id="table-variants">
                        <tr>
                            <td colspan="10" class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                        </tr>
                        </tbody>
                    </table>

                    <div class="save-container">
                        <button class="btn btn-success btn-sm px-3" id="btn-save-product">
                            <i class="fas fa-save"></i> L∆∞u s·∫£n ph·∫©m
                        </button>
                    </div>
                </div>
            </div>
            <!-- ü™ü POPUP TH√äM NHANH THU·ªòC T√çNH -->
            <div id="quickAddModal" class="quick-modal">
                <div class="quick-modal-content">
                    <h5 id="quickModalTitle" class="modal-title">Th√™m m·ªõi</h5>

                    <!-- üîπ Giao di·ªán popup th√™m m√†u s·∫Øc -->
                    <div id="quickAddForm" class="d-flex flex-wrap" style="gap: 20px;">

                        <!-- üü© C·ªòT TR√ÅI: Ch·ªçn m√£ m√†u -->
                        <div id="colorPickerSection" class="flex-fill" style="min-width: 180px;">
                            <label for="attrColorInput" class="form-label fw-bold">Ch·ªçn m√£ m√†u:</label>
                            <!--                            <input type="color" id="attrColorInput" class="form-control form-control-color w-100" value="#000000">-->
                            <input
                                    type="color"
                                    id="attrColorInput"
                                    value="#000000"
                                    style="position:absolute;width:0;height:0;opacity:0;pointer-events:none;border:0;padding:0;margin:0;"
                            />
                            <!-- üé® √î ch·ªçn m√£ m√†u ƒë·∫πp -->
                            <div id="customColorPickerContainer" style="position: relative;">
                                <div class="selected-color-box" id="selectedColorBox" title="B·∫•m ƒë·ªÉ ch·ªçn m√†u"></div>
                                <input type="text" id="colorHexDisplay" value="#000000" maxlength="7" />

                                <!-- üé® Popup b·∫£ng ch·ªçn m√†u (N·∫∞M TRONG CONTAINER N√ÄY) -->
                                <div id="customColorPalette" class="color-palette shadow">
                                    <div class="color-palette-grid">
                                        <div class="color-item" style="background:#FF0000" data-color="#FF0000"></div>
                                        <div class="color-item" style="background:#00FF00" data-color="#00FF00"></div>
                                        <div class="color-item" style="background:#0000FF" data-color="#0000FF"></div>
                                        <div class="color-item" style="background:#FFFF00" data-color="#FFFF00"></div>
                                        <div class="color-item" style="background:#FFA500" data-color="#FFA500"></div>
                                        <div class="color-item" style="background:#FFC0CB" data-color="#FFC0CB"></div>
                                        <div class="color-item" style="background:#8A2BE2" data-color="#8A2BE2"></div>
                                        <div class="color-item" style="background:#A52A2A" data-color="#A52A2A"></div>
                                        <div class="color-item" style="background:#008080" data-color="#008080"></div>
                                        <div class="color-item" style="background:#000000" data-color="#000000"></div>
                                        <div class="color-item" style="background:#808080" data-color="#808080"></div>
                                        <div class="color-item" style="background:#FFFFFF; border:1px solid #ccc" data-color="#FFFFFF"></div>
                                    </div>
                                    <input type="color" id="colorFreePicker" class="form-control form-control-color mt-2" value="#000000">
                                </div>
                            </div>


                            <div class="mt-2 small text-muted">
                                <div>M√£ m√†u: <strong id="colorCodeDisplay">#000000</strong></div>
                                <div>T√™n g·ª£i √Ω: <strong id="colorNameDisplay">ƒêen</strong></div>
                            </div>
                        </div>

                        <!-- üü¶ C·ªòT PH·∫¢I: T√™n th·ªß c√¥ng + Tr·∫°ng th√°i -->
                        <div id="colorInfoSection" class="flex-fill" style="min-width: 240px;">
                            <!-- T√™n m√†u th·ªß c√¥ng -->
                            <div id="colorNameInputSection" class="mb-3">
                                <label for="attrColorNameInput" class="form-label fw-bold">T√™n m√†u th·ªß c√¥ng (tu·ª≥ ch·ªçn):</label>
                                <input type="text" id="attrColorNameInput" class="form-control" placeholder="VD: ƒêen tuy·ªÅn, ƒê·ªè ƒë√¥, Xanh pastel...">
                            </div>

                            <!-- Dropdown tr·∫°ng th√°i -->
                            <div id="colorStatusSection">
                                <label for="attrStatusInput" class="form-label fw-bold">Tr·∫°ng th√°i:</label>
                                <div class="dropdown">
                                    <input type="text" id="attrStatusInput" class="form-control dropdown-input" placeholder="Ch·ªçn tr·∫°ng th√°i" readonly>
                                    <div id="attrStatusList" class="dropdown-list">
                                        <div class="dropdown-item" data-id="1">ƒêang ho·∫°t ƒë·ªông</div>
                                        <div class="dropdown-item" data-id="0">Ng·ª´ng ho·∫°t ƒë·ªông</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="modal-footer">
                        <button class="btn btn-success btn-sm px-3" id="btnSaveAttr">
                            <i class="fas fa-save"></i> L∆∞u
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div layout:fragment="scripts">
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                document.documentElement.style.setProperty('--scrollbar-width', `${scrollbarWidth}px`);
            });
        </script>

        <script>
            let finalSanPhamId = null;
            let sanPhamId = null;
            // ============================================================
            // üü© 1Ô∏è‚É£ LOAD D·ªÆ LI·ªÜU DROPDOWN T·ª™ API (TH∆Ø∆†NG HI·ªÜU, DANH M·ª§C, ...)
            // ============================================================

            async function loadDropdownData() {
                try {
                    const [thuongHieuRes, danhMucRes, chatLieuRes, deGiayRes, mauSacRes, kichCoRes] = await Promise.all([
                        axios.get('/api/thuong-hieu/getAll'),
                        axios.get('/api/danh-muc/getAll'),
                        axios.get('/api/chat-lieu/getAll'),
                        axios.get('/api/de-giay/getAll'),
                        axios.get('/api/mau-sac/getAll'),
                        axios.get('/api/kich-co/getAll')
                    ]);

                    const mapData = (data, field, listId) => {
                        const $list = $(`#${listId}`);
                        $list.empty();
                        data.forEach(item => {
                            $list.append(`
                    <div class="dropdown-item" data-id="${item.id}">
                        <i class="far fa-square me-2"></i> ${item[field]}
                    </div>
                `);
                        });
                    };

                    // G√°n d·ªØ li·ªáu v√†o c√°c dropdown
                    mapData(thuongHieuRes.data, 'tenThuongHieu', 'thuongHieuList');
                    mapData(danhMucRes.data, 'tenDanhMuc', 'danhMucList');
                    mapData(chatLieuRes.data, 'tenChatLieu', 'chatLieuList');
                    mapData(deGiayRes.data, 'tenDeGiay', 'deGiayList');
                    renderColorPopup(mauSacRes.data); // üîπ G·ªçi sau khi load d·ªØ li·ªáu m√†u
                    renderSizePopup(kichCoRes.data);
                } catch (err) {
                    console.error('‚ùå L·ªói load dropdown:', err);
                }
            }

            // ============================================================
            // üü¢ H√ÄM X·ª¨ L√ù CHUNG CHO DROPDOWN SINGLE-SELECT
            // ============================================================
            // ‚úÖ B·∫Øt s·ª± ki·ªán m·ªü dropdown cho c√°c single-select chung
            $(document).on('click', '.dropdown-input', function () {
                const id = $(this).attr('id');
                const listId = '#' + id.replace('Input', 'List');

                // ‚úÖ B·ªè qua dropdown ri√™ng (gi·ªõi t√≠nh, tr·∫°ng th√°i, popup)
                if (['#gioiTinhList', '#trangThaiList', '#attrStatusList'].includes(listId)) return;

                $('.dropdown-list').not(listId).removeClass('show');
                $(listId).toggleClass('show');
                adjustDropdownHeight($(listId));
            });

            $(document).on('click', '.dropdown-list.single-select .dropdown-item', function (e) {
                e.stopPropagation();

                const $item = $(this);
                const $list = $item.closest('.dropdown-list');
                const id = $item.data('id');
                const name = $item.text().trim();

                // üîπ X√°c ƒë·ªãnh input li√™n k·∫øt (VD: #thuongHieuInput)
                const inputId = '#' + $list.attr('id').replace('List', 'Input');
                const $input = $(inputId);

                // üîπ B·ªè ch·ªçn t·∫•t c·∫£ item c≈©
                $list.find('.dropdown-item').removeClass('selected')
                    .find('i').removeClass('fa-check-square text-primary').addClass('fa-square');

                // üîπ Ch·ªçn item hi·ªán t·∫°i
                $item.addClass('selected')
                    .find('i').removeClass('fa-square').addClass('fa-check-square text-primary');

                // üîπ C·∫≠p nh·∫≠t input hi·ªÉn th·ªã v√† data
                $input.val(name).data('ids', [id]);
                adjustDropdownHeight($(listId));

                // üîπ ·∫®n dropdown
                $list.removeClass('show');
            });




            // ============================================================
            // üü¶ 2Ô∏è‚É£ X·ª¨ L√ù DROPDOWN CH·ªåN NHI·ªÄU (MULTI SELECT)
            // ============================================================
            // ‚úÖ B·∫Øt s·ª± ki·ªán m·ªü dropdown chung
            // $(document).on('click', '.dropdown-input', function () {
            //     const id = $(this).attr('id');
            //     const listId = '#' + id.replace('Input', 'List');
            //
            //     // ‚úÖ N·∫øu l√† c√°c dropdown ri√™ng (gi·ªõi t√≠nh, tr·∫°ng th√°i...) th√¨ b·ªè qua ‚Äî c√≥ handler ri√™ng
            //     if (['#gioiTinhList', '#trangThaiList', '#attrStatusList'].includes(listId)) return;
            //
            //     $('.dropdown-list').not(listId).removeClass('show');
            //     $(listId).toggleClass('show');
            //     adjustDropdownHeight($(listId));
            // });


            // Gi·ªõi h·∫°n s·ªë item hi·ªÉn th·ªã trong dropdown (>5 th√¨ cho cu·ªôn)
            function adjustDropdownHeight($list) {
                const itemCount = $list.find('.dropdown-item').length;
                if (itemCount > 4) {
                    $list.css({ 'max-height': '180px', 'overflow-y': 'auto' });
                } else {
                    $list.css({ 'max-height': 'none', 'overflow-y': 'hidden' });
                }
            }

            // ‚úÖ Cho ph√©p ch·ªçn nhi·ªÅu m·ª•c
            // $(document).on('click', '.dropdown-item', function (e) {
            //     const parentId = $(this).parent().attr('id');
            //     if (['trangThaiList', 'attrStatusList', 'gioiTinhList'].includes(parentId)) return;
            //
            //
            //
            //     e.stopPropagation();
            //     const $item = $(this);
            //     const $icon = $item.find('i');
            //     const $list = $item.parent();
            //     const inputId = '#' + $list.attr('id').replace('List', 'Input');
            //
            //     // Toggle ch·ªçn/b·ªè ch·ªçn
            //     if ($item.hasClass('selected')) {
            //         $item.removeClass('selected');
            //         $icon.removeClass('fa-check-square text-primary').addClass('fa-square');
            //     } else {
            //         $item.addClass('selected');
            //         $icon.removeClass('fa-square').addClass('fa-check-square text-primary');
            //     }
            //
            //     // C·∫≠p nh·∫≠t gi√° tr·ªã hi·ªÉn th·ªã
            //     const selected = [], selectedIds = [];
            //     $list.find('.dropdown-item.selected').each(function () {
            //         selected.push($(this).text().trim());
            //         selectedIds.push($(this).data('id'));
            //     });
            //
            //     $(inputId).val(selected.join(', ')).data('ids', selectedIds);
            // });


            // ============================================================
            // üî¥ VALIDATE T·ª®C TH·ªúI INPUT B·∫ÆT BU·ªòC
            // ============================================================
            function validateRequiredInput(selector, message) {
                const $input = $(selector);
                const ids = $input.data('ids') || [];

                // N·∫øu r·ªóng
                if (ids.length === 0 || !$input.val().trim()) {
                    $input.addClass('is-invalid');
                    if ($input.next('.error-message').length === 0) {
                        $input.after(`<small class="error-message text-danger">${message}</small>`);
                    }
                    return false;
                } else {
                    $input.removeClass('is-invalid');
                    $input.next('.error-message').remove();
                    return true;
                }
            }



            // ============================================================
            // üüß 3Ô∏è‚É£ POPUP M√ÄU S·∫ÆC (Color Picker)
            // ============================================================
            function renderColorPopup(data) {
                const $popup = $('#mauSacPopup');
                $popup.empty();
                data.forEach(item => {
                    $popup.append(`
            <div class="color-item"
                 data-id="${item.id}"
                 title="${item.tenMau}"
                 style="background-color: ${item.maMau};">
            </div>
        `);
                });
            }

            // Hover hi·ªÉn th·ªã m·ªü r·ªông
            $(document).on('mouseenter', '.color-item', function () {
                $('#mauSacPopup').addClass('expanded');
            });

            $(document).on('mouseleave', '.color-item', function () {
                $('#mauSacPopup').removeClass('expanded');
            });

            // M·ªü / ƒë√≥ng popup m√†u
            $(document).on('click', '#mauSacInput', function (e) {
                e.stopPropagation();
                $('.color-popup').not('#mauSacPopup').removeClass('show');
                $('#mauSacPopup').toggleClass('show');
            });

            // Ch·ªçn m√†u
            $(document).on('click', '.color-item', function (e) {
                e.stopPropagation();
                const $item = $(this);
                $item.toggleClass('selected');

                const selectedNames = [], selectedIds = [], selectedColors = [];

                $('#mauSacPopup .color-item.selected').each(function () {
                    selectedNames.push($(this).attr('title'));
                    selectedIds.push($(this).data('id'));
                    selectedColors.push($(this).css('background-color'));
                });

                $('#mauSacInput').val(selectedNames.join(', ')).data('ids', selectedIds);
                toggleGenerateButtonState(); // üîπ th√™m d√≤ng n√†y
            });

            // ·∫®n popup khi click ra ngo√†i
            $(document).click(function (e) {
                if (!$(e.target).closest('#mauSacPopup, #mauSacInput').length) {
                    const hasSelected = $('#mauSacPopup .color-item.selected').length > 0;
                    if (!hasSelected) $('#mauSacPopup').removeClass('show');
                }
            });



            // ============================================================
            // üü® 4Ô∏è‚É£ POPUP K√çCH C·ª† (Size Picker)
            // ============================================================
            function renderSizePopup(data) {
                const $popup = $('#kichCoPopup');
                $popup.empty();
                data.forEach(item => {
                    $popup.append(`
            <div class="size-item"
                 data-id="${item.id}"
                 title="${item.tenKichCo}">
                 ${item.tenKichCo}
            </div>
        `);
                });
            }

            // M·ªü / ƒë√≥ng popup k√≠ch c·ª°
            $(document).on('click', '#kichCoInput', function (e) {
                e.stopPropagation();
                $('.size-popup').not('#kichCoPopup').removeClass('show');
                $('#kichCoPopup').toggleClass('show');
            });

            // Ch·ªçn k√≠ch c·ª°
            $(document).on('click', '.size-item', function (e) {
                e.stopPropagation();
                const $item = $(this);
                $item.toggleClass('selected');

                const selectedNames = [], selectedIds = [];
                $('#kichCoPopup .size-item.selected').each(function () {
                    selectedNames.push($(this).text().trim());
                    selectedIds.push($(this).data('id'));
                });

                $('#kichCoInput').val(selectedNames.join(', ')).data('ids', selectedIds);
                toggleGenerateButtonState(); // üîπ th√™m d√≤ng n√†y
            });

            // ·∫®n popup k√≠ch c·ª° khi click ra ngo√†i (n·∫øu ch∆∞a ch·ªçn)
            $(document).click(function (e) {
                if (!$(e.target).closest('#kichCoPopup, #kichCoInput').length) {
                    const hasSelected = $('#kichCoPopup .size-item.selected').length > 0;
                    if (!hasSelected) $('#kichCoPopup').removeClass('show');
                }
            });


            // üîπ Khi b·∫•m "Sinh bi·∫øn th·ªÉ" ‚Üí render b·∫£ng
            $(document).on('click', '#btnGenerateVariants', function () {
                const tenSanPham = $('#tenSanPhamInput').val().trim();
                const mauSacIds = $('#mauSacInput').data('ids') || [];
                const kichCoIds = $('#kichCoInput').data('ids') || [];

                if (!tenSanPham || mauSacIds.length === 0 || kichCoIds.length === 0) {
                    alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m, ch·ªçn m√†u s·∫Øc v√† k√≠ch c·ª° tr∆∞·ªõc!');
                    return;
                }

                // üß† G·ªçi h√†m render b·∫£ng th·ªß c√¥ng
                updateVariantTable();
            });

            // Disable n√∫t ‚ÄúSinh bi·∫øn th·ªÉ‚Äù khi ch∆∞a ch·ªçn ƒë·ªß
            function toggleGenerateButtonState() {
                const tenSanPham = $('#tenSanPhamInput').val().trim();

                // D·ªØ li·ªáu t·ª´ data() ho·∫∑c fallback theo text
                const mauSacIds = $('#mauSacInput').data('ids');
                const kichCoIds = $('#kichCoInput').data('ids');
                const mauSacText = $('#mauSacInput').val().trim();
                const kichCoText = $('#kichCoInput').val().trim();

                // ‚úÖ D√π data m·∫•t th√¨ text v·∫´n d√πng ƒë∆∞·ª£c
                const mauSacFilled = (Array.isArray(mauSacIds) && mauSacIds.length > 0) || mauSacText.length > 0;
                const kichCoFilled = (Array.isArray(kichCoIds) && kichCoIds.length > 0) || kichCoText.length > 0;

                const canGenerate = tenSanPham.length > 0 && mauSacFilled && kichCoFilled;
                $('#btnGenerateVariants').prop('disabled', !canGenerate);
            }



            $(document).on('input click', '#tenSanPhamInput, #mauSacInput, #kichCoInput', toggleGenerateButtonState);


            // üîπ Khi b·∫•m "X√≥a t·∫•t c·∫£ bi·∫øn th·ªÉ" ‚Üí d·ªçn b·∫£ng
            $(document).on('click', '#btnClearVariants', function () {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ bi·∫øn th·ªÉ kh√¥ng?')) {
                    $('#table-variants').html(`
            <tr><td colspan="10" class="text-muted text-center">Ch∆∞a c√≥ bi·∫øn th·ªÉ n√†o.</td></tr>
        `);
                }
            });




            // ============================================================
            // üü© 5Ô∏è‚É£ SINGLE SELECT TR·∫†NG TH√ÅI
            // ============================================================
            $(document).on('click', '#trangThaiInput', function () {
                $('.dropdown-list').not('#trangThaiList').removeClass('show');
                $('#trangThaiList').toggleClass('show');
                adjustDropdownHeight($('#trangThaiList'));
            });

            $(document).on('click', '#trangThaiList .dropdown-item', function (e) {
                e.stopPropagation();
                const $item = $(this);
                const $list = $item.parent();
                const $input = $('#trangThaiInput');

                // N·∫øu item ƒëang ƒë∆∞·ª£c ch·ªçn => kh√¥ng l√†m g√¨ c·∫£
                if ($item.hasClass('selected')) return;

                // B·ªè ch·ªçn t·∫•t c·∫£ item kh√°c
                $list.find('.dropdown-item').removeClass('selected')
                    .find('i')
                    .removeClass('fa-check-square text-primary')
                    .addClass('fa-square');

                // Ch·ªçn item v·ª´a click
                $item.addClass('selected');
                $item.find('i').removeClass('fa-square').addClass('fa-check-square text-primary');

                // G√°n gi√° tr·ªã hi·ªÉn th·ªã v√† data-id
                $input.val($item.text().trim()).data('id', $item.data('id'));

                // ·∫®n dropdown sau khi ch·ªçn
                $list.removeClass('show');
            });



            // ============================================================
            // üü¶ 6Ô∏è‚É£ SINGLE SELECT GI·ªöI T√çNH
            // ============================================================
            $(document).on('click', '#gioiTinhInput', function () {
                $('.dropdown-list').not('#gioiTinhList').removeClass('show');
                $('#gioiTinhList').toggleClass('show');
                adjustDropdownHeight($('#gioiTinhList'));
            });

            $(document).on('click', '#gioiTinhList .dropdown-item', function (e) {
                e.stopPropagation();
                const $item = $(this);
                const $list = $item.parent();
                const $input = $('#gioiTinhInput');

                // N·∫øu item ƒëang ƒë∆∞·ª£c ch·ªçn => kh√¥ng l√†m g√¨ c·∫£
                if ($item.hasClass('selected')) return;

                // B·ªè ch·ªçn t·∫•t c·∫£ item kh√°c
                $list.find('.dropdown-item').removeClass('selected')
                    .find('i')
                    .removeClass('fa-check-square text-primary')
                    .addClass('fa-square');

                // Ch·ªçn item v·ª´a click
                $item.addClass('selected');
                $item.find('i').removeClass('fa-square').addClass('fa-check-square text-primary');

                // G√°n gi√° tr·ªã hi·ªÉn th·ªã v√† data-id
                $input.val($item.text().trim()).data('id', $item.data('id'));

                // ·∫®n dropdown sau khi ch·ªçn
                $list.removeClass('show');
            });




            // ============================================================
            // üü™ 7Ô∏è‚É£ DROPDOWN T√äN S·∫¢N PH·∫®M (SEARCHABLE SINGLE SELECT - FIXED)
            // ============================================================

            // üü© Load d·ªØ li·ªáu s·∫£n ph·∫©m ban ƒë·∫ßu
            async function loadTenSanPhamList() {
                try {
                    const res = await axios.get('/api/san-pham/getAll');
                    window.tenSanPhamData = res.data || [];
                    renderTenSanPhamList(window.tenSanPhamData);
                } catch (err) {
                    console.error('‚ùå L·ªói load s·∫£n ph·∫©m:', err);
                }
            }

            // üü¶ H√†m render danh s√°ch s·∫£n ph·∫©m theo keyword
            function renderTenSanPhamList(list, keyword = '') {
                const $list = $('#tenSanPhamList');
                $list.empty();

                let filtered = list;
                if (keyword.trim() !== '') {
                    filtered = list.filter(sp =>
                        sp.tenSanPham.toLowerCase().includes(keyword.toLowerCase())
                    );
                }

                // üîπ N·∫øu kh√¥ng c√≥ k·∫øt qu·∫£, hi·ªÉn th·ªã t√πy ch·ªçn th√™m m·ªõi
                if (filtered.length === 0 && keyword.trim() !== '') {
                    $list.append(`
            <div class="dropdown-item add-new" data-id="null">
                ‚ûï Th√™m s·∫£n ph·∫©m m·ªõi: <strong>${keyword}</strong>
            </div>
        `);
                } else {
                    filtered.forEach(sp => {
                        $list.append(`
                <div class="dropdown-item" data-id="${sp.id}">
                    ${sp.tenSanPham}
                </div>
            `);
                    });
                }

                // ‚úÖ C·∫≠p nh·∫≠t chi·ªÅu cao cu·ªôn
                adjustDropdownHeight($list);
            }

            // üü® Khi click ho·∫∑c focus v√†o input ‚Üí m·ªü dropdown, hi·ªÉn th·ªã to√†n b·ªô list
            $(document).on('focus click', '#tenSanPhamInput', function (e) {
                e.stopPropagation();
                const $list = $('#tenSanPhamList');
                renderTenSanPhamList(window.tenSanPhamData || []); // lu√¥n render full khi m·ªü
                $('.dropdown-list').not($list).removeClass('show');
                $list.addClass('show');
                adjustDropdownHeight($list);
            });

            // üüß Khi ng∆∞·ªùi d√πng g√µ ‚Üí l·ªçc danh s√°ch theo keyword
            $(document).on('input', '#tenSanPhamInput', function () {
                const keyword = $(this).val();
                renderTenSanPhamList(window.tenSanPhamData || [], keyword);

                const $list = $('#tenSanPhamList');
                if (!$list.hasClass('show')) $list.addClass('show');
            });

            // üü´ Khi ch·ªçn 1 m·ª•c trong danh s√°ch
            $(document).on('click', '#tenSanPhamList .dropdown-item', function (e) {
                e.stopPropagation();
                const $item = $(this);
                const rawId = $item.data('id');
                const id = (rawId === null || rawId === 'null' || rawId === undefined) ? null : Number(rawId);
                const name = $item.text().replace(/^‚ûï\s*Th√™m s·∫£n ph·∫©m m·ªõi:\s*/i, '').trim();

                $('#tenSanPhamInput').val(name).data('id', id);
                $('#tenSanPhamList').removeClass('show');
            });

            // üü• ·∫®n dropdown khi click ra ngo√†i
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#tenSanPhamInput, #tenSanPhamList').length) {
                    $('#tenSanPhamList').removeClass('show');
                }
            });




            // ============================================================
            // üü• 8Ô∏è‚É£ POPUP TH√äM NHANH THU·ªòC T√çNH (Add nhanh)
            // ============================================================
            $(document).ready(function () {

                // üíæ L∆∞u nhanh
                $(document).on('click', '#btnSaveAttr', async function () {
                    const name = $('#attrColorNameInput').val().trim();
                    const statusText = $('#attrStatusInput').val().trim();
                    const status = statusText === 'ƒêang ho·∫°t ƒë·ªông' ? 1 : 0;

                    if (!currentAttrType) return alert('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c lo·∫°i thu·ªôc t√≠nh.');
                    if (!name) return alert('Vui l√≤ng nh·∫≠p t√™n thu·ªôc t√≠nh.');
                    if (statusText === '') return alert('Vui l√≤ng ch·ªçn tr·∫°ng th√°i.');

                    const apiMap = {
                        'thuongHieu': '/api/thuong-hieu/add',
                        'danhMuc': '/api/danh-muc/add',
                        'chatLieu': '/api/chat-lieu/add',
                        'deGiay': '/api/de-giay/add',
                        'mauSac': '/api/mau-sac/add',
                        'kichCo': '/api/kich-co/add'
                    };

                    const fieldMap = {
                        'thuongHieu': 'tenThuongHieu',
                        'danhMuc': 'tenDanhMuc',
                        'chatLieu': 'tenChatLieu',
                        'deGiay': 'tenDeGiay',
                        'mauSac': 'tenMau',
                        'kichCo': 'tenKichCo'
                    };

                    let payload = {
                        [fieldMap[currentAttrType]]: name,
                        trangThai: status
                    };

                    if (currentAttrType === 'mauSac') {
                        const colorCode = $('#attrColorInput').val().toUpperCase();
                        const colorNameManual = $('#attrColorNameInput').val().trim();
                        const colorNameAuto = colorNameMap[colorCode] || 'M√†u kh√¥ng x√°c ƒë·ªãnh';
                        const colorName = colorNameManual || colorNameAuto;
                        payload = {
                            tenMau: colorName,
                            maMau: colorCode,
                            trangThai: status
                        };
                    }

                    try {
                        await axios.post(apiMap[currentAttrType], payload);
                        alert('‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!');
                        await loadDropdownData();

                        // üü¢ H·ªèi xem ng∆∞·ªùi d√πng mu·ªën th√™m ti·∫øp hay kh√¥ng
                        const tiepTuc = confirm('B·∫°n c√≥ mu·ªën th√™m ti·∫øp kh√¥ng?');

                        if (tiepTuc) {
                            // Gi·ªØ popup m·ªü, reset form
                            $('#attrColorNameInput').val('');
                            $('#attrStatusInput').val('').data('id', null);
                            $('#attrStatusList .dropdown-item').removeClass('selected')
                                .find('i').removeClass('fa-check-square text-primary').addClass('fa-square');

                            if (currentAttrType === 'mauSac') {
                                const defaultColor = '#000000';
                                updateColorSelection(defaultColor);
                            }
                            $('#attrColorNameInput').focus();
                        } else {
                            // ƒê√≥ng popup
                            $('#quickAddModal').fadeOut(150, () => $('#quickAddModal').removeClass('show'));
                        }

                    } catch (err) {
                        console.error('‚ùå L·ªói khi l∆∞u thu·ªôc t√≠nh:', err);
                        alert('‚ùå L·ªói khi l∆∞u, vui l√≤ng th·ª≠ l·∫°i.');
                    }
                });


                // ‚ùå ƒê√≥ng popup khi click n·ªÅn
                $(document).on('click', '#quickAddModal', function (e) {
                    if ($(e.target).is('#quickAddModal')) {
                        $('#quickAddModal').fadeOut(150, function () {
                            $(this).removeClass('show');
                        });
                    }
                });

                // ===== DROPDOWN TR·∫†NG TH√ÅI TRONG POPUP =====
                $(document).on('click', '#attrStatusInput', function (e) {
                    e.stopPropagation();
                    $('.dropdown-list').not('#attrStatusList').removeClass('show');
                    $('#attrStatusList').toggleClass('show');
                });

                // Ch·ªçn 1 tr·∫°ng th√°i -> t·ª± ƒë√≥ng
                $(document).on('click', '#attrStatusList .dropdown-item', function (e) {
                    e.stopPropagation();
                    const $item = $(this);
                    $('#attrStatusList .dropdown-item').removeClass('selected');
                    $item.addClass('selected');
                    $('#attrStatusInput').val($item.text().trim()).data('id', $item.data('id'));
                    $('#attrStatusList').removeClass('show');
                });

                // Click ra ngo√†i -> ƒë√≥ng dropdown
                $(document).on('click', function (e) {
                    if (!$(e.target).closest('#attrStatusInput, #attrStatusList').length) {
                        $('#attrStatusList').removeClass('show');
                    }
                });
            });



            // ============================================================
            // üü© 9Ô∏è‚É£ KH·ªûI T·∫†O (G·ªåI LOAD D·ªÆ LI·ªÜU L·∫¶N ƒê·∫¶U)
            // ============================================================
            $(document).ready(function () {
                loadDropdownData();
                loadTenSanPhamList(); // üîπ load danh s√°ch s·∫£n ph·∫©m
                loadColorMap(); // üü© Th√™m d√≤ng n√†y
            });



            // ============================================================
            // üü¶ üîü C·∫¨P NH·∫¨T B·∫¢NG BI·∫æN TH·ªÇ (G·ªòP ·∫¢NH THEO M√ÄU)
            // ============================================================
            // ============================================================
            // üü¶ C·∫¨P NH·∫¨T B·∫¢NG BI·∫æN TH·ªÇ (S·∫¢N PH·∫®M CHI TI·∫æT)
            // ============================================================
            function updateVariantTable() {
                const tenSanPham = $('#tenSanPhamInput').val().trim();
                const mauSacNames = ($('#mauSacInput').val() || '').split(',').map(s => s.trim()).filter(Boolean);
                const kichCoNames = ($('#kichCoInput').val() || '').split(',').map(s => s.trim()).filter(Boolean);

                // L·∫•y danh s√°ch ID t∆∞∆°ng ·ª©ng t·ª´ data()
                const mauSacIds = $('#mauSacInput').data('ids') || [];
                const kichCoIds = $('#kichCoInput').data('ids') || [];

                const $tbody = $('#table-variants');
                $tbody.empty();

                if (!tenSanPham || mauSacNames.length === 0 || kichCoNames.length === 0) {
                    $tbody.append(`
            <tr><td colspan="10" class="text-muted text-center">
                ‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m v√† ch·ªçn ƒë·∫ßy ƒë·ªß m√†u s·∫Øc, k√≠ch c·ª°.
            </td></tr>
        `);
                    return;
                }

                let stt = 1;
                let rowsHtml = '';

                // Sinh b·∫£ng bi·∫øn th·ªÉ
                mauSacNames.forEach((mau, i) => {
                    const mauId = mauSacIds[i];
                    const colorRowspan = kichCoNames.length;

                    kichCoNames.forEach((size, j) => {
                        const sizeId = kichCoIds[j];

                        rowsHtml += `
            <tr data-mau-id="${mauId}" data-size-id="${sizeId}">
                <td class="text-center align-middle">
                    <i class="far fa-square row-select cursor-pointer"></i>
                </td>
                <td>${stt++}</td>
                <td>${tenSanPham}</td>
                <td>${mau}</td>
                <td>${size}</td>

                <!-- S·ªë l∆∞·ª£ng -->
                <td>
                    <input type="number" class="form-control form-control-sm text-center soLuongInput" min="0" value="0">
                </td>

                <!-- Gi√° nh·∫≠p -->
                <td>
                    <input type="number" class="form-control form-control-sm text-center giaNhapInput" min="0" value="0">
                </td>

                <!-- Gi√° b√°n -->
                <td>
                    <input type="number" class="form-control form-control-sm text-center giaBanInput" min="0" value="0">
                </td>

                <!-- Tr·∫°ng th√°i -->
                <td>
                    <select class="form-select form-select-sm trangThaiSelect">
                        <option value="1">ƒêang b√°n</option>
                        <option value="0">Ng·ª´ng</option>
                    </select>
                </td>

                <!-- Upload ·∫£nh -->
                <!-- Upload ·∫£nh -->
${j === 0 ? `
    <td rowspan="${colorRowspan}" class="align-middle">
        <div class="upload-container"
             data-mau-id="${mauId}"
             data-color="${mau}"
             data-mode="">

            <!-- Khu ch·ªçn ·∫£nh -->
            <div class="upload-placeholder text-center p-2 border rounded cursor-pointer">
                <i class="fas fa-cloud-upload-alt fa-2x text-secondary mb-1"></i>
                <div class="small text-muted">Ch·ªçn ·∫£nh</div>
            </div>

            <!-- Input ·∫©n -->
            <input type="file" accept="image/*" multiple style="display:none">

            <!-- Khu preview -->
            <div class="preview-container d-flex flex-wrap gap-2 mt-2"></div>
        </div>
    </td>
` : ''}
            </tr>`;
                    });
                });

                $tbody.html(rowsHtml);
            }

            // Khi click v√†o placeholder -> m·ªü file picker
            $(document).on('click', '.upload-placeholder', function () {
                $(this).siblings('input[type="file"]').trigger('click');
            });


            // G·ªçi l·∫°i m·ªói khi thay ƒë·ªïi t√™n SP, m√†u, ho·∫∑c k√≠ch c·ª°
            // $('#tenSanPhamInput').on('input', updateVariantTable);
            // $(document).on('click', '.color-item, .size-item', function () {
            //     setTimeout(updateVariantTable, 100);
            // });



            // ============================================================
            // üü© 14Ô∏è‚É£ T√çCH CH·ªåN D√íNG & CH·ªåN T·∫§T C·∫¢
            // ============================================================

            // Click ch·ªçn t·ª´ng d√≤ng
            $(document).on('click', '.row-select', function () {
                const $icon = $(this);

                if ($icon.hasClass('fa-square')) {
                    $icon.removeClass('fa-square').addClass('fa-check-square text-primary');
                } else {
                    $icon.removeClass('fa-check-square text-primary').addClass('fa-square');
                }

                updateSelectAllIcon();
            });

            // Click ch·ªçn t·∫•t c·∫£
            $(document).on('click', '#selectAllRows', function () {
                const $icon = $(this);
                const allSelected = $icon.hasClass('fa-check-square');

                if (allSelected) {
                    // B·ªè ch·ªçn t·∫•t c·∫£
                    $icon.removeClass('fa-check-square text-primary').addClass('fa-square');
                    $('.row-select').removeClass('fa-check-square text-primary').addClass('fa-square');
                } else {
                    // Ch·ªçn t·∫•t c·∫£
                    $icon.removeClass('fa-square').addClass('fa-check-square text-primary');
                    $('.row-select').removeClass('fa-square').addClass('fa-check-square text-primary');
                }
            });

            // H√†m ƒë·ªìng b·ªô tick t·ªïng khi ch·ªçn th·ªß c√¥ng
            function updateSelectAllIcon() {
                const total = $('.row-select').length;
                const selected = $('.row-select.fa-check-square').length;

                if (selected === total && total > 0) {
                    $('#selectAllRows').removeClass('fa-square').addClass('fa-check-square text-primary');
                } else {
                    $('#selectAllRows').removeClass('fa-check-square text-primary').addClass('fa-square');
                }
            }



            // ============================================================
            // üü® 11Ô∏è‚É£ UPLOAD ·∫¢NH & XEM TR∆Ø·ªöC (C√ì N√âN + COVER + REORDER)
            // ============================================================

            // ‚öôÔ∏è N√©n ·∫£nh client-side tr∆∞·ªõc khi preview
            async function compressImage(file, maxWidth = 900, quality = 0.8) {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = event => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const scale = Math.min(maxWidth / img.width, 1);
                            const width = img.width * scale;
                            const height = img.height * scale;
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            // üß© Khi ch·ªçn file ho·∫∑c d√°n ·∫£nh t·ª´ clipboard
            // Khi ch·ªçn file: ch·ªâ preview local, ch∆∞a upload
            $(document).on('change', '.upload-container input[type="file"]', function (e) {
                const files = Array.from(e.target.files || []);
                const $container = $(this).closest('.upload-container');
                const $preview = $container.find('.preview-container');

                // L∆∞u danh s√°ch file v√†o container ƒë·ªÉ d√πng khi ·∫•n L∆∞u
                $container.data('files', files);

                $preview.empty();
                files.forEach((file, idx) => {
                    const url = URL.createObjectURL(file);
                    $preview.append(`
      <div class="preview-item" draggable="true" data-file-index="${idx}">
        <img src="${url}" alt="">
        <button type="button" class="btn-set-cover" title="ƒê·∫∑t l√†m ·∫£nh ch√≠nh">
          <i class="fas fa-star"></i>
        </button>
        <button type="button" class="btn-remove-image">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `);
                });

                $container.find('.upload-placeholder').hide();
            });
            $(document).on('paste', '.upload-container', function (e) {
                const items = e.originalEvent.clipboardData.items;
                const files = [];
                for (const item of items) {
                    if (item.kind === 'file') files.push(item.getAsFile());
                }
                if (files.length) handleFiles({ target: { files }, currentTarget: this });
            });

            // ============================================================
            // üü¢ X·ª¨ L√ù FILE ·∫¢NH (Preview local ‚Üí upload th·∫≠t sau khi l∆∞u)
            // ============================================================
//             async function handleFiles(e) {
//                 const files = e.target.files;
//                 const $container = $(e.currentTarget).closest('.upload-container');
//                 const mauSacId = +($container.closest('tr').data('mau-id') || 0);
//                 const $preview = $container.find('.preview-container');
//
//                 // üü¢ N·∫øu CH∆ØA c√≥ ID s·∫£n ph·∫©m ‚Üí ch·ªâ xem tr∆∞·ªõc local
//                 if (!finalSanPhamId) {
//                     $preview.empty();
//                     for (const file of files) {
//                         const blob = await compressImage(file);
//                         const imgUrl = URL.createObjectURL(blob);
//                         $preview.append(`
//                 <div class="preview-item" draggable="true">
//                     <img src="${imgUrl}" alt="">
//                         <button type="button" class="btn-set-cover" title="ƒê·∫∑t l√†m ·∫£nh ch√≠nh">
//                             <i class="fas fa-star"></i>
//                         </button>
//                         <button type="button" class="btn-remove-image">
//                             <i class="fas fa-times"></i>
//                         </button>
//                 </div>
//             `);
//                     }
//                     $container.find('.upload-placeholder').hide();
//                     console.log('üñº Xem tr∆∞·ªõc ·∫£nh local (ch∆∞a upload v√¨ ch∆∞a c√≥ ID s·∫£n ph·∫©m)');
//                     return;
//                 }
//
//                 // üü¢ N·∫øu ƒê√É c√≥ ID s·∫£n ph·∫©m ‚Üí upload th·∫≠t
//                 for (const file of files) {
//                     const formData = new FormData();
//                     formData.append("sanPhamId", finalSanPhamId);
//                     formData.append("mauSacId", mauSacId);
//                     formData.append("file", file);
//                     formData.append("laAnhBia", false);
//                     formData.append("thuTu", $preview.children().length);
//
//                     try {
//                         const res = await axios.post("/api/san-pham-mau-anh/upload", formData, {
//                             headers: { "Content-Type": "multipart/form-data" }
//                         });
//                         const imgUrl = res.data.duongDan;
//
// // üõ†Ô∏è N·∫øu backend ch·ªâ tr·∫£ t√™n file (tr∆∞·ªùng h·ª£p API c≈©) ‚Üí t·ª± th√™m prefix
//                         const fixedUrl = imgUrl.startsWith('http')
//                             ? imgUrl
//                             : `http://localhost:8080/uploads/sanpham/${finalSanPhamId}/${imgUrl}`;
//
//                         $preview.append(`
//   <div class="preview-item" draggable="true">
//       <img src="${fixedUrl}" alt="">
//       <button type="button" class="btn-set-cover"
//               data-id="${res.data.id}"
//               title="ƒê·∫∑t l√†m ·∫£nh ch√≠nh">
//           <i class="fas fa-star"></i>
//       </button>
//       <button type="button" class="btn-remove-image"
//               data-id="${res.data.id}">
//           <i class="fas fa-times"></i>
//       </button>
//   </div>
// `);
//
//                         $container.find('.upload-placeholder').hide();
//                         console.log('‚úÖ Upload ·∫£nh th√†nh c√¥ng:', imgUrl);
//                     } catch (err) {
//                         console.error('‚ùå Upload ·∫£nh l·ªói:', err);
//                         alert('Kh√¥ng th·ªÉ upload ·∫£nh n√†y!');
//                     }
//                 }
//             }
            // ============================================================
            // üü¢ 1Ô∏è‚É£ Khi ch·ªçn file (ch∆∞a upload ‚Äî ch·ªâ preview local)
            // ============================================================
            async function handleFiles(e) {
                const files = e.target.files;
                const $container = $(e.currentTarget).closest('.upload-container');
                const $preview = $container.find('.preview-container');

                // Hi·ªÉn th·ªã preview local
                $preview.empty();
                for (const file of files) {
                    const imgUrl = URL.createObjectURL(file);
                    $preview.append(`
            <div class="preview-item" draggable="true">
                <img src="${imgUrl}" alt="">
                <button type="button" class="btn-set-cover" title="ƒê·∫∑t l√†m ·∫£nh ch√≠nh">
                    <i class="fas fa-star"></i>
                </button>
                <button type="button" class="btn-remove-image">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `);
                }

                $container.find('.upload-placeholder').hide();
                console.log('üñº Hi·ªÉn th·ªã preview local, ch∆∞a upload.');
            }

            // ============================================================
            // ‚≠ê 2Ô∏è‚É£ Ch·ªçn ·∫£nh b√¨a (local ‚Äî ch·ªâ c·∫≠p nh·∫≠t giao di·ªán & flag)
            // ============================================================
            $(document).on('click', '.btn-set-cover', function () {
                const $this = $(this);
                const $container = $this.closest('.upload-container');

                // Ch·ªâ cho ph√©p 1 ·∫£nh b√¨a m·ªói m√†u
                $container.find('.btn-set-cover').removeClass('active').attr('title', 'ƒê·∫∑t l√†m ·∫£nh ch√≠nh');
                $container.find('.preview-item').removeAttr('data-cover');

                // K√≠ch ho·∫°t ·∫£nh n√†y l√†m b√¨a
                $this.addClass('active').attr('title', '·∫¢nh ch√≠nh');
                $this.closest('.preview-item').attr('data-cover', 'true');

                console.log('‚≠ê ƒê√£ ch·ªçn ·∫£nh b√¨a local.');
            });

            // ============================================================
            // ‚ùå 3Ô∏è‚É£ X√≥a ·∫£nh preview local
            // ============================================================
            $(document).on('click', '.btn-remove-image', function (e) {
                e.stopPropagation();
                const $container = $(this).closest('.upload-container');
                $(this).closest('.preview-item').remove();

                if ($container.find('.preview-item').length === 0) {
                    $container.find('.upload-placeholder').show();
                    $container.find('input[type="file"]').val('');
                }
            });


            // ‚ùå X√≥a ·∫£nh
            // $(document).on('click', '.btn-remove-image', function (e) {
            //     e.stopPropagation();
            //     const $container = $(this).closest('.upload-container');
            //     $(this).closest('.preview-item').remove();
            //
            //     if ($container.find('.preview-item').length === 0) {
            //         $container.find('.upload-placeholder').show();
            //         $container.find('input[type="file"]').val('');
            //     }
            // });

            // ‚≠êÔ∏è ƒê·∫∑t ·∫£nh cover (·∫£nh ch√≠nh)
            // $(document).on('click', '.btn-set-cover', function () {
            //     const $this = $(this);
            //     const $container = $this.closest('.upload-container');
            //     $container.find('.btn-set-cover').removeClass('active').attr('title', 'ƒê·∫∑t l√†m ·∫£nh ch√≠nh');
            //     $this.addClass('active').attr('title', '·∫¢nh ch√≠nh');
            // });
            // $(document).on('click', '.btn-set-cover', async function () {
            //     const $this = $(this);
            //     const $container = $this.closest('.upload-container');
            //     const $img = $this.siblings('img');
            //     const imgSrc = $img.attr('src');
            //     const mauSacId = +($container.closest('tr').data('mau-id') || 0);
            //
            //     // C·∫≠p nh·∫≠t UI
            //     $container.find('.btn-set-cover').removeClass('active').attr('title', 'ƒê·∫∑t l√†m ·∫£nh ch√≠nh');
            //     $this.addClass('active').attr('title', '·∫¢nh ch√≠nh');
            //
            //     // N·∫øu c√≥ finalSanPhamId => g·ªçi API c·∫≠p nh·∫≠t
            //     if (finalSanPhamId) {
            //         try {
            //             // await axios.put('/api/san-pham-mau-anh/${imgId}/cover', {
            //             //     sanPhamId: finalSanPhamId,
            //             //     mauSacId: mauSacId,
            //             //     duongDan: imgSrc
            //             // });
            //             await axios.put(`/api/san-pham-mau-anh/${imgId}/cover`);
            //             console.log('‚≠êÔ∏è C·∫≠p nh·∫≠t ·∫£nh b√¨a th√†nh c√¥ng!');
            //         } catch (err) {
            //             console.error('‚ùå L·ªói c·∫≠p nh·∫≠t ·∫£nh b√¨a:', err);
            //         }
            //     }
            // });
            $(document).on('click', '.btn-set-cover', async function () {
                const $btn = $(this);
                const $container = $btn.closest('.upload-container');
                const imgId = $btn.data('id'); // ch·ªâ c√≥ n·∫øu ·∫£nh ƒë√£ t·ªìn t·∫°i tr√™n server

                // Lu√¥n ƒë·∫£m b·∫£o trong 1 container ch·ªâ c√≥ 1 ·∫£nh b√¨a
                $container.find('.btn-set-cover').removeClass('active').attr('title', 'ƒê·∫∑t l√†m ·∫£nh ch√≠nh');
                $container.find('.preview-item').removeAttr('data-cover');
                $btn.addClass('active').attr('title', '·∫¢nh ch√≠nh');
                $btn.closest('.preview-item').attr('data-cover', 'true');

                // N·∫øu l√† ·∫£nh SERVER (ƒë√£ c√≥ id) -> c·∫≠p nh·∫≠t cover ngay
                if (imgId) {
                    try {
                        await axios.put(`/api/san-pham-mau-anh/${imgId}/cover`);
                        console.log('‚≠ê ƒê√£ c·∫≠p nh·∫≠t ·∫£nh b√¨a (server).');
                    } catch (err) {
                        console.error('‚ùå L·ªói c·∫≠p nh·∫≠t ·∫£nh b√¨a:', err);
                        alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ·∫£nh b√¨a!');
                    }
                }
                // N·∫øu l√† ·∫£nh LOCAL (ch∆∞a c√≥ id) -> KH√îNG g·ªçi API ·ªü ƒë√¢y
                // -> flag data-cover s·∫Ω ƒë∆∞·ª£c g·ª≠i k√®m khi upload l√∫c b·∫•m L∆∞u
            });




            // ============================================================
            // üü£ UPLOAD T·∫§T C·∫¢ ·∫¢NH SAU KHI L∆ØU S·∫¢N PH·∫®M
            // ============================================================
            // async function uploadAllImagesAfterSave(sanPhamId) {
            //     const uploadPromises = [];
            //
            //     $('.upload-container').each(function () {
            //         const $container = $(this);
            //         const mauSacId = +($container.closest('tr').data('mau-id') || 0);
            //         const $input = $container.find('input[type="file"]')[0];
            //         const files = $input?.files || [];
            //         const $preview = $container.find('.preview-container');
            //
            //         $preview.empty();
            //
            //         for (const file of files) {
            //             const formData = new FormData();
            //             formData.append("sanPhamId", sanPhamId);
            //             formData.append("mauSacId", mauSacId);
            //             formData.append("file", file);
            //             formData.append("laAnhBia", false);
            //             formData.append("thuTu", $preview.children().length);
            //
            //             const promise = axios.post("/api/san-pham-mau-anh/upload", formData, {
            //                 headers: { "Content-Type": "multipart/form-data" }
            //             })
            //                 .then(res => {
            //                     const imgId = res.data.id;
            //                     const imgUrl = res.data.duongDan;
            //
            //                     // ‚úÖ Append ·∫£nh m·ªõi k√®m data-id
            //                     $preview.append(`
            //             <div class="preview-item" draggable="true">
            //                 <img src="${imgUrl}" alt="">
            //                 <button type="button"
            //                         class="btn-set-cover"
            //                         data-id="${imgId}"
            //                         title="ƒê·∫∑t l√†m ·∫£nh ch√≠nh">
            //                     <i class="fas fa-star"></i>
            //                 </button>
            //                 <button type="button"
            //                         class="btn-remove-image"
            //                         data-id="${imgId}">
            //                     <i class="fas fa-times"></i>
            //                 </button>
            //             </div>
            //         `);
            //
            //                     $container.find('.upload-placeholder').hide();
            //                 })
            //                 .catch(err => {
            //                     console.error('‚ùå L·ªói upload ·∫£nh:', err);
            //                 });
            //
            //             uploadPromises.push(promise);
            //         }
            //     });
            //
            //     await Promise.all(uploadPromises);
            //     console.log('üì¶ ƒê√£ upload to√†n b·ªô ·∫£nh th·∫≠t sau khi l∆∞u s·∫£n ph·∫©m.');
            // }
            // ============================================================
            // üíæ 4Ô∏è‚É£ Khi b·∫•m L∆∞u s·∫£n ph·∫©m ‚Üí upload th·∫≠t to√†n b·ªô ·∫£nh local
            // ============================================================
            async function uploadAllImagesAfterSave(sanPhamId) {
                const jobs = [];

                $('.upload-container').each(function () {
                    const $container = $(this);
                    const mauSacId = +($container.closest('tr').data('mau-id') || 0);
                    const $items = $container.find('.preview-item');

                    // L·∫•y danh s√°ch file local ƒë√£ l∆∞u ·ªü b∆∞·ªõc ch·ªçn file
                    const filesArr = $container.data('files') || [];

                    $items.each(function () {
                        const $item = $(this);
                        const btn = $item.find('.btn-set-cover');
                        const serverId = btn.data('id');                 // t·ªìn t·∫°i n·∫øu ·∫£nh ƒë√£ c√≥ tr√™n server
                        const isCover = $item.attr('data-cover') === 'true';

                        if (serverId) {
                            // ·∫¢nh ƒë√£ ·ªü server: n·∫øu ƒë∆∞·ª£c ch·ªçn b√¨a ·ªü UI -> g·ªçi API cover
                            if (isCover) {
                                const p = axios.put(`/api/san-pham-mau-anh/${serverId}/cover`)
                                    .then(() => console.log('‚≠ê ƒê√£ set cover cho ·∫£nh server:', serverId))
                                    .catch(err => console.error('‚ùå L·ªói set cover server:', err));
                                jobs.push(p);
                            }
                        } else {
                            // ·∫¢nh local: t√¨m file t∆∞∆°ng ·ª©ng b·∫±ng data-file-index
                            const idx = +($item.data('file-index'));
                            const file = filesArr[idx];
                            if (!file) return;

                            const formData = new FormData();
                            formData.append('sanPhamId', sanPhamId);
                            formData.append('mauSacId', mauSacId);
                            formData.append('file', file);
                            formData.append('laAnhBia', isCover);          // ‚úÖ g·ª≠i flag cover theo UI
                            formData.append('thuTu', idx);

                            const p = axios.post('/api/san-pham-mau-anh/upload', formData, {
                                headers: { 'Content-Type': 'multipart/form-data' }
                            }).then(res => {
                                console.log(`üì§ Uploaded ${isCover ? '[‚≠ê b√¨a]' : ''}:`, res.data);
                                // Optionally: c·∫≠p nh·∫≠t DOM th√†nh b·∫£n server (g·∫Øn data-id ƒë·ªÉ v·ªÅ sau c√≥ th·ªÉ set cover tr·ª±c ti·∫øp)
                                btn.attr('data-id', res.data.id);
                            }).catch(err => console.error('‚ùå L·ªói upload ·∫£nh local:', err));

                            jobs.push(p);
                        }
                    });
                });

                await Promise.all(jobs);
                console.log('‚úÖ Ho√†n th√†nh upload + set cover theo l·ª±a ch·ªçn UI.');
            }


            // async function uploadAllImagesAfterSave(sanPhamId) {
            //     const uploadPromises = [];
            //     $('.upload-container').each(function () {
            //         const $container = $(this);
            //         const mauSacId = +($container.closest('tr').data('mau-id') || 0);
            //         const $input = $container.find('input[type="file"]')[0];
            //         const files = $input?.files || [];
            //         const $preview = $container.find('.preview-container');
            //
            //         for (const file of files) {
            //             const formData = new FormData();
            //             formData.append("sanPhamId", sanPhamId);
            //             formData.append("mauSacId", mauSacId);
            //             formData.append("file", file);
            //             formData.append("laAnhBia", false);
            //             formData.append("thuTu", $preview.children().length);
            //
            //             const promise = axios.post("/api/san-pham-mau-anh/upload", formData, {
            //                 headers: { "Content-Type": "multipart/form-data" }
            //             }).then(res => {
            //                 const imgUrl = res.data.duongDan;
            //                 $preview.empty().append(`
            //         <div class="preview-item">
            //             <img src="${imgUrl}" alt="">
            //             <button type="button" class="btn-set-cover active" title="·∫¢nh ch√≠nh"><i class="fas fa-star"></i></button>
            //             <button type="button" class="btn-remove-image"><i class="fas fa-times"></i></button>
            //         </div>
            //     `);
            //             }).catch(err => {
            //                 console.error('‚ùå L·ªói upload ·∫£nh:', err);
            //             });
            //
            //             uploadPromises.push(promise);
            //         }
            //     });
            //
            //     await Promise.all(uploadPromises);
            //     console.log('üì¶ ƒê√£ upload to√†n b·ªô ·∫£nh th·∫≠t sau khi l∆∞u s·∫£n ph·∫©m.');
            // }

            // ============================================================
            // üîÑ K√âO‚ÄìTH·∫¢ REORDER ·∫¢NH (DRAG & DROP)
            // ============================================================
            let draggedImg = null;

            $(document).on('dragstart', '.preview-item', function (e) {
                draggedImg = this;
                $(this).addClass('dragging');
                e.originalEvent.dataTransfer.effectAllowed = 'move';
            });

            $(document).on('dragend', '.preview-item', function () {
                $(this).removeClass('dragging');
                draggedImg = null;
            });

            $(document).on('dragover', '.preview-container', function (e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(this, e.clientX);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    this.appendChild(draggable);
                } else {
                    this.insertBefore(draggable, afterElement);
                }
            });

            function getDragAfterElement(container, x) {
                const elements = [...container.querySelectorAll('.preview-item:not(.dragging)')];
                return elements.reduce(
                    (closest, child) => {
                        const box = child.getBoundingClientRect();
                        const offset = x - box.left - box.width / 2;
                        if (offset < 0 && offset > closest.offset) {
                            return { offset: offset, element: child };
                        } else {
                            return closest;
                        }
                    },
                    { offset: Number.NEGATIVE_INFINITY }
                ).element;
            }

            // ============================================================
            // üåê N√öT ‚ÄúT·∫¢I T·ª™ URL‚Äù (d√°n link ·∫£nh tr·ª±c ti·∫øp)
            // ============================================================
            $(document).on('dblclick', '.upload-container', async function (e) {
                const $container = $(this);
                const mauSacId = +($container.closest('tr').data('mau-id') || 0);

                const url = prompt('üîó Nh·∫≠p URL ·∫£nh ƒë·ªÉ t·∫£i v·ªÅ:');
                if (!url) return;

                try {
                    // 1Ô∏è‚É£ T·∫£i blob t·ª´ URL
                    const res = await fetch(url);
                    const blob = await res.blob();

                    // 2Ô∏è‚É£ G·ª≠i blob n√†y l√™n server
                    const formData = new FormData();
                    formData.append("sanPhamId", finalSanPhamId);
                    formData.append("mauSacId", mauSacId);
                    formData.append("file", blob, "from-url.jpg");
                    formData.append("laAnhBia", false);
                    formData.append("thuTu", $container.find('.preview-item').length);

                    const uploadRes = await axios.post("/api/san-pham-mau-anh/upload", formData, {
                        headers: { "Content-Type": "multipart/form-data" }
                    });

                    const imgId = uploadRes.data.id;
                    const imgUrl = uploadRes.data.duongDan;

                    // 3Ô∏è‚É£ Render preview c√≥ data-id
                    $container.find('.preview-container').append(`
            <div class="preview-item" draggable="true">
                <img src="${imgUrl}" alt="">
                <button type="button" class="btn-set-cover" data-id="${imgId}" title="ƒê·∫∑t l√†m ·∫£nh ch√≠nh">
                    <i class="fas fa-star"></i>
                </button>
                <button type="button" class="btn-remove-image" data-id="${imgId}">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `);
                    $container.find('.upload-placeholder').hide();

                    console.log('‚úÖ ƒê√£ t·∫£i v√† l∆∞u ·∫£nh URL v√†o SQL:', imgUrl);
                } catch (err) {
                    alert('‚ùå Kh√¥ng th·ªÉ t·∫£i ·∫£nh t·ª´ URL n√†y!');
                    console.error(err);
                }
            });

            // $(document).on('dblclick', '.upload-container', async function () {
            //     const url = prompt('üîó Nh·∫≠p URL ·∫£nh ƒë·ªÉ t·∫£i v·ªÅ:');
            //     if (!url) return;
            //     try {
            //         const res = await fetch(url);
            //         const blob = await res.blob();
            //         const reader = new FileReader();
            //         reader.onload = ev => {
            //             const imgHtml = `
            //     <div class="preview-item" draggable="true">
            //         <img src="${ev.target.result}" alt="">
            //         <div class="img-tools">
            //             <button type="button" class="btn-set-cover" title="ƒê·∫∑t l√†m ·∫£nh ch√≠nh"><i class="fas fa-star"></i></button>
            //             <button type="button" class="btn-remove-image"><i class="fas fa-times"></i></button>
            //         </div>
            //     </div>`;
            //             $(e.currentTarget).find('.preview-container').append(imgHtml);
            //         };
            //         reader.readAsDataURL(blob);
            //     } catch (err) {
            //         alert('‚ùå Kh√¥ng th·ªÉ t·∫£i ·∫£nh t·ª´ URL n√†y!');
            //         console.error(err);
            //     }
            // });




            // ============================================================
            // üü¶ 12Ô∏è‚É£ K√âO NGANG TRONG KHUNG UPLOAD ·∫¢NH
            // ============================================================
            $(document).on('mousedown', '.upload-container', function (e) {
                if ($(e.target).closest('.btn-remove-image').length) return;

                const $this = $(this);
                const startX = e.pageX - $this.offset().left;
                const scrollLeft = $this.scrollLeft();
                let isDown = true;

                $this.addClass('dragging');

                $(document).on('mousemove.dragscroll', function (e2) {
                    if (!isDown) return;
                    e2.preventDefault();
                    const x = e2.pageX - $this.offset().left;
                    const walk = (x - startX) * 1.5;
                    $this.scrollLeft(scrollLeft - walk);
                });

                $(document).on('mouseup.dragscroll mouseleave.dragscroll', function () {
                    isDown = false;
                    $(document).off('.dragscroll');
                    $this.removeClass('dragging');
                });
            });

            $(document).on('dragstart', '.upload-container img', function (e) {
                e.preventDefault();
                return false;
            });

            // ============================================================
            // üü¢ Reload ·∫£nh t·ª´ API (n·∫øu mu·ªën hi·ªÉn th·ªã l·∫°i sau khi l∆∞u)
            // ============================================================
            async function reloadApiImagesForAllRows(sanPhamId) {
                $('#table-variants tr').each(async function () {
                    const $row = $(this);
                    const $container = $row.find('.upload-container');
                    if (!$container.length) return;

                    const mauSacId = Number($row.data('mau-id')) || null;
                    const params = mauSacId ? { params: { mauSacId } } : {};
                    const res = await axios.get(`/api/san-pham-mau-anh/by-san-pham/${sanPhamId}`, params);
                    const list = res.data || [];

                    const $preview = $container.find('.preview-container');
                    $preview.empty();

                    if (!list.length) {
                        $container.find('.upload-placeholder').show();
                        return;
                    }

                    $container.find('.upload-placeholder').hide();
                    list.forEach(img => {
                        $preview.append(`
  <div class="preview-item" draggable="true">
    <img src="${img.duongDan}" alt="">
    <button type="button" class="btn-set-cover ${img.laAnhBia ? 'active' : ''}"
            data-id="${img.id}"
            title="${img.laAnhBia ? '·∫¢nh ch√≠nh' : 'ƒê·∫∑t l√†m ·∫£nh ch√≠nh'}">
      <i class="fas fa-star"></i>
    </button>
    <button type="button" class="btn-remove-image" data-id="${img.id}">
      <i class="fas fa-times"></i>
    </button>
  </div>
`);
                    });
                });
            }




            // ============================================================
            // üü• 13Ô∏è‚É£ POPUP TH√äM M·ªöI M√ÄU S·∫ÆC (C√ì COLOR PICKER)
            // ============================================================
            let currentAttrType = null; // üîπ khai b√°o global

            // Khi m·ªü popup th√™m nhanh
            $(document).on('click', '.btn-add-icon', function (e) {
                e.preventDefault();

                const id = $(this).attr('id');
                const attr = id.replace('btn-add-', '');
                currentAttrType = attr;

                const labelMap = {
                    'thuongHieu': 'Th∆∞∆°ng hi·ªáu',
                    'danhMuc': 'Danh m·ª•c',
                    'chatLieu': 'Ch·∫•t li·ªáu',
                    'deGiay': 'ƒê·∫ø gi√†y',
                    'mauSac': 'M√†u s·∫Øc',
                    'kichCo': 'K√≠ch c·ª°'
                };

                // üßπ Reset popup tr∆∞·ªõc khi hi·ªÉn th·ªã
                $('#attrColorNameInput').val('');
                $('#attrStatusInput').val('').data('id', null);
                $('#colorPickerSection').hide();
                $('#colorInfoSection').hide();

                // üßπ Reset dropdown tr·∫°ng th√°i (b·ªè s√°ng)
                $('#attrStatusList .dropdown-item').removeClass('selected');
                $('#attrStatusList .dropdown-item i')
                    .removeClass('fa-check-square text-primary')
                    .addClass('fa-square');

                // üè∑Ô∏è ƒê·∫∑t ti√™u ƒë·ªÅ popup
                $('#quickModalTitle').text('Th√™m ' + (labelMap[attr] || 'Thu·ªôc t√≠nh m·ªõi'));

                // üñåÔ∏è N·∫øu l√† M√†u s·∫Øc
                if (attr === 'mauSac') {
                    $('#colorPickerSection').show();
                    $('#colorInfoSection').show();

                    $('#colorInfoSection label[for="attrColorNameInput"]').text('T√™n m√†u s·∫Øc:');
                    $('#attrColorNameInput').attr('placeholder', 'Nh·∫≠p t√™n m√†u s·∫Øc...');

                    const defaultColor = '#000000';
                    updateColorSelection(defaultColor);
                }
                // üß© N·∫øu l√† c√°c thu·ªôc t√≠nh kh√°c
                else {
                    $('#colorInfoSection').show();
                    $('#colorPickerSection').hide();

                    const tenLabel = 'T√™n ' + labelMap[attr].toLowerCase() + ':';
                    $('#colorInfoSection label[for="attrColorNameInput"]').text(tenLabel);
                    $('#attrColorNameInput').attr('placeholder', 'Nh·∫≠p ' + labelMap[attr].toLowerCase() + '...');
                }

                // üé¨ Hi·ªÉn th·ªã popup
                $('#quickAddModal').addClass('show').hide().fadeIn(150);
            });



            // ===============================
            // üé® B·∫¢NG CH·ªåN M√ÄU T√ôY CH·ªàNH
            // ===============================
            $(document).on('click', '#selectedColorBox', function(e) {
                e.stopPropagation();
                $('#customColorPalette').fadeToggle(120);
            });


            $(document).on('click', function(e) {
                if (!$(e.target).closest('#customColorPalette, #selectedColorBox').length) {
                    $('#customColorPalette').fadeOut(100);
                }
            });

            // üîπ Ch·ªçn m√†u t·ª´ √¥ b·∫£ng
            $(document).on('click', '.color-item', function() {
                const color = $(this).data('color').toUpperCase();
                updateColorSelection(color);
            });

            // üîπ Ch·ªçn m√†u t·ª± do t·ª´ input type=color
            $(document).on('input', '#colorFreePicker', function() {
                const color = $(this).val().toUpperCase();
                updateColorSelection(color);
            });

            // üîπ Nh·∫≠p th·ªß c√¥ng m√£ hex
            $(document).on('input', '#colorHexDisplay', function() {
                let val = $(this).val().trim();
                if (!val.startsWith('#')) val = '#' + val;
                if (/^#[0-9A-F]{6}$/i.test(val)) {
                    updateColorSelection(val.toUpperCase());
                }
            });

            // H√†m c·∫≠p nh·∫≠t to√†n b·ªô UI
            function updateColorSelection(color) {
                $('#selectedColorBox').css('background', color);
                $('#colorHexDisplay').val(color);
                $('#attrColorInput').val(color).trigger('input'); // üîπ c·∫≠p nh·∫≠t t√™n m√†u ti·∫øng Vi·ªát
            }


            // ===============================
            // üü™ MAP M√É M√ÄU ‚Üí T√äN TI·∫æNG VI·ªÜT
            // ===============================

            let colorNameMap = {};

            async function loadColorMap() {
                try {
                    const res = await axios.get('/data/color-name-map.json');
                    colorNameMap = res.data;
                    console.log('üé® ƒê√£ load b·∫£ng m√†u:', Object.keys(colorNameMap).length, 'm√†u');
                } catch (err) {
                    console.error('‚ùå L·ªói load color-name-map.json:', err);
                }
            }

            $(document).on('input', '#attrColorInput', function() {
                const colorValue = $(this).val().toUpperCase();
                $('#colorCodeDisplay').text(colorValue);

                // üîπ ∆Øu ti√™n t√™n ch√≠nh x√°c trong map
                let colorName = colorNameMap[colorValue];

                // üîπ N·∫øu kh√¥ng c√≥, ∆∞·ªõc l∆∞·ª£ng m√†u g·∫ßn nh·∫•t
                if (!colorName) {
                    const nearest = findNearestColorName(colorValue, colorNameMap);
                    colorName = nearest.name + ' (‚âà ' + nearest.hex + ')';
                }

                $('#colorNameDisplay').text(colorName);
            });

            // ===============================
            // üé® H√ÄM H·ªñ TR·ª¢ X·ª¨ L√ù M√ÄU
            // ===============================

            // Chuy·ªÉn m√£ HEX ‚Üí {r,g,b}
            function hexToRgb(hex) {
                const cleanHex = hex.replace('#', '');
                const bigint = parseInt(cleanHex, 16);
                return {
                    r: (bigint >> 16) & 255,
                    g: (bigint >> 8) & 255,
                    b: bigint & 255
                };
            }

            // T√≠nh kho·∫£ng c√°ch gi·ªØa 2 m√†u RGB
            function colorDistance(c1, c2) {
                const dr = c1.r - c2.r;
                const dg = c1.g - c2.g;
                const db = c1.b - c2.b;
                return Math.sqrt(dr * dr + dg * dg + db * db);
            }

            // T√¨m t√™n m√†u g·∫ßn nh·∫•t trong b·∫£ng JSON
            function findNearestColorName(hexInput, map) {
                if (!map || Object.keys(map).length === 0) return 'Kh√¥ng x√°c ƒë·ªãnh';

                const inputRgb = hexToRgb(hexInput);
                let minDist = Infinity;
                let nearestName = 'Kh√¥ng x√°c ƒë·ªãnh';
                let nearestHex = null;

                for (const [hex, name] of Object.entries(map)) {
                    const rgb = hexToRgb(hex);
                    const dist = colorDistance(inputRgb, rgb);
                    if (dist < minDist) {
                        minDist = dist;
                        nearestName = name;
                        nearestHex = hex;
                    }
                }

                return { name: nearestName, hex: nearestHex, distance: minDist.toFixed(2) };
            }

            // ============================================================
            // üü¢ 15Ô∏è‚É£ X·ª¨ L√ù N√öT "L∆ØU S·∫¢N PH·∫®M" (C√ì GI·ªöI T√çNH)
            // ============================================================
            // ============================================================
            // üîπ H√ÄM CHU·∫®N H√ìA T√äN S·∫¢N PH·∫®M TR∆Ø·ªöC KHI D√ôNG TRONG MA_SPCT
            // ============================================================
            function normalizeName(name) {
                return name
                    .trim()                       // b·ªè kho·∫£ng tr·∫Øng ƒë·∫ßu-cu·ªëi
                    .replace(/\s+/g, ' ')          // g·ªôp nhi·ªÅu kho·∫£ng tr·∫Øng th√†nh 1
                    .replace(/[^\p{L}\p{N}\s]/gu, '') // lo·∫°i b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát (gi·ªØ ch·ªØ & s·ªë)
                    .replace(/\s+/g, '-')          // ƒë·ªïi kho·∫£ng tr·∫Øng c√≤n l·∫°i th√†nh d·∫•u g·∫°ch n·ªëi
                    .toUpperCase();                // vi·∫øt hoa cho ƒë·ªìng nh·∫•t
            }

            // === N√öT L∆ØU S·∫¢N PH·∫®M ===
            $(document).on('click', '#btn-save-product', async function () {
                try {
                    // --- L·∫•y th√¥ng tin c∆° b·∫£n ---
                    const tenSanPham = $('#tenSanPhamInput').val().trim();
                    const moTa = $('#moTa').val().trim();
                    const trangThai = $('#trangThaiInput').data('id')?.[0] || 1;

                    // --- L·∫•y danh s√°ch ID t·ª´ c√°c dropdown ---
                    const thuongHieuIds = $('#thuongHieuInput').data('ids') || [];
                    const danhMucIds = $('#danhMucInput').data('ids') || [];
                    const chatLieuIds = $('#chatLieuInput').data('ids') || [];
                    const deGiayIds = $('#deGiayInput').data('ids') || [];
                    const gioiTinhIds = $('#gioiTinhInput').data('ids') || [];

                    // --- Ki·ªÉm tra ƒë·∫ßu v√†o ---
                    if (!tenSanPham) {
                        alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m!');
                        return;
                    }

                    const validBrand  = validateRequiredInput('#thuongHieuInput', 'Vui l√≤ng ch·ªçn th∆∞∆°ng hi·ªáu!');
                    const validCate   = validateRequiredInput('#danhMucInput', 'Vui l√≤ng ch·ªçn danh m·ª•c!');
                    const validChat   = validateRequiredInput('#chatLieuInput', 'Vui l√≤ng ch·ªçn ch·∫•t li·ªáu!');
                    const validDeGiay = validateRequiredInput('#deGiayInput', 'Vui l√≤ng ch·ªçn ƒë·∫ø gi√†y!');

                    if (!validBrand || !validCate || !validChat || !validDeGiay) {
                        alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc!');
                        return;
                    }

                    // N·∫øu c√≥ nhi·ªÅu h∆°n 1 ph·∫ßn t·ª≠ (tr√°nh l·ªói backend l·∫•y [0])
                    if (thuongHieuIds.length > 1 || danhMucIds.length > 1 || chatLieuIds.length > 1 || deGiayIds.length > 1) {
                        alert('‚ö†Ô∏è Ch·ªâ ƒë∆∞·ª£c ch·ªçn 1 m·ª•c cho m·ªói lo·∫°i (Th∆∞∆°ng hi·ªáu, Danh m·ª•c, Ch·∫•t li·ªáu, ƒê·∫ø gi√†y)!');
                        return;
                    }


                    // --- T·∫°o danh s√°ch bi·∫øn th·ªÉ SPCT ---
                    const spctList = [];
                    $('#table-variants tr[data-mau-id]').each(function () {
                        const $row = $(this);
                        // üîπ L·∫•y ID tr·ª±c ti·∫øp t·ª´ data-* (·ªïn ƒë·ªãnh, kh√¥ng ph·ª• thu·ªôc text)
                        const mauSacId = +$row.data('mau-id');
                        const kichCoId = +$row.data('size-id');

                        // üîπ L·∫•y gi√° tr·ªã trong c√°c input
                        const soLuongTon = parseInt($row.find('.soLuongInput').val()) || 0;
                        const giaNhap = parseFloat($row.find('.giaNhapInput').val()) || 0;
                        const giaBan = parseFloat($row.find('.giaBanInput').val()) || 0;

                        // üîπ C√≥ th·ªÉ th√™m tr·∫°ng th√°i t·ª´ng d√≤ng n·∫øu c√≥ dropdown
                        const trangThai = $row.find('.trangThaiSelect').val() || 1;

                        // üîπ Chu·∫©n h√≥a t√™n SP ƒë·ªÉ sinh m√£ ·ªïn ƒë·ªãnh
                        // const normalizedName = normalizeName(tenSanPham);
                        // üîπ Sinh m√£ SPCT (n·∫øu c·∫ßn ‚Äî c√≥ th·ªÉ gi·ªØ nguy√™n nh∆∞ c≈©)
                        // const maSpct = `${maSanPham}-${normalizedName}-M${mauSacId}-S${kichCoId}`;


                        // ‚úÖ ƒê∆∞a v√†o danh s√°ch g·ª≠i backend
                        spctList.push({
                            mauSacId,
                            kichCoId,
                            soLuongTon,
                            giaNhap,
                            giaBan,
                            trangThai
                        });
                    });


                    // --- N·∫øu s·∫£n ph·∫©m ch∆∞a c√≥ ID => t·∫°o m·ªõi tr∆∞·ªõc ---
                    if (!finalSanPhamId) finalSanPhamId = sanPhamId;

                    if (finalSanPhamId === null) {
                        console.log('üÜï Ch∆∞a c√≥ ID, t·∫°o m·ªõi s·∫£n ph·∫©m...');
                        const sanPhamData = {
                            tenSanPham,
                            moTa,
                            trangThai,
                            thuongHieuId: thuongHieuIds[0] || null,
                            danhMucId: danhMucIds[0] || null,
                            chatLieuId: chatLieuIds[0] || null,
                            deGiayId: deGiayIds[0] || null,
                            gioiTinh: gioiTinhIds[0] || 2
                        };
                        const createRes = await axios.post('/api/san-pham/them-san-pham', sanPhamData);
                        finalSanPhamId = createRes.data?.id;
                        sanPhamId = finalSanPhamId;
                        if (!finalSanPhamId) {
                            alert('‚ùå Kh√¥ng th·ªÉ t·∫°o m·ªõi s·∫£n ph·∫©m!');
                            return;
                        }
                        console.log('‚úÖ ƒê√£ t·∫°o s·∫£n ph·∫©m ID =', finalSanPhamId);
                    }

                    // --- G·∫Øn ID cho t·ª´ng SPCT ---
                    spctList.forEach(spct => spct.sanPhamId = finalSanPhamId);

                    // --- G·ª≠i danh s√°ch SPCT ---
                    const bulkRes = await axios.post('/api/san-pham-chi-tiet/bulk', spctList);
                    if (bulkRes.status === 200 || bulkRes.data?.status === 'success') {
                        alert('‚úÖ L∆∞u s·∫£n ph·∫©m th√†nh c√¥ng!');

                        // üü¢ 1Ô∏è‚É£ Upload to√†n b·ªô ·∫£nh sau khi ƒë√£ c√≥ ID s·∫£n ph·∫©m
                        await uploadAllImagesAfterSave(finalSanPhamId);

                        // üü¢ 2Ô∏è‚É£ Load l·∫°i ·∫£nh t·ª´ API ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªÉn th·ªã ƒë√∫ng d·ªØ li·ªáu trong SQL
                        await reloadApiImagesForAllRows(finalSanPhamId);

                    }
                    else {
                        alert('‚ùå L·ªói khi l∆∞u s·∫£n ph·∫©m chi ti·∫øt!');
                        console.error(bulkRes.data);
                    }
                } catch (error) {
                    console.error('‚ùå L·ªói khi l∆∞u s·∫£n ph·∫©m:', error);
                    alert('L∆∞u s·∫£n ph·∫©m th·∫•t b·∫°i, vui l√≤ng ki·ªÉm tra Console.');
                }
            });





        </script>

    </div>
</body>

</html>